```
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¨±ä¹åœˆæ•›è´¢ç³»ç»Ÿå˜é‡çŠ¶æ€æ -å¤œå®µå®µå¤œ</title>
    <style>
        /* [åŸºæœ¬é‡ç½®ä¸å­—ä½“] */
        :root {
            --main-bg: #221835;
            --accent-gold: #EFD586;
            --text-color-light: #f0e6d2;
            --text-color-dark: #221835;
            --text-color-primary: #EAEAEA;
            --container-bg: rgba(28, 20, 48, 0.9);
            --font-main: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            --shadow-color: rgba(239, 213, 134, 0.3);
            --border-glow: 0 0 8px var(--accent-gold), 0 0 16px var(--shadow-color);
        }

        body {
            background-color: transparent;
            color: var(--text-color-primary);
            font-family: var(--font-main);
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* æ”¹ä¸ºé¡¶éƒ¨å¯¹é½ï¼Œæ¶ˆé™¤å‚ç›´å±…ä¸­å¸¦æ¥çš„é—´è· */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* [ä¸»å®¹å™¨] */
        .status-container {
            width: 100%;
            max-width: 750px;
            /* ç§»é™¤ aspect-ratioï¼Œè®©é«˜åº¦ç”±å†…å®¹å†³å®š */
            height: auto; /* é«˜åº¦è‡ªé€‚åº” */
            background: var(--main-bg);
            border: 1px solid var(--accent-gold);
            border-radius: 24px;
            /* box-shadow: var(--border-glow); -- Removed as requested */
            padding: 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
            /* æ ¸å¿ƒï¼šä¸ºé«˜åº¦å˜åŒ–æ·»åŠ å¹³æ»‘è¿‡æ¸¡åŠ¨ç”» */
            transition: height 0.4s ease-in-out;
        }

        /* [æŠ˜å æŒ‰é’®] */
        #collapse-toggle-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            width: 30px;
            height: 30px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #collapse-toggle-btn .icon {
            width: 24px;
            height: 24px;
            fill: var(--accent-gold);
            transition: transform 0.3s ease-in-out;
        }

        /* [æŠ˜å å†…å®¹] */
        .collapsible-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
            transition: opacity 0.3s ease-in-out, max-height 0.4s ease-in-out;
            max-height: 1000px; /* è¶³å¤Ÿå¤§çš„åˆå§‹é«˜åº¦ */
            opacity: 1;
        }

        /* [æŠ˜å åçš„çŠ¶æ€] */
        .status-container.collapsed {
            /* æŠ˜å åé«˜åº¦ç”±å†…å®¹ï¼ˆæ ‡é¢˜æ ï¼‰å†³å®šï¼Œä¸å†éœ€è¦ aspect-ratio */
            height: auto; 
        }
        .status-container.collapsed .main-title-bar {
            margin-bottom: 0; /* ç§»é™¤åº•éƒ¨è¾¹è·ä»¥åœ¨æŠ˜å æ—¶å®ç°å‚ç›´å±…ä¸­ */
        }
        .status-container.collapsed .collapsible-content {
            max-height: 0;
            opacity: 0;
            flex-grow: 0;
            min-height: 0;
        }
        .status-container.collapsed #collapse-toggle-btn .icon {
            transform: rotate(180deg);
        }

        /* [é¡µé¢åˆ‡æ¢ä¸å†…å®¹] */
        .content-page {
            display: none; /* é»˜è®¤éšè—æ‰€æœ‰é¡µé¢ */
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        .content-page.active {
            display: flex; /* åªæ˜¾ç¤ºæ¿€æ´»çš„é¡µé¢ */
        }
        
        /* [é€šç”¨æ»šåŠ¨å®¹å™¨æ ·å¼ - é™¤åœ°å›¾é¡µé¢å¤–] */
        .scrollable-page-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-right: -10px;
        }

        /* é€šç”¨æ»šåŠ¨æ¡æ ·å¼ */
        .scrollable-page-content::-webkit-scrollbar {
            width: 6px;
        }
        .scrollable-page-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        .scrollable-page-content::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 3px;
        }
        .scrollable-page-content::-webkit-scrollbar-thumb:hover {
            background: #fff2c8;
        }
        
        /* [å±æ€§é¡µé¢ç‰¹å®šæ ·å¼] */
        .attributes-container {
            display: flex;
            gap: 20px;
            flex-grow: 1;
        }

        .attribute-section {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        .attribute-section-title {
            color: var(--accent-gold);
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
            border-bottom: 2px solid var(--accent-gold);
            padding-bottom: 8px;
            flex-shrink: 0;
        }

        .attribute-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-right: -10px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .attribute-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(0,0,0,0.2);
            padding: 8px 12px;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .attribute-item .icon {
            width: 24px;
            height: 24px;
            fill: var(--accent-gold);
            flex-shrink: 0;
        }

        .attribute-label {
            width: 70px;
            color: var(--text-color-light);
            flex-shrink: 0;
        }

        .progress-bar-container {
            flex-grow: 1;
            height: 12px;
            background-color: rgba(0,0,0,0.4);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, var(--accent-gold) 0%, #f9eeb9 100%);
            border-radius: 6px;
            transition: width 0.5s ease-in-out;
        }

        /* é£è¯„ç‰¹æ®Šè¿›åº¦æ¡æ ·å¼ */
        .progress-bar.reputation {
            background: linear-gradient(90deg, #ff6b6b 0%, var(--accent-gold) 50%, #51cf66 100%);
        }

        .attribute-value {
            width: 35px;
            text-align: right;
            font-weight: bold;
            color: var(--text-color-light);
            flex-shrink: 0;
        }

        /* é£è¯„æ•°å€¼ç‰¹æ®Šé¢œè‰² */
        .attribute-value.reputation.negative {
            color: #ff6b6b;
        }

        .attribute-value.reputation.positive {
            color: #51cf66;
        }

        /* å±æ€§é¡µé¢æ»šåŠ¨æ¡æ ·å¼ */
        .attribute-list::-webkit-scrollbar {
            width: 6px;
        }
        .attribute-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        .attribute-list::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 3px;
        }
        .attribute-list::-webkit-scrollbar-thumb:hover {
            background: #fff2c8;
        }

        /* å“åº”å¼è®¾è®¡ï¼šçª„å±æ—¶æ”¹ä¸ºä¸Šä¸‹å¸ƒå±€ */
        @media (max-width: 768px) {
            .attributes-container {
                flex-direction: column;
                gap: 25px;
            }
            
            .attribute-section-title {
                font-size: 1.1em;
            }
        }

        /* [å½“å‰é€šå‘Šé¡µé¢ç‰¹å®šæ ·å¼] */
        .project-overview {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .project-header {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, rgba(239, 213, 134, 0.2), rgba(239, 213, 134, 0.1));
            border-radius: 12px;
            border: 1px solid var(--accent-gold);
        }

        .project-title {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--accent-gold);
            margin-bottom: 8px;
        }

        .project-rating {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 16px;
            font-weight: bold;
            font-size: 1em;
            letter-spacing: 1px;
            text-transform: uppercase;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        /* é¡¹ç›®è¯„çº§é¢œè‰² */
        .project-rating.s-plus {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
        }

        .project-rating.s {
            background: linear-gradient(45deg, #feca57, #ff9ff3);
            color: white;
        }

        .project-rating.a {
            background: linear-gradient(45deg, #48dbfb, #0abde3);
            color: white;
        }

        .project-rating.b {
            background: linear-gradient(45deg, #1dd1a1, #10ac84);
            color: white;
        }

        .project-rating.c {
            background: linear-gradient(45deg, #ffeaa7, #fdcb6e);
            color: #2d3436;
        }

        .project-rating.d {
            background: linear-gradient(45deg, #ddd, #b2bec3);
            color: #2d3436;
        }

        .project-rating.default {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
        }

        .project-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .project-detail-item {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(239, 213, 134, 0.3);
            transition: all 0.3s ease;
        }

        .project-detail-item:hover {
            border-color: var(--accent-gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 213, 134, 0.2);
        }

        .project-detail-label {
            font-weight: bold;
            color: var(--accent-gold);
            font-size: 1em;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .project-detail-label .icon {
            width: 16px;
            height: 16px;
            fill: var(--accent-gold);
        }

        .project-detail-value {
            color: var(--text-color-light);
            line-height: 1.4;
            font-size: 0.95em;
        }

        .project-description {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(239, 213, 134, 0.3);
            margin-bottom: 12px;
        }

        .project-flow {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(239, 213, 134, 0.3);
        }

        .project-flow-value {
            color: var(--text-color-light);
            line-height: 1.4;
            font-size: 0.95em;
        }

        .salary-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .salary-amount {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--accent-gold);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .project-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .project-title {
                font-size: 1.3em;
            }
            
            .project-header {
                padding: 12px;
            }
        }

        /* [é€‰é¡¹æ·éª°é¡µé¢ç‰¹å®šæ ·å¼] */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .option-item {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(239, 213, 134, 0.3);
            transition: all 0.3s ease;
        }

        .option-item:hover {
            border-color: var(--accent-gold);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 213, 134, 0.2);
            cursor: pointer;
        }

        .pure-dice-option {
            background: rgba(86, 65, 99, 0.3);
            border-color: rgba(86, 65, 99, 0.5);
        }

        .pure-dice-option:hover {
            border-color: #564163;
            box-shadow: 0 4px 12px rgba(86, 65, 99, 0.3);
        }

        .pure-dice-option .option-behavior {
            text-align: center;
            font-weight: bold;
            color: #eef0f1;
        }



        .option-behavior {
            color: var(--text-color-light);
            line-height: 1.5;
            margin-bottom: 12px;
            font-size: 0.95em;
        }

        .option-attributes {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 8px;
        }

        .attribute-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(239, 213, 134, 0.4);
            border-radius: 6px;
            font-size: 0.8em;
            color: var(--text-color-light);
            font-weight: 500;
            margin: 2px;
        }

        .attribute-value {
            background: rgba(239, 213, 134, 0.8);
            color: var(--text-color-dark);
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: bold;
            min-width: 16px;
            text-align: center;
            font-size: 0.9em;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .options-container {
                gap: 12px;
            }
            
            .option-item {
                padding: 12px;
            }
            
            .option-header {
                font-size: 1em;
            }
            
            .option-attributes {
                gap: 6px;
            }
            
            .attribute-tag {
                font-size: 0.8em;
                padding: 5px 10px;
            }
        }

        /* [æ·éª°ç³»ç»Ÿæ ·å¼] */
        .option-buttons {
            margin-top: 12px;
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: nowrap;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .action-btn {
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.8em;
            flex: 1;
            min-width: 60px;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-align: center;
        }

        .view-result-btn {
            background: #bbc4e4;
            color: #704f94;
        }

        .view-result-btn:hover {
            background: #c9d2eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(187, 196, 228, 0.3);
        }

        .direct-send-btn {
            background: #eef0f1;
            color: #c1a1ca;
        }

        .direct-send-btn:hover {
            background: #f5f6f7;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(238, 240, 241, 0.3);
        }

        .input-send-btn {
            background: #c1a1ca;
            color: #eef0f1;
        }

        .input-send-btn:hover {
            background: #d0b3d9;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(193, 161, 202, 0.3);
        }

        .dice-modal-content {
            max-width: 500px;
            width: 90%;
        }

        .dice-result-main {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            border: 1px solid rgba(239, 213, 134, 0.3);
        }

        .dice-outcome {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .dice-outcome.success { color: #4CAF50; }
        .dice-outcome.failure { color: #F44336; }
        .dice-outcome.critical-success { color: #FFD700; }
        .dice-outcome.critical-failure { color: #B71C1C; }

        .dice-description {
            font-size: 1.1em;
            color: var(--text-color-light);
            font-style: italic;
            line-height: 1.4;
        }

        .dice-details {
            background: rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .dice-detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .dice-detail-item:last-child {
            margin-bottom: 0;
        }

        .dice-label {
            color: var(--text-color-light);
            font-size: 0.95em;
        }

        .dice-value {
            color: var(--accent-gold);
            font-weight: bold;
            font-size: 1em;
        }

        .dice-formula {
            margin-top: 15px;
            text-align: center;
            font-size: 1.1em;
            color: var(--accent-gold);
            font-weight: bold;
            font-family: 'Courier New', monospace;
            background: rgba(239, 213, 134, 0.1);
            padding: 8px;
            border-radius: 5px;
        }

        .reroll-btn {
            width: 100%;
            background: linear-gradient(45deg, #FF6B6B, #FF8E8E);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .reroll-btn:hover {
            background: linear-gradient(45deg, #FF8E8E, #FF6B6B);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        /* è¾“å…¥å¼¹çª—æ ·å¼ */
        .input-modal-content {
            max-width: 600px;
            width: 90%;
        }

        .input-description {
            color: var(--text-color-light);
            margin-bottom: 15px;
            text-align: center;
        }

        .message-textarea {
            width: 100%;
            height: 120px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(239, 213, 134, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: var(--text-color-light);
            font-family: inherit;
            font-size: 0.95em;
            line-height: 1.4;
            resize: vertical;
            box-sizing: border-box;
        }

        .message-textarea:focus {
            outline: none;
            border-color: var(--accent-gold);
            box-shadow: 0 0 8px rgba(239, 213, 134, 0.3);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .cancel-btn {
            background: linear-gradient(45deg, #757575, #9E9E9E);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .cancel-btn:hover {
            background: linear-gradient(45deg, #9E9E9E, #757575);
            transform: translateY(-1px);
        }

        .send-btn {
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .send-btn:hover {
            background: linear-gradient(45deg, #66BB6A, #4CAF50);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .dice-modal-content {
                width: 95%;
            }
            
            .dice-outcome {
                font-size: 1.5em;
            }
            
            .dice-result-main {
                padding: 15px;
            }

            .input-modal-content {
                width: 95%;
            }

            .option-buttons {
                gap: 8px;
                max-width: 300px;
            }

            .action-btn {
                font-size: 0.75em;
                padding: 5px 8px;
                min-width: 45px;
                max-width: 75px;
            }
        }

        /* [ç³»ç»Ÿé¢æ¿é¡µé¢ç‰¹å®šæ ·å¼] */
        #page-panel .panel-list {
            flex-grow: 1;
            overflow-y: auto; /* å¦‚æœå†…å®¹æº¢å‡ºåˆ™æ˜¾ç¤ºæ»šåŠ¨æ¡ */
            padding-right: 10px;
            margin-right: -10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel-item {
            background-color: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-color-light);
            font-weight: bold;
        }
        
        .panel-header .icon {
            width: 28px;
            height: 28px;
            flex-shrink: 0;
            background-color: var(--accent-gold);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px;
            box-sizing: border-box;
        }

        .panel-header .icon svg {
             fill: var(--text-color-dark);
        }
        
        .panel-header .star-icon {
            width: 16px;
            height: 16px;
            fill: var(--accent-gold);
        }

        .panel-body {
            color: #c7c1d9; /* æµ…ç´«è‰²æ–‡æœ¬ */
            padding-left: 38px; /* ä¸æ ‡é¢˜å¯¹é½ */
            white-space: pre-line; /* æ–°å¢ï¼šè§£ææ¢è¡Œç¬¦ï¼Œä½¿ \n å’Œ <br> ç”Ÿæ•ˆ */
        }

        /* æ–°å¢ï¼šæ—¶é—´æ—¥æœŸæ ·å¼ */
        .datetime-info {
            display: flex;
            flex-direction: column; /* æ”¹ä¸ºçºµå‘æ’åˆ— */
            gap: 8px; /* è®¾ç½®é—´è· */
            width: 100%;
            margin-top: 10px; /* ä¸ä¸Šæ–¹å…ƒç´ ä¿æŒé—´è· */
        }

        .datetime-item {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--accent-gold);
            background-color: rgba(0,0,0,0.2);
            font-size: 0.8em; /* ç¡®ä¿å­—å·å‡å° */
            gap: 8px;
        }

        .datetime-item .icon {
            width: 18px;
            height: 18px;
            fill: var(--accent-gold);
        }

        .datetime-item span {
             color: var(--text-color-light);
        }
        
        .datetime-item#date-container {
            background-color: transparent; /* è¦†ç›–èƒŒæ™¯è‰² */
        }
        
        .datetime-item#date-container .icon,
        .datetime-item#date-container span {
            color: var(--text-color-light); /* è¦†ç›–æ–‡æœ¬é¢œè‰² */
            fill: var(--text-color-light); /* è¦†ç›–å›¾æ ‡é¢œè‰² */
        }


        /* [é¡¶éƒ¨æ ‡é¢˜æ ] */
        .main-title-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px 20px;
            border: 1px solid var(--accent-gold);
            border-radius: 10px; /* æ”¹ä¸ºåœ†è§’çŸ©å½¢ */
            background-color: rgba(0,0,0,0.2);
            color: var(--accent-gold);
            font-size: 1.1em;
            font-weight: bold;
            gap: 10px;
            margin-bottom: 15px; /* ç¨å¾®å‡å°‘é—´è· */
            flex-shrink: 0;
            width: 55%; /* è°ƒæ•´å®½åº¦ */
            align-self: center; /* æ°´å¹³å±…ä¸­ */
        }
        .main-title-bar .icon {
            width: 20px;
            height: 20px;
            fill: var(--accent-gold);
            animation: icon-glow-twinkle 2s infinite ease-in-out;
        }
        /* ä¸ºä¸¤ä¸ªå›¾æ ‡è®¾ç½®ä¸åŒçš„åŠ¨ç”»å»¶è¿Ÿï¼Œä½¿å…¶ä¸åŒæ­¥é—ªçƒ */
        .main-title-bar .icon:first-of-type {
            animation-delay: 0s;
        }
        .main-title-bar .icon:last-of-type {
            animation-delay: 0.4s;
        }

        /* [Tab å¯¼èˆª] */
        .status-tabs {
            display: flex;
            justify-content: flex-start; /* æ”¹ä¸ºflex-startä»¥æ”¯æŒæ»šåŠ¨ */
            margin-bottom: 20px;
            background-color: rgba(0,0,0,0.25);
            border-radius: 12px;
            padding: 5px;
            flex-shrink: 0;
            flex-wrap: nowrap; /* æ ¸å¿ƒï¼šé˜²æ­¢æ ‡ç­¾æ¢è¡Œ */
            overflow-x: auto; /* æ ¸å¿ƒï¼šå…è®¸æ°´å¹³æ»šåŠ¨ */
            gap: 1px; /* åœ¨æ ‡ç­¾ä¹‹é—´æ·»åŠ ä¸€äº›é—´è· */
        }
        /* ä¸ºæ»šåŠ¨æ¡æ·»åŠ ç®€å•æ ·å¼ï¼Œä½¿å…¶ä¸çªå…€ */
        .status-tabs::-webkit-scrollbar {
            height: 3px;
        }
        .status-tabs::-webkit-scrollbar-track {
            background: transparent;
        }
        .status-tabs::-webkit-scrollbar-thumb {
            background: rgba(239, 213, 134, 0.5);
            border-radius: 3px;
        }
        .tab {
            /* å…è®¸æ”¶ç¼©ï¼Œä½†ä¸å…è®¸æ— æ•…å¢é•¿ï¼ŒåŸºäºå†…å®¹è‡ªåŠ¨è°ƒæ•´åŸºç¡€å®½åº¦ */
            flex: 0 1 auto; 
            flex-shrink: 1; /* æ˜ç¡®å…è®¸æ”¶ç¼© */
            text-align: center;
            padding: 6px 8px; /* è°ƒæ•´å†…è¾¹è· */
            cursor: pointer;
            border-radius: 8px;
            color: var(--text-color-light);
            font-weight: normal;
            font-size: 0.9em; /* ç¨å¾®è°ƒå¤§åˆå§‹å­—å· */
            transition: background-color 0.3s, color 0.3s;
        }
        .tab.active {
            background-color: var(--accent-gold);
            color: var(--text-color-dark);
            font-weight: bold;
        }

        /* [å†…å®¹åŒºåŸŸ] */
        .status-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden;
            padding-bottom: 20px; /* ä¸ºç§»åŠ¨ç«¯æ·»åŠ åº•éƒ¨é—´è·ï¼Œé¿å…æœ€åå…ƒç´ è¢«æˆªæ–­ */
        }

        /* [è´¦æˆ·ä½™é¢] */
        /* é‡å†™ï¼šè´¦æˆ·ä½™é¢ç»„ä»¶ - ç®€åŒ–è®¾è®¡ */
        .account-balance-section {
            background-color: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 15px;
            display: flex !important; /* æ”¹ç”¨ç®€å•çš„Flexå¸ƒå±€ */
            align-items: center !important;
            justify-content: space-between !important;
            width: 100% !important;
            box-sizing: border-box !important;
            min-height: 60px;
        }
        
        /* å·¦ä¾§ï¼šå›¾æ ‡+æ ‡ç­¾ */
        .balance-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        
        /* é‡‘å¸å›¾æ ‡ - ä½¿ç”¨æ–‡å­—è€Œéç¬¦å· */
        .balance-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #2A1810;
            font-weight: bold;
            font-size: 18px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
            border: 2px solid #FFD700;
            position: relative;
        }
        
        /* æ·»åŠ é‡‘å¸è´¨æ„Ÿ */
        .balance-icon::before {
            content: "Â¥";
            font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        /* æ ‡ç­¾æ–‡å­— */
        .balance-label {
            font-size: clamp(0.85em, 2.5vw, 1em);
            color: var(--text-color-primary);
            font-weight: 500;
            white-space: nowrap;
        }
        
        /* ä¸­é—´ï¼šä½™é¢æ•°å€¼ */
        .balance-amount {
            flex: 1;
            text-align: center;
            margin: 0 15px;
        }
        
        #user-account-balance {
            font-size: clamp(1.2em, 4vw, 2em) !important;
            font-weight: bold !important;
            color: #E9C44D !important;
            white-space: nowrap !important;
            text-align: center !important;
            text-shadow: 0 1px 3px rgba(0,0,0,0.4) !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* å³ä¾§ï¼šè£…é¥°å›¾æ ‡ */
        .balance-decoration {
            width: 28px;
            height: 28px;
            fill: var(--accent-gold);
            flex-shrink: 0;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }
        
        .balance-decoration:hover {
            opacity: 1;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 480px) {
            .account-balance-section {
                padding: 12px;
                min-height: 50px;
            }
            
            .balance-icon {
                width: 32px;
                height: 32px;
                font-size: 16px;
            }
            
            .balance-left {
                gap: 8px;
            }
            
            .balance-amount {
                margin: 0 10px;
            }
            
            .balance-decoration {
                width: 24px;
                height: 24px;
            }
        }

        /* ğŸ¯ åŠ¨æ€é€‰é¡¹æ ·å¼ä¼˜åŒ– */
        .option-item[data-option-key] {
            /* ç¡®ä¿åŠ¨æ€ç”Ÿæˆçš„é€‰é¡¹æœ‰æ­£ç¡®çš„æ ·å¼ç»§æ‰¿ */
            transition: all 0.3s ease;
        }
        
        .option-item[data-option-key]:hover {
            transform: translateY(-1px);
        }
        
        /* é€‰é¡¹æŒ‰é’®é—´è·è°ƒæ•´ */
        .option-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }
        
        .option-buttons .action-btn {
            flex: 1;
            min-width: 80px;
        }
        
        /* ç§»åŠ¨ç«¯é€‰é¡¹æŒ‰é’®ä¼˜åŒ– */
        @media (max-width: 480px) {
            .option-buttons {
                gap: 6px;
            }
            
            .option-buttons .action-btn {
                font-size: 0.85em;
                padding: 8px 12px;
            }
        }

        /* [ä¸»å†…å®¹ç½‘æ ¼: å·¦å³å¸ƒå±€] */
        .details-grid {
            display: grid;
            grid-template-columns: 1fr 2fr; /* æ”¹ä¸º1:2çš„æ¯”ä¾‹ï¼Œç¡®ä¿å“åº”å¼å¸ƒå±€ */
            gap: 15px;
            flex-grow: 1;
            overflow: hidden;
        }

        /* [å·¦æ : ä¸ªäººèµ„æ–™] */
        .profile-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        .profile-section .avatar-image {
            width: 100%;
            aspect-ratio: 1 / 1.25;
            object-fit: contain; /* æ”¹ä¸º contain ä»¥æ˜¾ç¤ºå®Œæ•´å›¾ç‰‡ */
            border-radius: 12px;
            margin-bottom: 5px;
            background-color: var(--main-bg);
        }
        #user-name-header {
            font-size: 1.2em;
            font-weight: bold;
            color: var(--text-color-light);
        }
        #user-rank-header {
            background-color: var(--accent-gold);
            color: var(--text-color-dark);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .star-rating {
            display: flex;
            gap: 4px;
            margin-top: 5px;
        }
        .star-rating .icon {
            width: 16px;
            height: 16px;
            fill: var(--accent-gold);
            animation: flow-glow 2.5s infinite ease-in-out;
        }
        .star-rating .icon.heart-outline {
            fill: none;
            stroke: var(--accent-gold);
            stroke-width: 1.5px;
        }

        /* æµå…‰åŠ¨ç”»å»¶è¿Ÿ */
        .star-rating .icon:nth-child(1) { animation-delay: 0s; }
        .star-rating .icon:nth-child(2) { animation-delay: 0.3s; }
        .star-rating .icon:nth-child(3) { animation-delay: 0.6s; }
        .star-rating .icon:nth-child(4) { animation-delay: 0.9s; }
        .star-rating .icon:nth-child(5) { animation-delay: 1.2s; }

        /* [å³æ : å±æ€§åˆ—è¡¨] */
        .properties-section {
            display: flex;
            flex-direction: column;
            justify-content: flex-start; /* æ”¹ä¸º flex-startï¼Œè®©æ¡ç›®ä»é¡¶éƒ¨å¼€å§‹å¯¹é½ï¼Œè€Œä¸æ˜¯åˆ†æ•£å¯¹é½ */
            gap: 8px; /* å‡å°‘é—´è·ä»¥é€‚åº”å°å±å¹• */
        }
        .property {
            display: flex;
            align-items: center;
            background-color: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 10px;
            gap: 10px; /* å‡å°‘é—´è· */
            overflow: hidden;
        }
        .property-icon-wrapper {
            width: 32px;
            height: 32px;
            flex-shrink: 0;
            background-color: var(--accent-gold);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .property-icon-wrapper .icon {
            width: 20px;
            height: 20px;
            fill: var(--text-color-dark);
        }
        .property-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }
        .property-label {
            font-size: 0.8em;
            color: #a099b3; /* Lighter purple-ish gray */
        }
        .property-value {
            font-size: 1em;
            font-weight: bold;
            color: var(--text-color-light);
            white-space: normal; /* å…è®¸æ–‡æœ¬æ¢è¡Œ */
            word-break: break-word; /* å…è®¸é•¿å•è¯æˆ–URLæ¢è¡Œï¼Œé˜²æ­¢æº¢å‡º */
        }

        /* [åº•éƒ¨å¯¼èˆª] */
        .bottom-nav {
            position: absolute;
            bottom: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
        }
        .bottom-nav .icon {
            width: 24px;
            height: 24px;
            fill: var(--text-color-light);
            opacity: 0.7;
            cursor: pointer;
            pointer-events: all;
            transition: opacity 0.3s, transform 0.3s;
        }
        .bottom-nav .icon:hover {
            opacity: 1;
            transform: scale(1.1);
        }

        /* [æ’åºåŠŸèƒ½æ ·å¼] */
        .tab-edit-controls {
            display: flex;
            align-items: center;
            margin-left: auto; /* Pushes it to the far right */
            padding-left: 10px;
        }
        .tab-edit-controls .icon {
            width: 20px;
            height: 20px;
            fill: var(--accent-gold);
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        .tab-edit-controls .icon:hover {
            opacity: 1;
        }

        .status-tabs.edit-mode .tab {
            cursor: move;
            border: 1px dashed var(--accent-gold);
            user-select: none; /* é˜²æ­¢é•¿æŒ‰æ—¶é€‰ä¸­æ–‡æœ¬ */
            -webkit-user-select: none;
            -webkit-touch-callout: none; /* ç¦ç”¨iOSé•¿æŒ‰èœå• */
            -webkit-tap-highlight-color: transparent; /* ç¦ç”¨ç‚¹å‡»é«˜äº® */
        }

        .status-tabs .tab.dragging {
            opacity: 0.4;
            background: var(--accent-gold);
            color: var(--text-color-dark);
            transform: scale(1.05); /* æ‹–æ‹½æ—¶è½»å¾®æ”¾å¤§ */
            z-index: 1000;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .status-tabs .tab.long-pressing {
            background: rgba(239, 213, 134, 0.2);
            transform: scale(1.02);
            transition: all 0.1s ease-out;
        }

        /* [äººé™…å…³ç³»é¡µé¢ç‰¹å®šæ ·å¼] */
        #page-relationships .relationship-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-right: -10px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .relationship-item {
            background-color: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .relationship-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            color: var(--text-color-light);
            font-weight: bold;
        }
        .relationship-header .name-part {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .relationship-header .icon {
             width: 28px;
             height: 28px;
             flex-shrink: 0;
             background-color: var(--accent-gold);
             border-radius: 50%;
             display: flex;
             justify-content: center;
             align-items: center;
             padding: 5px;
             box-sizing: border-box;
        }
        .relationship-header .icon svg {
             fill: var(--text-color-dark);
        }
        .relationship-header .number-tag {
            background-color: var(--accent-gold);
            color: var(--text-color-dark);
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.8em;
        }
        .relationship-body {
            color: #c7c1d9;
            padding-left: 38px;
            display: flex;
            flex-direction: column;
            gap: 2px; /* å‡å°è¡Œé—´è· */
        }
        .relationship-body p {
            margin: 0; /* ç§»é™¤æµè§ˆå™¨é»˜è®¤è¾¹è·ï¼Œç¡®ä¿é—´è·ç»Ÿä¸€ */
        }
        #page-relationships .relationship-list::-webkit-scrollbar {
            width: 6px;
        }
        #page-relationships .relationship-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        #page-relationships .relationship-list::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 3px;
        }
        #page-relationships .relationship-list::-webkit-scrollbar-thumb:hover {
            background: #fff2c8;
        }

        /* [äººé™…å…³ç³»æœç´¢æ æ ·å¼] */
        .relationship-search-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
            padding: 0 10px; /* å¢åŠ ä¸€äº›å†…è¾¹è· */
        }
        .relationship-search-container .icon {
            width: 22px;
            height: 22px;
            fill: var(--accent-gold);
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s;
            flex-shrink: 0;
        }
        .relationship-search-container .icon:hover {
            opacity: 1;
        }
        #relationship-search-input {
            width: 0;
            padding: 0;
            border: none;
            outline: none;
            border-bottom: 1px solid transparent;
            background-color: transparent;
            color: var(--text-color-light);
            font-family: var(--font-main);
            font-size: 0.9em;
            transition: all 0.4s ease-in-out;
            opacity: 0;
        }
        #relationship-search-input.visible {
            width: 150px;
            padding: 5px;
            border-bottom: 1px solid var(--accent-gold);
            opacity: 1;
        }

        /* [åœ°å›¾é¡µé¢ç‰¹å®šæ ·å¼] */
        #page-map {
            flex-grow: 1;
            overflow: hidden;
        }

        .map-container {
            width: 100%;
            /* height: 100%; -- ç§»é™¤å›ºå®šé«˜åº¦ï¼Œæ”¹ç”¨å®½é«˜æ¯” */
            aspect-ratio: 4 / 3; /* æ ¸å¿ƒï¼šä¸ºåœ°å›¾è®¾ç½®å›ºå®šçš„å®½é«˜æ¯”ï¼Œé˜²æ­¢èƒŒæ™¯å›¾è¢«å‹æ‰ */
            background-image: url('https://i.postimg.cc/TYwknqvk/ditu.png');
            background-size: cover;
            background-position: center;
            border-radius: 12px;
            position: relative;
        }

        #map-pins-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .map-pin {
            position: absolute;
            padding: 5px 12px;
            border-radius: 16px;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            transform: translate(-50%, -50%); /* ç²¾å‡†å±…ä¸­ */
        }
        .map-pin:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.7);
        }

        .map-pin.city {
            background-color: var(--accent-gold);
            color: var(--text-color-dark);
            border-color: #fde047;
        }

        .map-pin.location {
            background-color: #16a34a; /* ç»¿è‰² */
            border-color: #4ade80;
            font-size: 0.75em;
        }

        .map-pin.home {
            background-color: var(--accent-gold);
            color: var(--text-color-dark);
            border-color: #fde047;
        }
        
        /* [å¼¹çª— Modal æ ·å¼] */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--main-bg);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--accent-gold);
            width: 90%;
            max-width: 600px; /* å¢åŠ æœ€å¤§å®½åº¦ä»¥é€‚åº”æ›´å¤šå†…å®¹ */
            max-height: 90vh; /* é™åˆ¶é«˜åº¦ï¼Œé¿å…è¶…å‡ºå±å¹• */
            position: relative;
            box-shadow: var(--border-glow);
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto; /* å†…å®¹è¿‡å¤šæ—¶å…è®¸æ»šåŠ¨ */
        }

        /* å¼¹çª—æ»šåŠ¨æ¡æ ·å¼ */
        .modal-content::-webkit-scrollbar {
            width: 6px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.2);
            border-radius: 3px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: 3px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #fff2c8;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--accent-gold);
            padding-bottom: 10px;
            border-bottom: 1px solid var(--accent-gold);
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.3em;
            word-break: break-word; /* é•¿æ ‡é¢˜è‡ªåŠ¨æ¢è¡Œ */
            line-height: 1.2;
        }

        .modal-header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .modal-back-btn {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-color-light);
            cursor: pointer;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .modal-back-btn:hover {
            opacity: 1;
        }

        .modal-close-btn {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--text-color-light);
            cursor: pointer;
            line-height: 1;
        }
        
        .modal-body {
             color: var(--text-color-primary);
             word-wrap: break-word; /* é•¿å•è¯è‡ªåŠ¨æ¢è¡Œ */
             overflow-wrap: break-word; /* ç¡®ä¿å…¼å®¹æ€§ */
        }

        .modal-body h4 {
            margin-top: 15px;
            margin-bottom: 10px;
            color: var(--text-color-light);
        }

        .modal-locations-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* ç¨å¾®å‡å°‘é—´è· */
            justify-content: flex-start; /* ä»å·¦å¼€å§‹æ’åˆ— */
        }
        
        .modal-locations-list .location-btn {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid var(--accent-gold);
            color: var(--text-color-light);
            padding: 6px 10px; /* ç¨å¾®å‡å°‘å†…è¾¹è· */
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9em;
            white-space: nowrap; /* é˜²æ­¢æŒ‰é’®æ–‡å­—æ¢è¡Œ */
            flex: 0 1 auto; /* å¼¹æ€§å¸ƒå±€ */
            min-width: 0; /* å…è®¸æ”¶ç¼© */
            text-align: center;
        }

        .modal-locations-list .location-btn:hover {
            background-color: var(--accent-gold);
            color: var(--text-color-dark);
        }

        .modal-details-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .modal-detail-item p {
            margin: 0;
            white-space: pre-wrap; /* æ”¯æŒæ¢è¡Œç¬¦ */
        }
        
        .modal-detail-item strong {
            color: var(--accent-gold);
        }

        .modal-action-btn {
            background: var(--accent-gold);
            color: var(--text-color-dark);
            border: none;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: bold;
            font-size: 1em;
            transition: transform 0.2s, box-shadow 0.2s;
            align-self: center; /* æŒ‰é’®å±…ä¸­ */
        }
        .modal-action-btn .icon {
            width: 18px;
            height: 18px;
            fill: var(--text-color-dark);
        }

        .modal-action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px var(--shadow-color);
        }

        /* [åœ°å›¾å¼¹çª—å“åº”å¼è®¾è®¡] */
        
        /* å¤§å±å¹•ä¼˜åŒ– (>1200px) */
        @media (min-width: 1201px) {
            .modal-content {
                max-width: 700px;
                padding: 25px;
            }
            
            .modal-header h3 {
                font-size: 1.4em;
            }
            
            .modal-locations-list {
                gap: 12px;
            }
            
            .modal-locations-list .location-btn {
                padding: 8px 14px;
                font-size: 1em;
            }
        }

        /* ä¸­ç­‰å±å¹•ä¼˜åŒ– (768px - 1200px) */
        @media (max-width: 1200px) and (min-width: 769px) {
            .modal-content {
                max-width: 550px;
                padding: 18px;
            }
            
            .modal-header h3 {
                font-size: 1.2em;
            }
            
            .modal-locations-list .location-btn {
                font-size: 0.85em;
                padding: 5px 9px;
            }
        }

        /* å¹³æ¿å±å¹•ä¼˜åŒ– (481px - 768px) */
        @media (max-width: 768px) and (min-width: 481px) {
            .modal-content {
                width: 95%;
                max-width: 500px;
                padding: 15px;
                gap: 12px;
            }
            
            .modal-header {
                padding-bottom: 8px;
                flex-wrap: wrap; /* å…è®¸æ ‡é¢˜æ¢è¡Œ */
                gap: 8px;
            }
            
            .modal-header h3 {
                font-size: 1.1em;
                flex: 1 1 100%; /* æ ‡é¢˜å æ»¡ä¸€è¡Œ */
                margin-bottom: 5px;
            }
            
            .modal-header-controls {
                gap: 10px;
                align-self: flex-end;
            }
            
            .modal-body h4 {
                font-size: 1em;
                margin-top: 10px;
                margin-bottom: 8px;
            }
            
            .modal-locations-list {
                gap: 6px;
            }
            
            .modal-locations-list .location-btn {
                font-size: 0.8em;
                padding: 4px 8px;
                border-radius: 4px;
            }
            
            .modal-action-btn {
                padding: 8px 12px;
                font-size: 0.9em;
            }
            
            .modal-action-btn .icon {
                width: 16px;
                height: 16px;
            }
        }

        /* æ‰‹æœºå±å¹•ä¼˜åŒ– (â‰¤480px) */
        @media (max-width: 480px) {
            .modal-overlay {
                padding: 10px; /* ç»™è¾¹ç¼˜ç•™å‡ºç©ºé—´ */
            }
            
            .modal-content {
                width: 100%;
                max-width: none;
                padding: 12px;
                gap: 10px;
                max-height: 95vh; /* åœ¨å°å±å¹•ä¸Šç•™æ›´å¤šç©ºé—´ */
                border-radius: 12px;
            }
            
            .modal-header {
                padding-bottom: 6px;
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
            }
            
            .modal-header h3 {
                font-size: 1em;
                line-height: 1.3;
                width: 100%;
                text-align: center;
                margin-bottom: 0;
            }
            
            .modal-header-controls {
                position: absolute;
                top: 12px;
                right: 12px;
                gap: 8px;
            }
            
            .modal-close-btn {
                font-size: 1.5em;
            }
            
            .modal-back-btn {
                font-size: 1.3em;
            }
            
            .modal-body {
                padding-top: 5px;
            }
            
            .modal-body h4 {
                font-size: 0.9em;
                margin-top: 8px;
                margin-bottom: 6px;
            }
            
            .modal-body p {
                font-size: 0.85em;
                line-height: 1.4;
            }
            
            .modal-locations-list {
                gap: 4px;
                justify-content: space-between; /* åœ¨å°å±å¹•ä¸Šå‡åŒ€åˆ†å¸ƒ */
            }
            
            .modal-locations-list .location-btn {
                font-size: 0.75em;
                padding: 3px 6px;
                border-radius: 3px;
                flex: 1 1 auto; /* æŒ‰é’®è‡ªé€‚åº”å®½åº¦ */
                margin: 1px; /* æœ€å°é—´è· */
                min-width: 60px; /* æœ€å°å®½åº¦ */
                max-width: 120px; /* æœ€å¤§å®½åº¦ */
            }
            
            .modal-details-grid {
                gap: 6px;
                margin-bottom: 15px;
            }
            
            .modal-action-btn {
                padding: 6px 10px;
                font-size: 0.85em;
                gap: 6px;
            }
            
            .modal-action-btn .icon {
                width: 14px;
                height: 14px;
            }
        }

        /* è¶…å°å±å¹•ä¼˜åŒ– (â‰¤360px) */
        @media (max-width: 360px) {
            .modal-overlay {
                padding: 5px;
            }
            
            .modal-content {
                padding: 10px;
                gap: 8px;
                border-radius: 8px;
            }
            
            .modal-header h3 {
                font-size: 0.9em;
            }
            
            .modal-body h4 {
                font-size: 0.85em;
            }
            
            .modal-body p {
                font-size: 0.8em;
            }
            
            .modal-locations-list .location-btn {
                font-size: 0.7em;
                padding: 2px 4px;
                min-width: 50px;
                max-width: 100px;
                overflow: hidden; /* é˜²æ­¢æ–‡æœ¬æº¢å‡º */
                text-overflow: ellipsis; /* é•¿æ–‡æœ¬æ˜¾ç¤ºçœç•¥å· */
            }
            
            .modal-action-btn {
                font-size: 0.8em;
                padding: 5px 8px;
            }
        }

        /* [å“åº”å¼è®¾è®¡] */
        /* ä¸­ç­‰å±å¹•æ—¶ç¼©çŸ­é—´è· */
        @media (max-width: 900px) {
            .option-buttons {
                gap: 12px;
                max-width: 360px;
            }
            
            .action-btn {
                max-width: 100px;
            }
        }

        @media (max-width: 600px) {
            .option-buttons {
                gap: 8px;
                max-width: 320px;
            }

            .action-btn {
                font-size: 0.75em;
                padding: 5px 8px;
                min-width: 50px;
                max-width: 80px;
            }
        }

        @media (max-width: 480px) {
            .option-buttons {
                gap: 6px;
                max-width: 280px;
            }

            .action-btn {
                font-size: 0.7em;
                padding: 4px 6px;
                min-width: 45px;
                max-width: 70px;
                white-space: normal;
                line-height: 1.2;
                height: auto;
                min-height: 28px;
            }
        }

        /* é€‚ç”¨äºå¹³æ¿å’Œè¾ƒçª„çš„æ¡Œé¢æµè§ˆå™¨çª—å£ */
        @media (max-width: 768px) {
            .status-container {
                /* ç§»é™¤ aspect-ratioï¼Œé«˜åº¦å§‹ç»ˆç”±å†…å®¹å†³å®š */
                padding: 10px;
            }

            
            .main-title-bar {
                font-size: 1em;
                margin-bottom: 10px;
            }

            .status-tabs {
                margin-bottom: 15px;
            }

            .tab {
                font-size: 0.85em;
                padding: 6px 10px;
            }
        }
        
        /* ä»…åœ¨éå¸¸çª„çš„å±å¹•ï¼ˆå¦‚æ‰‹æœºï¼‰ä¸Šè§¦å‘å †å  */
        @media (max-width: 620px) {
             .details-grid {
                /* åœ¨å°å±å¹•ä¸Šå°†ç½‘æ ¼å¸ƒå±€æ”¹ä¸ºå•åˆ—å †å  */
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .profile-section {
                 /* å †å æ—¶å±…ä¸­ä¸ªäººèµ„æ–™ */
                align-items: center;
            }

            .profile-section .avatar-image {
                /* é™åˆ¶å¤´åƒå®½åº¦ï¼Œé¿å…åœ¨å•åˆ—å¸ƒå±€ä¸­è¿‡å¤§ */
                width: 50%;
                max-width: 180px;
            }

            .properties-section {
                /* å½“å †å æ—¶ï¼Œä»é¡¶éƒ¨å¼€å§‹æ’åˆ—å±æ€§ */
                justify-content: flex-start;
            }

            .datetime-info {
                /* å°†æ—¥æœŸå’Œæ—¶é—´çºµå‘æ’åˆ—å¹¶å±…ä¸­ */
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
        }

        /* é’ˆå¯¹éå¸¸å°çš„å±å¹•è¿›ä¸€æ­¥ä¼˜åŒ– */
        @media (max-width: 480px) {
            .status-container {
                /* ç§»é™¤ aspect-ratio */
            }
            
            .main-title-bar {
                font-size: 0.9em;
                gap: 8px;
            }
            
            .tab {
                font-size: 0.8em;
            }

            .property-label {
                font-size: 0.75em;
            }
            
            .property-value {
                font-size: 0.9em;
            }

            #user-name-header {
                font-size: 1.1em;
            }
            
            #user-rank-header {
                font-size: 0.75em;
            }
        }

        /* [æ–°å¢åŠ¨ç”»] */
        @keyframes flow-glow {
          0%, 100% {
            opacity: 0.5;
            transform: scale(1);
          }
          50% {
            opacity: 1;
            transform: scale(1.1);
          }
        }
        
        @keyframes icon-glow-twinkle {
          0%, 100% {
            opacity: 0.7;
            filter: drop-shadow(0 0 2px var(--shadow-color));
          }
          50% {
            opacity: 1;
            filter: drop-shadow(0 0 5px var(--accent-gold));
            transform: scale(1.05);
          }
        }

    </style>
</head>
<body>

    <div class="status-container collapsed" id="status-main">

        <div id="collapse-toggle-btn">
            <svg class="icon" viewBox="0 0 24 24"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg>
    </div>

        <div class="main-title-bar">
            <svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
            <span>å¨±ä¹åœˆæ•›è´¢ç³»ç»Ÿ</span>
            <svg class="icon" viewBox="0 0 24 24"><path d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5z"/></svg>
        </div>

        <!-- æ·éª°ç»“æœå¼¹çª— -->
        <div id="dice-result-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content dice-modal-content">
                <div class="modal-header">
                    <h3>æ·éª°ç»“æœ</h3>
                    <span class="modal-close-btn" onclick="closeDiceModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="dice-result-main">
                        <div class="dice-outcome" id="dice-outcome">æˆåŠŸ</div>
                        <div class="dice-description" id="dice-description">è¿æ°”ä¸é”™ï¼Œä¸€åˆ‡éƒ½æŒ‰è®¡åˆ’è¿›è¡Œï¼</div>
                    </div>
                    <div class="dice-details">
                        <div class="dice-detail-item">
                            <span class="dice-label">æœ¬æ¬¡æŠ•æ·æ•°å€¼ï¼š</span>
                            <span class="dice-value" id="dice-roll-value">45</span>
                        </div>
                        <div class="dice-detail-item">
                            <span class="dice-label">å¹³å‡å±æ€§æ•°å€¼ï¼š</span>
                            <span class="dice-value" id="dice-st-value">60</span>
                        </div>
                        <div class="dice-detail-item">
                            <span class="dice-label">è¿æ°”åŠ æˆï¼š</span>
                            <span class="dice-value" id="dice-luck-bonus">+5</span>
                        </div>
                        <div class="dice-detail-item" id="special-points-item" style="display: none;">
                            <span class="dice-label">ç‰¹æ®Šç‚¹æ•°ï¼š</span>
                            <span class="dice-value" id="dice-special-points">+1</span>
                        </div>
                        <div class="dice-detail-item">
                            <span class="dice-label">æœ€ç»ˆæ•°å€¼ï¼š</span>
                            <span class="dice-value" id="dice-final-st">65</span>
                        </div>
                        <div class="dice-formula">
                            <span id="dice-comparison">45 â‰¤ 65</span>
                        </div>
                    </div>
                    <button class="reroll-btn" id="reroll-btn" onclick="rerollDice()">ä¸æ»¡æ„ï¼Ÿé‡æ·ä¸€æ¬¡</button>
                </div>
            </div>
        </div>

        <!-- è¾“å…¥åå‘é€å¼¹çª— -->
        <div id="input-send-modal" class="modal-overlay" style="display: none;">
            <div class="modal-content input-modal-content">
                <div class="modal-header">
                    <h3>ç¼–è¾‘æ¶ˆæ¯å†…å®¹</h3>
                    <span class="modal-close-btn" onclick="closeInputModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="input-description">
                        æ‚¨å¯ä»¥ç¼–è¾‘ä¸‹æ–¹çš„æ¶ˆæ¯å†…å®¹ï¼Œç„¶åå‘é€ç»™AIï¼š
                    </div>
                    <textarea id="message-input" class="message-textarea" placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹..."></textarea>
                    <div class="modal-buttons">
                        <button class="cancel-btn" onclick="closeInputModal()">å–æ¶ˆ</button>
                        <button class="send-btn" onclick="sendEditedMessage()">å‘é€</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="collapsible-content">
            <div class="status-tabs">
                <div class="tab active" data-tab="info">åŸºç¡€ä¿¡æ¯</div>
                <div class="tab" data-tab="ability">å±æ€§</div>
                <div class="tab" data-tab="panel">ç³»ç»Ÿé¢æ¿</div>
                <div class="tab" data-tab="current-project">å½“å‰é€šå‘Š</div>
                <div class="tab" data-tab="options">é€‰é¡¹æ·éª°</div>
                <div class="tab" data-tab="relationships">äººé™…å…³ç³»</div>
                <div class="tab" data-tab="map">åœ°å›¾</div>
                <div class="tab-edit-controls">
                    <svg id="visibility-btn" class="icon" viewBox="0 0 24 24" title="æ˜¾ç¤º/éšè—é¡µé¢"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5C21.27 7.61 17 4.5 12 4.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                    <svg id="edit-order-btn" class="icon" viewBox="0 0 24 24" title="ç¼–è¾‘é¡ºåº"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    <svg id="save-order-btn" class="icon" style="display:none;" viewBox="0 0 24 24" title="ä¿å­˜é¡ºåº"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                </div>
            </div>

            <div id="page-info" class="content-page active">
                <div class="scrollable-page-content">
                <div class="status-content">
                    <div class="account-balance-section">
                        <div class="balance-left">
                            <div class="balance-icon"></div>
                            <div class="balance-label">è´¦æˆ·ä½™é¢</div>
                        </div>
                        <div class="balance-amount">
                            <div class="property-value" id="user-account-balance">-</div>
                        </div>
                        <svg class="balance-decoration" viewBox="0 0 24 24"><path d="M12 2L9.5 9.5 2 12l7.5 2.5L12 22l2.5-7.5L22 12l-7.5-2.5z"/></svg>
                    </div>

                    <div class="details-grid">
                        <div class="profile-section">
                            <img id="user-avatar" class="avatar-image" src="" alt="ç”¨æˆ·å¤´åƒ">
                            <div id="user-name-header">-</div>
                            <div id="user-rank-header">-</div>
                            <div class="datetime-info">
                                <div class="datetime-item" id="date-container">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V4h-4z"/></svg>
                                    <span id="user-date">-</span>
                                </div>
                                <div class="datetime-item" id="time-container">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                                    <span id="user-time">-</span>
                                </div>
                            </div>
                            <div class="star-rating">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                <svg class="icon heart-outline" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                <svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                <svg class="icon heart-outline" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                <svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            </div>
        </div>

                        <div class="properties-section">
        <div class="property">
                                <div class="property-icon-wrapper"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div>
                                <div class="property-details">
            <div class="property-label">ä½ç½®</div>
                                    <div class="property-value" id="user-location">-</div>
                                </div>
        </div>
        <div class="property">
                                <div class="property-icon-wrapper"><svg class="icon" viewBox="0 0 24 24"><path d="M20.35 6.35L19 5l-7-3-7 3L3.65 6.35C2.6 7.39 2 8.77 2 10.25V20c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V10.25c0-1.48-.6-2.86-1.65-3.9zM8 11V9l4-1.5 4 1.5v2H8z"/></svg></div>
                                <div class="property-details">
            <div class="property-label">è¡£ç€</div>
                                    <div class="property-value" id="user-attire">-</div>
                                </div>
        </div>
        <div class="property">
                                <div class="property-icon-wrapper"><svg class="icon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5s-2.24-5-5-5h-1c-.55 0-1-.45-1-1s.45-1 1-1h1c3.86 0 7 3.14 7 7s-3.14 7-7 7h-1.5c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1.5 10c.83 0 1.5-.67 1.5-1.5S11.33 10 10.5 10 9 10.67 9 11.5s.67 1.5 1.5 1.5zm-3-4c.83 0 1.5-.67 1.5-1.5S8.33 6 7.5 6 6 6.67 6 7.5s.67 1.5 1.5 1.5zm6 0c.83 0 1.5-.67 1.5-1.5S14.33 6 13.5 6 12 6.67 12 7.5s.67 1.5 1.5 1.5z"/></svg></div>
                                <div class="property-details">
            <div class="property-label">å¦†å®¹</div>
                                    <div class="property-value" id="user-makeup">-</div>
                                </div>
        </div>
        <div class="property">
                                <div class="property-icon-wrapper"><svg class="icon" viewBox="0 0 24 24"><path d="M3 13h2.2l1.2-4.4 2.1 8.4 2.6-6.4 1.6 3.4H17v-2h-3.5l-1.3-2.8L9.4 15 7.5 9l-2.3 5H3v2z"/></svg></div>
                                <div class="property-details">
            <div class="property-label">è¡Œä¸º</div>
                                    <div class="property-value" id="user-behavior">-</div>
                                </div>
        </div>
        <div class="property">
                                <div class="property-icon-wrapper"><svg class="icon" viewBox="0 0 24 24"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg></div>
                                <div class="property-details">
            <div class="property-label">æ€§æ¬²å€¼</div>
                                    <div class="property-value" id="user-lust-value">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="page-ability" class="content-page">
                <div class="scrollable-page-content">
                    <div class="attributes-container">
                        <!-- åŸºç¡€å±æ€§æ•°å€¼ -->
                        <div class="attribute-section">
                            <div class="attribute-section-title">åŸºç¡€å±æ€§æ•°å€¼</div>
                            <div class="attribute-list">
                                <!-- åŠ›é‡ -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M17 4h-2V2.59c0-.89-.89-1.59-2-1.59s-2 .7-2 1.59V4h-2c-1.1 0-2 .9-2 2v3c0 1.1.9 2 2 2h1v9c0 1.1.9 2 2 2h2c1.1 0 2-.9 2-2v-9h1c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z"/></svg>
                                    <div class="attribute-label">åŠ›é‡</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-strength-progress"></div></div>
                                    <div class="attribute-value" id="user-strength-value">-</div>
                                </div>
                                <!-- ä½“è´¨ -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                    <div class="attribute-label">ä½“è´¨</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-constitution-progress"></div></div>
                                    <div class="attribute-value" id="user-constitution-value">-</div>
                                </div>
                                <!-- æ•æ· -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M13.49 5.48c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm-3.6 13.9l1-4.4 2.1 2v6h2v-7.5l-2.1-2 .6-3c1.3 1.5 3.3 2.5 5.5 2.5v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1l-5.2 2.2v4.7h2v-3.4l1.8-.7-1.6 8.1-4.9-1-.4 2 7 1.4z"/></svg>
                                    <div class="attribute-label">æ•æ·</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-agility-progress"></div></div>
                                    <div class="attribute-value" id="user-agility-value">-</div>
                                </div>
                                <!-- æ™ºåŠ› -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                                    <div class="attribute-label">æ™ºåŠ›</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-intelligence-progress"></div></div>
                                    <div class="attribute-value" id="user-intelligence-value">-</div>
                                </div>
                                <!-- æ„å¿— -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 3l3.09 6.26L22 10.27l-5 4.87 1.18 6.88L12 18.77l-6.18 3.25L7 15.14 2 10.27l6.91-1.01L12 3z"/></svg>
                                    <div class="attribute-label">æ„å¿—</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-will-progress"></div></div>
                                    <div class="attribute-value" id="user-will-value">-</div>
                                </div>
                                <!-- æ„ŸçŸ¥ -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                                    <div class="attribute-label">æ„ŸçŸ¥</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-perception-progress"></div></div>
                                    <div class="attribute-value" id="user-perception-value">-</div>
                                </div>
                                <!-- é­…åŠ› -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                    <div class="attribute-label">é­…åŠ›</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-charisma-progress"></div></div>
                                    <div class="attribute-value" id="user-charisma-value">-</div>
                                </div>
                                <!-- è¿æ°” -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M11 21h2v-2h-2v2zm0-4h2v-2h-2v2zm0-4h2v-2h-2v2zm0-4h2V7h-2v2zm0-4h2V3h-2v2zm4 16h2v-2h-2v2zM7 21h2v-2H7v2zm8-4h2v-2h-2v2zm-4-4h2v-2h-2v2zm4-4h2V7h-2v2zm-4-4h2V3h-2v2zM7 5h2V3H7v2z"/></svg>
                                    <div class="attribute-label">è¿æ°”</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-luck-progress"></div></div>
                                    <div class="attribute-value" id="user-luck-value">-</div>
                                </div>
                                <!-- è¡Œä¸šåœ°ä½ -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                                    <div class="attribute-label">è¡Œä¸šåœ°ä½</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-industry-status-progress"></div></div>
                                    <div class="attribute-value" id="user-industry-status-value">-</div>
                                </div>
                                <!-- é£è¯„ -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M7 4V2c0-1.1.9-2 2-2h6c1.1 0 2 .9 2 2v2c4 0 7 3 7 7 0 1.1-.9 2-2 2v2c0 4-3 7-7 7H9c-4 0-7-3-7-7v-2c-1.1 0-2-.9-2-2 0-4 3-7 7-7zM9 6c-2.8 0-5 2.2-5 5s2.2 5 5 5h6c2.8 0 5-2.2 5-5s-2.2-5-5-5H9z"/></svg>
                                    <div class="attribute-label">é£è¯„</div>
                                    <div class="progress-bar-container"><div class="progress-bar reputation" id="user-reputation-progress"></div></div>
                                    <div class="attribute-value reputation" id="user-reputation-value">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- èƒ½åŠ›æ•°å€¼ -->
                        <div class="attribute-section">
                            <div class="attribute-section-title">èƒ½åŠ›æ•°å€¼</div>
                            <div class="attribute-list">
                    <!-- æ¼”æŠ€ -->
                                <div class="attribute-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z"/></svg>
                                    <div class="attribute-label">æ¼”æŠ€</div>
                        <div class="progress-bar-container"><div class="progress-bar" id="user-acting-progress"></div></div>
                                    <div class="attribute-value" id="user-acting-value">-</div>
                    </div>
                    <!-- å”±åŠŸ -->
                                <div class="attribute-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.49 6-3.31 6-6.72h-1.7z"/></svg>
                                    <div class="attribute-label">å”±åŠŸ</div>
                        <div class="progress-bar-container"><div class="progress-bar" id="user-singing-progress"></div></div>
                                    <div class="attribute-value" id="user-singing-value">-</div>
                    </div>
                    <!-- èˆè¹ˆ -->
                                <div class="attribute-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M15 6H3v2h12V6zm0 4H3v2h12v-2zM3 16h8v-2H3v2zM17 6v8.18c-.31-.11-.65-.18-1-.18-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3V8h3V6h-5z"/></svg>
                                    <div class="attribute-label">èˆè¹ˆ</div>
                        <div class="progress-bar-container"><div class="progress-bar" id="user-dancing-progress"></div></div>
                                    <div class="attribute-value" id="user-dancing-value">-</div>
                    </div>
                    <!-- ç»¼è‰ºæ„Ÿ -->
                                <div class="attribute-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27z"/></svg>
                                    <div class="attribute-label">ç»¼è‰ºæ„Ÿ</div>
                        <div class="progress-bar-container"><div class="progress-bar" id="user-variety-progress"></div></div>
                                    <div class="attribute-value" id="user-variety-value">-</div>
                                </div>
                                <!-- å­¦ä¹ èƒ½åŠ› -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M5 13.18v2.81c0 .73.4 1.41 1.04 1.76l5 2.73c.6.33 1.32.33 1.92 0l5-2.73c.64-.35 1.04-1.03 1.04-1.76v-2.81l-6.04 3.3c-.6.33-1.32.33-1.92 0L5 13.18zm6.04-9.66l-8.43 4.6c-.69.38-.69 1.38 0 1.76l8.43 4.6c.6.33 1.32.33 1.92 0l8.43-4.6c.69-.38.69-1.38 0-1.76l-8.43-4.6c-.6-.33-1.32-.33-1.92 0z"/></svg>
                                    <div class="attribute-label">å­¦ä¹ èƒ½åŠ›</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-learning-progress"></div></div>
                                    <div class="attribute-value" id="user-learning-value">-</div>
                                </div>
                                <!-- å•†ä¸šä»·å€¼ -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                    <div class="attribute-label">å•†ä¸šä»·å€¼</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-commercial-progress"></div></div>
                                    <div class="attribute-value" id="user-commercial-value">-</div>
                    </div>
                    <!-- åˆ›ä½œèƒ½åŠ› -->
                                <div class="attribute-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M4 17.17L5.17 16H20V4H4v13.17zM9 11h6v2H9v-2zm-2.5 1.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5zM17.5 12.5c.83 0 1.5-.67 1.5-1.5s-.67-1.5-1.5-1.5-1.5.67-1.5 1.5.67 1.5 1.5 1.5z" opacity=".3"/><path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4V4c0-1.1-.9-2-2-2zm0 14H5V9h14v11zM3.5-5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zm-9 0c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zm4.5-2h-6V9h6v2z"/></svg>
                                    <div class="attribute-label">åˆ›ä½œèƒ½åŠ›</div>
                        <div class="progress-bar-container"><div class="progress-bar" id="user-creativity-progress"></div></div>
                                    <div class="attribute-value" id="user-creativity-value">-</div>
                    </div>
                    <!-- å•†ä¸šèƒ½åŠ› -->
                                <div class="attribute-item">
                        <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1.2 15.3c-.63 0-1.2-.28-1.6-.78l-.19-.31c-.48-.79-.34-1.81.33-2.45l2.45-1.48c.3-.18.64-.28.99-.28.89 0 1.68.59 1.95 1.43l.26.83c.12.39.04.83-.22 1.15l-1.32 1.57c-.29.35-.73.56-1.2.56h-.85z" opacity=".3"/><path d="M12 4c-4.41 0-8 3.59-8 8s3.59 8 8 8 8-3.59 8-8-3.59-8-8-8zm4.24 12.31c-.36.31-.87.42-1.32.28l-.26-.83c-.27-.84-1.06-1.43-1.95-1.43-.35 0-.69.1-.99.28l-2.45 1.48c-.67.64-.81 1.66-.33 2.45l.19.31c.4.5.97.78 1.6.78h.85c.47 0 .91-.21 1.2-.56l1.32-1.57c.26-.32.34-.76.22-1.15zM12 6c.83 0 1.5.67 1.5 1.5S12.83 9 12 9s-1.5-.67-1.5-1.5S11.17 6 12 6zm-4 4c.83 0 1.5.67 1.5 1.5S8.83 13 8 13s-1.5-.67-1.5-1.5S7.17 10 8 10zm8 0c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5z"/></svg>
                                    <div class="attribute-label">å•†ä¸šèƒ½åŠ›</div>
                        <div class="progress-bar-container"><div class="progress-bar" id="user-business-progress"></div></div>
                                    <div class="attribute-value" id="user-business-value">-</div>
                    </div>
                                <!-- è‰²æ¬² -->
                                <div class="attribute-item">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg>
                                    <div class="attribute-label">è‰²æ¬²</div>
                                    <div class="progress-bar-container"><div class="progress-bar" id="user-desire-progress"></div></div>
                                    <div class="attribute-value" id="user-desire-value">-</div>
                    </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-current-project" class="content-page">
                <div class="scrollable-page-content">
                    <div class="project-overview">
                        <!-- é¡¹ç›®å¤´éƒ¨ä¿¡æ¯ -->
                        <div class="project-header">
                            <div class="project-title" id="project-name">æš‚æ— é¡¹ç›®</div>
                            <div class="project-rating default" id="project-rating">æš‚æ— </div>
                        </div>

                        <!-- ç®€ä»‹ -->
                        <div class="project-description">
                            <div class="project-detail-label">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm4 18H6V4h7v5h5v11z"/></svg>
                                ç®€ä»‹
                            </div>
                            <div class="project-detail-value" id="project-description">æš‚æ— é¡¹ç›®ç®€ä»‹</div>
                        </div>

                        <!-- æµç¨‹ -->
                        <div class="project-flow">
                            <div class="project-detail-label">
                                <svg class="icon" viewBox="0 0 24 24"><path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/></svg>
                                æµç¨‹
                            </div>
                            <div class="project-flow-value" id="project-flow">æš‚æ— æµç¨‹ä¿¡æ¯</div>
                        </div>

                        <!-- é¡¹ç›®è¯¦ç»†ä¿¡æ¯ -->
                        <div class="project-details">
                            <!-- ç±»å‹ -->
                            <div class="project-detail-item">
                                <div class="project-detail-label">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
                                    ç±»å‹
                                </div>
                                <div class="project-detail-value" id="project-type">æš‚æ— </div>
                            </div>

                            <!-- å½“å‰è¿›åº¦ -->
                            <div class="project-detail-item">
                                <div class="project-detail-label">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
                                    å½“å‰è¿›åº¦
                                </div>
                                <div class="project-detail-value" id="project-progress">æœªå¼€å§‹</div>
                            </div>

                            <!-- ç”¨æˆ·èŒè´£ -->
                            <div class="project-detail-item">
                                <div class="project-detail-label">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                                    èŒè´£
                                </div>
                                <div class="project-detail-value" id="project-responsibility">æš‚æ— </div>
                            </div>

                            <!-- åŸºç¡€é…¬åŠ³ -->
                            <div class="project-detail-item">
                                <div class="project-detail-label">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/></svg>
                                    åŸºç¡€é…¬åŠ³
                                </div>
                                <div class="project-detail-value salary-info" id="project-salary">
                                    <span class="salary-amount">Â¥0</span>
                                </div>
                            </div>

                            <!-- é™„åŠ é…¬åŠ³ -->
                            <div class="project-detail-item">
                                <div class="project-detail-label">
                                    <svg class="icon" viewBox="0 0 24 24"><path d="M19 7h-3V6a4 4 0 0 0-8 0v1H5a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h10a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM10 6a2 2 0 0 1 4 0v1h-4V6zm8 13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V9h2v1a1 1 0 0 0 2 0V9h4v1a1 1 0 0 0 2 0V9h2v10z"/></svg>
                                    é™„åŠ é…¬åŠ³
                                </div>
                                <div class="project-detail-value" id="project-bonus">æ— </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>

            <div id="page-options" class="content-page">
                <div class="scrollable-page-content">
                    <div class="options-container" id="options-container">
                        <!-- çº¯æ·éª°é€‰é¡¹ï¼ˆå›ºå®šä¿ç•™ï¼‰ -->
                        <div class="option-item pure-dice-option" data-option="pure">
                            <div class="option-behavior">ä¸é€‰æ‹©è¡Œä¸ºï¼Œæˆ‘åªæƒ³æ·éª°å­</div>
                            <div class="option-buttons">
                                <button class="action-btn view-result-btn" onclick="showDiceResult('pure')">æŸ¥çœ‹ç»“æœ</button>
                                <button class="action-btn direct-send-btn" onclick="directSend('pure')">ç›´æ¥å‘é€</button>
                                <button class="action-btn input-send-btn" onclick="inputAndSend('pure')">è¾“å…¥åå‘é€</button>
                            </div>
                        </div>
                        <!-- åŠ¨æ€é€‰é¡¹å°†ç”±processOptionså‡½æ•°ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <div id="page-panel" class="content-page">
                <div class="scrollable-page-content">
                <div class="panel-list">
                    <!-- æ—¥ç¨‹å®‰æ’ -->
                    <div class="panel-item">
                        <div class="panel-header">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm-8-4H7V8h2v2zm4 0h-2V8h2v2zm4 0h-2V8h2v2z"/></svg></span>
                            <span>æ—¥ç¨‹å®‰æ’</span>
                        </div>
                        <div class="panel-body" id="user-schedule">-</div>
                    </div>

                    <!-- å½“å‰ä»»åŠ¡ -->
                    <div class="panel-item">
                        <div class="panel-header">
                            <span class="icon"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v-2h-2z"/></svg></span>
                            <span>å½“å‰ä»»åŠ¡</span>
                            <svg class="star-icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        </div>
                        <div class="panel-body" id="user-task">-</div>
                    </div>
                    <!-- å¤‡å¿˜å½• -->
                    <div class="panel-item">
                        <div class="panel-header">
                             <span class="icon"><svg viewBox="0 0 24 24"><path d="M14 10H6v2h8v-2zm4-4H6v2h12V6zM6 14h8v-2H6v2zm14-10v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h12l4 4z"/></svg></span>
                            <span>å¤‡å¿˜å½•</span>
                        </div>
                        <div class="panel-body" id="user-memo">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="page-relationships" class="content-page">
                 <div class="relationship-search-container">
                    <input type="text" id="relationship-search-input" placeholder="æœç´¢å§“åæˆ–æè¿°...">
                    <svg id="relationship-search-icon" class="icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                </div>
                <div class="relationship-list" id="relationships-list-container">
                    <!-- äººé™…å…³ç³»æ¡ç›®å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                    <p style="padding: 10px; text-align: center;">æ­£åœ¨åŠ è½½äººé™…å…³ç³»...</p>
                </div>
            </div>

            <!-- è§’è‰²é¡µé¢ç°åœ¨ç”± processCharacters åŠ¨æ€ç”Ÿæˆ -->

            <div id="page-map" class="content-page">
                <div class="map-container">
                    <div id="map-pins-container">
                        <!-- åœ°å›¾ä¸Šçš„æ‰€æœ‰æŒ‰é’®å°†ç”±JSåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                    </div>
                </div>
            </div>

            <div class="bottom-nav">
                 <svg class="icon" viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
                 <svg class="icon" viewBox="0 0 24 24"><path d="M8.59 7.41L10 6l6 6-6 6-1.41-1.41L13.17 12z"/></svg>
            </div>
        </div>

</div>

<!-- [åœ°å›¾å¼¹çª— Modals] -->
<div id="city-modal-overlay" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="city-modal-title">-</h3>
            <span class="modal-close-btn">&times;</span>
        </div>
        <div class="modal-body">
            <p id="city-modal-description">-</p>
            <h4>å¯è®¿é—®åœ°ç‚¹ï¼š</h4>
            <div id="city-modal-locations" class="modal-locations-list">
                <!-- åœ°ç‚¹æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
        </div>
    </div>
</div>

<div id="location-modal-overlay" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="location-modal-title">-</h3>
            <div class="modal-header-controls">
                <span class="modal-back-btn" id="location-modal-back-btn" style="display: none;" title="è¿”å›åŸå¸‚">&larr;</span>
            <span class="modal-close-btn">&times;</span>
            </div>
        </div>
        <div class="modal-body">
            <div class="modal-details-grid">
                <!-- è¯¦ç»†ä¿¡æ¯å°†åŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            </div>
            <button class="modal-action-btn">
                <svg class="icon" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                <span>ç§»åŠ¨</span>
            </button>
        </div>
    </div>
</div>

<!-- æ–°å¢ï¼šé¡µé¢å¯è§æ€§åˆ‡æ¢å¼¹çª— -->
<div id="visibility-modal-overlay" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>é€‰æ‹©æ˜¾ç¤ºçš„é¡µé¢</h3>
            <span class="modal-close-btn">&times;</span>
        </div>
        <div class="modal-body" id="visibility-modal-body">
            <!-- Checkboxes will be generated here by JS -->
        </div>
    </div>
</div>


<script>
        // [å…¨å±€ä¿æŠ¤å˜é‡]
        let processingCount = 0;
        const MAX_PROCESSING_COUNT = 5;
        let isProcessing = false;
        let lastProcessTime = 0;
        let initializationTimeout = null;

        // [è¾…åŠ©å‡½æ•°]
        function SafeGetValue(obj, path, defaultValue = '-') { // é»˜è®¤å€¼æ”¹ä¸º'-'æ›´ç»Ÿä¸€
            try {
            const keys = path.split('.');
        let current = obj;
            for (const key of keys) {
                if (current === null || current === undefined) return defaultValue;
                current = current[key];
        }
        if (Array.isArray(current)) {
                return current[0] !== undefined ? current[0] : defaultValue;
            }
            return current !== undefined ? current : defaultValue;
            } catch (error) {
                console.error(`SafeGetValueé”™è¯¯ - è·¯å¾„: ${path}`, error);
                showUserFriendlyError(`æ•°æ®è·å–é”™è¯¯`, `æ— æ³•è·å–æ•°æ®è·¯å¾„: ${path}`, 'è¯·å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
                return defaultValue;
            }
        }

        // æ›´å®½æ¾çš„æ•°æ®è·å–å‡½æ•°ï¼Œç”¨äºé™çº§æ¨¡å¼
        function SafeGetValueLoose(obj, path, defaultValue = '-') {
            try {
                // æ›´å®½æ¾çš„å¤„ç†ï¼Œä¸è½»æ˜“æŠ›å‡ºé”™è¯¯
                if (!obj) return defaultValue;
                
                const keys = path.split('.');
                let current = obj;
                
                for (const key of keys) {
                    if (current === null || current === undefined) {
                        console.warn(`æ•°æ®è·¯å¾„ä¸­æ–­: ${path}, ä½¿ç”¨é»˜è®¤å€¼`);
                        return defaultValue;
                    }
                    current = current[key];
                }
                
                // æ›´å®½æ¾çš„ç±»å‹å¤„ç†
                if (current === null || current === undefined || current === '') {
                    return defaultValue;
                }
                
                if (Array.isArray(current)) {
                    return current.length > 0 ? current[0] : defaultValue;
                }
                
                return current;
            } catch (error) {
                // é”™è¯¯æ—¶ä¸å¼¹çª—ï¼Œåªè®°å½•æ—¥å¿—
                console.warn(`æ•°æ®è·å–è­¦å‘Š - è·¯å¾„: ${path}`, error);
                return defaultValue;
            }
        }

        // ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤ºå‡½æ•°
        function showUserFriendlyError(title, message, solution) {
            const fullMessage = `${title}\n\nè¯¦ç»†ä¿¡æ¯: ${message}\n\nå»ºè®®è§£å†³æ–¹æ¡ˆ: ${solution}`;
            alert(fullMessage);
        }

        // åŸºæœ¬æ¨¡å¼åˆå§‹åŒ–ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
        function initBasicMode() {
            console.warn('å¯åŠ¨åŸºæœ¬æ¨¡å¼ - åªæ˜¾ç¤ºæœ€åŸºæœ¬åŠŸèƒ½');
            try {
                // åªè®¾ç½®æœ€åŸºæœ¬çš„ä¿¡æ¯ï¼Œç¡®ä¿ç•Œé¢å¯ç”¨
                safeSetElement('user-name-header', 'ç”¨æˆ·', 'text');
                safeSetElement('user-rank-header', 'è§’è‰²', 'text');
                safeSetElement('user-account-balance', 'Â¥0', 'text');
                safeSetElement('user-location', 'æœªçŸ¥ä½ç½®', 'text');
                
                // ç¡®ä¿æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸
                setupCollapse();
                setupTabs();
                
                // æ˜¾ç¤ºåŸºæœ¬æ¨¡å¼æç¤º
                const container = document.getElementById('status-main');
                if (container) {
                    const warningDiv = document.createElement('div');
                    warningDiv.style.cssText = 'background: #ff9800; color: white; padding: 8px; margin: 5px; border-radius: 5px; text-align: center; font-size: 0.9em;';
                    warningDiv.innerHTML = 'âš ï¸ ç®€åŒ–æ¨¡å¼ï¼šæ•°æ®åŠ è½½å¼‚å¸¸ï¼Œå·²å¯ç”¨åŸºæœ¬åŠŸèƒ½';
                    container.insertBefore(warningDiv, container.firstChild);
                }
                
                console.log('åŸºæœ¬æ¨¡å¼åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('è¿åŸºæœ¬æ¨¡å¼éƒ½å¤±è´¥äº†:', error);
            }
        }

        // æ˜¾ç¤ºåŸºæœ¬ç•Œé¢ï¼ˆè¶…æ—¶åçš„å¤‡ç”¨æ–¹æ¡ˆï¼‰
        function showBasicInterface() {
            console.warn('æ˜¾ç¤ºåŸºæœ¬ç•Œé¢ - æ•°æ®å¤„ç†è¶…æ—¶');
            try {
                // æ¸…ç†å¯èƒ½çš„é”™è¯¯çŠ¶æ€
                const container = document.getElementById('status-main');
                if (container) {
                    container.classList.remove('collapsed'); // ç¡®ä¿å¯ä»¥çœ‹åˆ°å†…å®¹
                }
                
                // è°ƒç”¨åŸºæœ¬æ¨¡å¼
                initBasicMode();
                
            } catch (error) {
                console.error('æ˜¾ç¤ºåŸºæœ¬ç•Œé¢å¤±è´¥:', error);
                // æœ€åçš„å¤‡ç”¨æ–¹æ¡ˆ
                const container = document.getElementById('status-main');
                if (container) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: white;">çŠ¶æ€æ åŠ è½½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
                }
            }
        }

        // å®‰å…¨çš„DOMæ“ä½œå‡½æ•°
        function safeSetElement(elementId, value, operation = 'text') {
            try {
                const element = document.getElementById(elementId);
                if (!element) {
                    console.error(`DOMå…ƒç´ ä¸å­˜åœ¨: ${elementId}`);
                    showUserFriendlyError('é¡µé¢å…ƒç´ ç¼ºå¤±', `ç¼ºå°‘å…ƒç´ ID: ${elementId}`, 'è¯·æ£€æŸ¥é¡µé¢æ˜¯å¦å®Œæ•´åŠ è½½ï¼Œæˆ–å°è¯•åˆ·æ–°é¡µé¢');
                    return false;
                }
                
                switch(operation) {
                    case 'text':
                        // æ­£ç¡®å¤„ç†æ•°å€¼0ï¼šåªæœ‰åœ¨å€¼ä¸ºnullã€undefinedæˆ–ç©ºå­—ç¬¦ä¸²æ—¶æ‰æ˜¾ç¤º'null'
                        element.innerText = (value !== null && value !== undefined && value !== '') ? value : 'null';
                        break;
                    case 'html':
                        // æ­£ç¡®å¤„ç†æ•°å€¼0ï¼šåªæœ‰åœ¨å€¼ä¸ºnullã€undefinedæˆ–ç©ºå­—ç¬¦ä¸²æ—¶æ‰æ˜¾ç¤º'null'
                        element.innerHTML = (value !== null && value !== undefined && value !== '') ? value : 'null';
                        break;
                    case 'src':
                        if (elementId.includes('user-avatar') && (!value || value === '-')) {
                            element.src = 'https://i.postimg.cc/yxzb66xk/Weixin-Image-20250827032229.jpg';
                        } else {
                            element.src = value || '';
                        }
                        // æ·»åŠ å›¾ç‰‡åŠ è½½é”™è¯¯å¤„ç†
                        element.onerror = function() {
                            if (elementId.includes('user-avatar')) {
                                this.src = 'https://i.postimg.cc/yxzb66xk/Weixin-Image-20250827032229.jpg';
                            }
                        };
                        break;
                    default:
                        // æ­£ç¡®å¤„ç†æ•°å€¼0ï¼šåªæœ‰åœ¨å€¼ä¸ºnullã€undefinedæˆ–ç©ºå­—ç¬¦ä¸²æ—¶æ‰æ˜¾ç¤º'null'
                        element.innerText = (value !== null && value !== undefined && value !== '') ? value : 'null';
                }
                return true;
            } catch (error) {
                console.error(`è®¾ç½®å…ƒç´ ${elementId}æ—¶å‡ºé”™:`, error);
                showUserFriendlyError('å…ƒç´ è®¾ç½®é”™è¯¯', `æ— æ³•è®¾ç½®å…ƒç´  ${elementId}: ${error.message}`, 'è¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–é‡æ–°ç”Ÿæˆæ•°æ®');
                return false;
            }
        }

        // å®‰å…¨çš„æ•°å€¼å¤„ç†å‡½æ•°
        function safeProcessNumber(value, elementId, context = '') {
            try {
                // æ³¨æ„ï¼š0æ˜¯æœ‰æ•ˆæ•°å€¼ï¼Œä¸åº”è¯¥è¢«è§†ä¸ºç©ºå€¼
                if (value === null || value === undefined || value === '') {
                    console.warn(`æ•°å€¼ä¸ºç©º - ${context} (${elementId})`);
                    return 0;
                }
                
                const numValue = Number(value);
                if (isNaN(numValue)) {
                    console.error(`æ•°å€¼è½¬æ¢å¤±è´¥ - ${context} (${elementId}), åŸå€¼:`, value);
                    showUserFriendlyError('æ•°æ®æ ¼å¼é”™è¯¯', `${context}çš„æ•°å€¼æ ¼å¼é”™è¯¯: ${value}`, 'è¯·å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
                    return 0;
                }
                
                return numValue;
            } catch (error) {
                console.error(`å¤„ç†æ•°å€¼æ—¶å‡ºé”™ - ${context} (${elementId}):`, error);
                showUserFriendlyError('æ•°å€¼å¤„ç†é”™è¯¯', `å¤„ç†${context}æ—¶å‡ºé”™: ${error.message}`, 'è¯·å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
                return 0;
            }
        }

        function updateProgressBar(elementId, value, max = 100) {
            try {
            const progressBar = document.getElementById(elementId);
                if (!progressBar) {
                    console.error(`è¿›åº¦æ¡å…ƒç´ ä¸å­˜åœ¨: ${elementId}`);
                    showUserFriendlyError('è¿›åº¦æ¡å…ƒç´ ç¼ºå¤±', `æ‰¾ä¸åˆ°è¿›åº¦æ¡: ${elementId}`, 'è¯·æ£€æŸ¥é¡µé¢æ˜¯å¦å®Œæ•´åŠ è½½');
                    return;
                }
                const numValue = safeProcessNumber(value, elementId, 'è¿›åº¦æ¡æ•°å€¼');
                const percentage = Math.max(0, Math.min(100, (numValue / max) * 100));
            progressBar.style.width = `${percentage}%`;
            } catch (error) {
                console.error(`æ›´æ–°è¿›åº¦æ¡${elementId}æ—¶å‡ºé”™:`, error);
                showUserFriendlyError('è¿›åº¦æ¡æ›´æ–°é”™è¯¯', `æ— æ³•æ›´æ–°è¿›åº¦æ¡ ${elementId}: ${error.message}`, 'è¯·å°è¯•åˆ·æ–°é¡µé¢');
            }
        }

        // [ä¸»é€»è¾‘å‡½æ•° - å¸¦è¶…æ—¶ä¿æŠ¤]
        function initDisplayWithTimeout() {
            console.log('å¼€å§‹åˆå§‹åŒ–çŠ¶æ€æ ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰');
            
            // è®¾ç½®è¶…æ—¶ä¿æŠ¤
            initializationTimeout = setTimeout(() => {
                console.error('æ•°æ®å¤„ç†è¶…æ—¶ï¼Œå¯åŠ¨å¤‡ç”¨æ–¹æ¡ˆ');
                showUserFriendlyError('æ•°æ®åŠ è½½è¶…æ—¶', 'æ•°æ®å¤„ç†æ—¶é—´è¿‡é•¿ï¼Œå·²åœæ­¢åŠ è½½', 'å·²å¯ç”¨åŸºæœ¬åŠŸèƒ½ï¼Œå»ºè®®é‡æ–°ç”Ÿæˆæ›´ç®€å•çš„çŠ¶æ€æ•°æ®');
                showBasicInterface();
            }, 15000); // 15ç§’è¶…æ—¶
            
            try {
                initDisplay();
                clearTimeout(initializationTimeout); // æˆåŠŸåˆ™æ¸…é™¤è¶…æ—¶
                console.log('çŠ¶æ€æ åˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                clearTimeout(initializationTimeout);
                console.error('çŠ¶æ€æ åˆå§‹åŒ–å¤±è´¥:', error);
                throw error;
            }
        }

        // [å¸¦é™çº§æ¨¡å¼çš„åˆå§‹åŒ–]
        function initDisplayWithFallback() {
            try {
                // å°è¯•å®Œæ•´åŠ è½½
                initDisplayWithTimeout();
            } catch (error) {
                console.warn('å®Œæ•´åŠ è½½å¤±è´¥ï¼Œå¯ç”¨é™çº§æ¨¡å¼:', error);
                showUserFriendlyError('å¯ç”¨ç®€åŒ–æ¨¡å¼', 'æ•°æ®æœ‰é—®é¢˜ï¼Œå·²åˆ‡æ¢åˆ°ç®€åŒ–æ˜¾ç¤ºæ¨¡å¼', 'çŠ¶æ€æ ä»å¯æ­£å¸¸ä½¿ç”¨ï¼Œå»ºè®®é‡æ–°ç”Ÿæˆæ•°æ®');
                
                // é™çº§åˆ°åŸºæœ¬åŠŸèƒ½
                initBasicMode();
            }
        }

        // [å¾ªç¯ä¿æŠ¤çš„å®‰å…¨åˆå§‹åŒ–]
        function safeInitDisplay() {
            processingCount++;
            console.log(`çŠ¶æ€æ åˆå§‹åŒ–å°è¯• #${processingCount}`);
            
            if (processingCount > MAX_PROCESSING_COUNT) {
                console.error('å¤„ç†æ¬¡æ•°è¿‡å¤šï¼Œåœæ­¢é‡è¯•');
                showUserFriendlyError('å¤„ç†æ¬¡æ•°è¿‡å¤š', 'æ£€æµ‹åˆ°å¯èƒ½çš„æ— é™å¾ªç¯ï¼Œå·²åœæ­¢å¤„ç†', 'è¯·åˆ·æ–°é¡µé¢é‡è¯•');
                showBasicInterface();
                return;
            }
            
            try {
                initDisplayWithFallback();
                processingCount = 0; // æˆåŠŸåé‡ç½®è®¡æ•°
                console.log('çŠ¶æ€æ åˆå§‹åŒ–æˆåŠŸå®Œæˆ');
            } catch (error) {
                console.error(`ç¬¬${processingCount}æ¬¡åˆå§‹åŒ–å¤±è´¥:`, error);
                if (processingCount < MAX_PROCESSING_COUNT) {
                    console.warn(`å°†åœ¨1ç§’åè¿›è¡Œç¬¬${processingCount + 1}æ¬¡å°è¯•...`);
                    setTimeout(safeInitDisplay, 1000); // å»¶è¿Ÿé‡è¯•
                } else {
                    console.error('é‡è¯•æ¬¡æ•°è€—å°½');
                    showUserFriendlyError('é‡è¯•æ¬¡æ•°è€—å°½', 'å¤šæ¬¡å°è¯•å¤±è´¥ï¼Œå·²åœæ­¢é‡è¯•', 'è¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥æ•°æ®æ ¼å¼');
                    showBasicInterface();
                }
            }
        }

        // [é˜²æ­¢é‡å¤è°ƒç”¨çš„ä¿æŠ¤åˆå§‹åŒ–]
        function protectedInitDisplay() {
            const now = Date.now();
            
            // é˜²æ­¢çŸ­æ—¶é—´å†…é‡å¤è°ƒç”¨
            if (isProcessing || (now - lastProcessTime < 3000)) {
                console.warn('æ•°æ®å¤„ç†æ­£åœ¨è¿›è¡Œä¸­æˆ–åˆšåˆšå®Œæˆï¼Œè·³è¿‡æœ¬æ¬¡è°ƒç”¨');
                return;
            }
            
            isProcessing = true;
            lastProcessTime = now;
            console.log('å¼€å§‹å—ä¿æŠ¤çš„çŠ¶æ€æ åˆå§‹åŒ–');
            
            try {
                safeInitDisplay();
            } catch (error) {
                console.error('å—ä¿æŠ¤åˆå§‹åŒ–å¤±è´¥:', error);
                showUserFriendlyError('æ•°æ®å¤„ç†å¼‚å¸¸', error.message, 'å·²åœæ­¢å¤„ç†ï¼Œè¯·ç¨åé‡è¯•');
                showBasicInterface();
            } finally {
                isProcessing = false;
                console.log('å—ä¿æŠ¤åˆå§‹åŒ–å®Œæˆ');
            }
        }

        // [åŸå§‹ä¸»é€»è¾‘å‡½æ•°]
        function initDisplay() {
            let hasErrors = false;
            try {
                // ç¡®ä¿ getChatMessages å’Œ getCurrentMessageId å‡½æ•°å¯ç”¨
                if (typeof getChatMessages !== 'function' || typeof getCurrentMessageId !== 'function') {
                     console.error("æ ¸å¿ƒå‡½æ•° getChatMessages æˆ– getCurrentMessageId æœªå®šä¹‰ã€‚");
                     showUserFriendlyError('ç³»ç»Ÿå‡½æ•°ç¼ºå¤±', 'SillyTavernç¯å¢ƒå‡½æ•°æœªåŠ è½½', 'è¯·ç¡®ä¿åœ¨SillyTavernä¸­æ­£ç¡®åŠ è½½æ­¤çŠ¶æ€æ ï¼Œæˆ–åˆ·æ–°é¡µé¢é‡è¯•');
                     // åœ¨æµè§ˆå™¨ä¸­è¿è¡Œæ—¶ï¼Œæä¾›ä¸€äº›æ¨¡æ‹Ÿæ•°æ®ä»¥ä¾¿äºæµ‹è¯•UI
                     if (typeof window !== 'undefined') {
                         console.log("æ­£åœ¨ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡ŒUIæµ‹è¯•ã€‚");
                         const mockData = {
                            "ç”¨æˆ·": {
                                "å¤´åƒé“¾æ¥": ["https://i.postimg.cc/yYz9V0q9/ai-gen-art-girl-anime-style-2.jpg"],
                                "å§“å": ["æ—æ˜Ÿè¾°"],
                                "èŒä¸š": ["äºŒçº¿æ˜æ˜Ÿ"],
                                "è´¦æˆ·ä½™é¢": [2580000],
                                "ä½ç½®": ["åŒ—äº¬å½±è§†åŸ"],
                                "è¡£ç€": ["é«˜å®šç¤¼æœ"],
                                "å¦†å®¹": ["ç²¾è‡´å¦†å®¹"],
                                "è¡Œä¸º": ["æ‹æ‘„ä¸­"],
                                "æ€§æ¬²å€¼": [45],
                                "åŠ›é‡": [20],
                                "ä½“è´¨": [36],
                                "æ•æ·": [46],
                                "æ™ºåŠ›": [23],
                                "æ„å¿—": [28],
                                "æ„ŸçŸ¥": [16],
                                "é­…åŠ›": [41],
                                "è¿æ°”": [30],
                                "é£è¯„": [46],
                                "è¡Œä¸šåœ°ä½": [44],
                                "æ¼”æŠ€": [48],
                                "å”±åŠŸ": [25],
                                "èˆè¹ˆ": [43],
                                "ç»¼è‰ºæ„Ÿ": [35],
                                "å•†ä¸šä»·å€¼": [31],
                                "åˆ›ä½œèƒ½åŠ›": [37],
                                "å•†ä¸šèƒ½åŠ›": [15],
                                "å­¦ä¹ èƒ½åŠ›": [41],
                                "è‰²æ¬²": [23],
                                "æ—¥ç¨‹å®‰æ’": ["æ˜æ—¥ï¼šã€Šæ˜Ÿå…‰å¤§é“ã€‹å½•åˆ¶"],
                                "å½“å‰ä»»åŠ¡": ["æå‡æ¼”æŠ€è‡³90åˆ†"],
                                "æ—¶é—´": ["20:45"],
                                "æ—¥æœŸ": ["2024/08/15"],
                                "å¤‡å¿˜å½•": ["æ™šé¥­åè®°å¾—å»å¥èº«æˆ¿ã€‚"]
                            },
                            "å½“å‰å·¥ä½œé¡¹ç›®": {
                                "é¡¹ç›®åç§°": ["ã€Šæ¢¦æƒ³ä¹‹å…‰ã€‹"],
                                "é¡¹ç›®ç±»å‹": ["ç”µå½±"],
                                "é¡¹ç›®è¯„çº§": ["A"],
                                "é¡¹ç›®ç®€ä»‹": ["ä¸€éƒ¨è®²è¿°å¹´è½»äººè¿½æ±‚æ¢¦æƒ³çš„åŠ±å¿—ç”µå½±ï¼Œè®²è¿°äº†ä¸€ä¸ªæ™®é€šå¥³å­©é€šè¿‡è‡ªå·±çš„åŠªåŠ›å’ŒåšæŒï¼Œæœ€ç»ˆåœ¨æ¼”è‰ºåœˆé—¯å‡ºä¸€ç‰‡å¤©åœ°çš„æ•…äº‹ã€‚"],
                                "é¡¹ç›®æµç¨‹": ["æµ·é€‰è¯•é•œ -> ç­¾è®¢åˆçº¦ -> è¿›ç»„æ‹æ‘„ -> åæœŸåˆ¶ä½œ -> å®£ä¼ æ¨å¹¿ -> ä¸Šæ˜ "],
                                "å½“å‰è¿›åº¦": ["è¿›ç»„æ‹æ‘„"],
                                "ç”¨æˆ·èŒè´£": ["å¥³ä¸»è§’"],
                                "åŸºç¡€é…¬åŠ³": [1500000],
                                "é™„åŠ é…¬åŠ³": ["ç¥¨æˆ¿åˆ†æˆ2%"]
                            },
                            "é€‰é¡¹": {
                                "è¡Œä¸ºä¸€": {
                                    "è¡Œä¸º": ["å¼ºè¡Œæ¥è§¦ä¸€ä½æœ‰æ½œåŠ›ä½†èº«é™·åˆçº¦çº çº·çš„æ–°äººï¼Œè¯•å›¾ç”¨ç©ºæ‰‹å¥—ç™½ç‹¼çš„æ–¹å¼å°†å…¶ç­¾ä¸‹ã€‚"],
                                    "åˆ¤å®šå±æ€§": ["å•†ä¸šèƒ½åŠ›/é­…åŠ›/è¿æ°”"]
                                },
                                "è¡Œä¸ºäºŒ": {
                                    "è¡Œä¸º": ["é—­é—¨ä¸å‡ºï¼Œæ ¹æ®æœ€è¿‘çš„å¸‚åœºè¶‹åŠ¿ï¼Œå¼€å§‹æ„æ€ä¸€éƒ¨ä½æˆæœ¬é«˜æ¦‚å¿µçš„ç½‘ç»œå‰§å‰§æœ¬ï¼Œå¸Œæœ›èƒ½ä¸€é¸£æƒŠäººã€‚"],
                                    "åˆ¤å®šå±æ€§": ["åˆ›ä½œèƒ½åŠ›/æ™ºåŠ›/æ„å¿—"]
                                },
                                "è¡Œä¸ºä¸‰": {
                                    "è¡Œä¸º": ["æ½œå…¥ä¸€åœºä¸å¯¹å¤–å¼€æ”¾çš„ä¸šå†…å¤§ä½¬é¥­å±€ï¼Œè¯•å›¾é€šè¿‡è¡¨ç°è‡ªå·±ï¼Œç»“è¯†èƒ½æ”¹å˜å‘½è¿çš„è´µäººã€‚"],
                                    "åˆ¤å®šå±æ€§": ["æ„ŸçŸ¥/é­…åŠ›/éœè°¨å¥½æ„Ÿåº¦"]
                                },
                                "è¡Œä¸ºå››": {
                                    "è¡Œä¸º": ["è”ç³»é»‘å¸‚æƒ…æŠ¥è´©å­ï¼Œå‡†å¤‡å‡ºå–ä½ æ‰€çŸ¥çš„ä¸€ä¸ªå‰ä¸œå®¶çš„å•†ä¸šç§˜å¯†ï¼Œæ¢å–ä¸€ç¬”æ•‘æ€¥çš„ç°é‡‘ã€‚"],
                                    "åˆ¤å®šå±æ€§": ["æ„å¿—/å•†ä¸šèƒ½åŠ›"]
                                }
                            },
                            "ç§¦å€¦": {
                                "å¤´åƒé“¾æ¥": ["https://i.postimg.cc/kX4SALfF/1.jpg"],
                                "å¥½æ„Ÿåº¦": [72],
                                "æ€§æ¬²å€¼": [35],
                                "ä½ç½®": ["å…¬å¸åŠå…¬å®¤"],
                                "è¡£ç€": ["é»‘è‰²è¥¿è£…"],
                                "è¡Œä¸º": ["å¤„ç†æ–‡ä»¶"],
                                "å¿ƒç†æ´»åŠ¨": ["å¯¹ä½ äº§ç”Ÿäº†å…´è¶£"]
                            },
                            "é›¶": {
                                "å¤´åƒé“¾æ¥": ["https://i.postimg.cc/tJ7Z6S3L/2.jpg"],
                                "å¥½æ„Ÿåº¦": [20],
                                "æ€§æ¬²å€¼": [0],
                                "ä½ç½®": ["ç”¨æˆ·è„‘æµ·"],
                                "è¡£ç€": ["æœªçŸ¥"],
                                "è¡Œä¸º": ["ä»¥å£°éŸ³å½¢å¼æä¾›å¼•å¯¼"],
                                "å¿ƒç†æ´»åŠ¨": ["å¸®åŠ©å®¿ä¸»æ˜¯æˆ‘çš„ä½¿å‘½ã€‚"]
                            },
                            "éœè°¨": {
                                "å¤´åƒé“¾æ¥": ["https://i.postimg.cc/T1B4x3rY/3.jpg"],
                                "å¥½æ„Ÿåº¦": [15],
                                "æ€§æ¬²å€¼": [10],
                                "ä½ç½®": ["åŠå…¬å®¤"],
                                "è¡£ç€": ["è¥¿è£…"],
                                "è¡Œä¸º": ["å®¡é˜…æ–‡ä»¶"],
                                "å¿ƒç†æ´»åŠ¨": ["è¿™ä¸ªæ–°äººæœ‰ç‚¹æ„æ€ã€‚"]
                            },
                            "å¤é˜³": {
                                "å¤´åƒé“¾æ¥": ["https://i.postimg.cc/W1Yp5GzQ/4.jpg"],
                                "å¥½æ„Ÿåº¦": [5],
                                "æ€§æ¬²å€¼": [5],
                                "ä½ç½®": ["ç‰‡åœº"],
                                "è¡£ç€": ["æ ¡æœ"],
                                "è¡Œä¸º": ["æ‹æ‘„ä¸­"],
                                "å¿ƒç†æ´»åŠ¨": ["å¸Œæœ›èƒ½ä¸€æ¬¡é€šè¿‡ã€‚"]
                            },
                            "æ¸©å±¿": {
                                "å¤´åƒé“¾æ¥": ["https://i.postimg.cc/Pq53D5gB/5.jpg"],
                                "å¥½æ„Ÿåº¦": [10],
                                "æ€§æ¬²å€¼": [0],
                                "ä½ç½®": ["åå°"],
                                "è¡£ç€": ["ä¼‘é—²è£…"],
                                "è¡Œä¸º": ["é—­ç›®å…»ç¥"],
                                "å¿ƒç†æ´»åŠ¨": ["æ¥ä¸‹æ¥æ˜¯æˆ‘çš„èˆå°äº†ã€‚"]
                            },
                            "æœæ²é›¨": {
                                "å¤´åƒé“¾æ¥": ["https://i.postimg.cc/qR0C9kC3/6.jpg"],
                                "å¥½æ„Ÿåº¦": [20],
                                "æ€§æ¬²å€¼": [0],
                                "ä½ç½®": ["æœªçŸ¥"],
                                "è¡£ç€": ["æœªçŸ¥"],
                                "è¡Œä¸º": ["æœªçŸ¥"],
                                "å¿ƒç†æ´»åŠ¨": ["æœªçŸ¥"]
                            },
                            "äººè„‰": {
                               "ç§¦å€¦": ["ã€æè¿°ã€‘æ˜Ÿè¾°å¨±ä¹å…¬å¸æ€»è£ï¼Œå†·é™ç†æ€§ï¼Œå¤–è¡¨ä¿Šç¾ä½†å¸¦ç€ç¥ç§˜çš„çœ¼ç½©ï¼Œæ€»æ˜¯ç©¿ç€å¾—ä½“çš„é»‘è‰²è¥¿è£…\nã€å…³ç³»ã€‘ä¸Šå¸å…³ç³»ï¼Œæœ€è¿‘å¯¹ä½ è¡¨ç°å‡ºç‰¹åˆ«çš„å…³æ³¨\nã€å…³é”®äº‹ä»¶ã€‘åœ¨å…¬å¸å¹´ä¼šä¸Šä¸ºä½ æŒ¡é…’ï¼Œå±•ç°å‡ºä¿æŠ¤æ¬²\nã€å…¶ä»–ã€‘ä¼¼ä¹å¯¹ä½ æœ‰ç€è¶…å‡ºå·¥ä½œèŒƒå›´çš„ç‰¹æ®Šæ„Ÿæƒ…"],
                               "è‹é›¨è–‡": ["ã€æè¿°ã€‘å½“çº¢ä¸€çº¿å¥³æ˜Ÿï¼Œæ€§æ ¼é«˜å‚²ä½†å†…å¿ƒè„†å¼±ï¼Œæ‹¥æœ‰å®Œç¾çš„å¤–è²Œå’Œå‡ºè‰²çš„æ¼”æŠ€\nã€å…³ç³»ã€‘ç«äº‰å¯¹æ‰‹ï¼Œè¡¨é¢å’Œç¦ä½†æš—ä¸­è¾ƒåŠ²\nã€å…³é”®äº‹ä»¶ã€‘åœ¨ã€Šæ˜Ÿå…‰å¤§é“ã€‹å½•åˆ¶æ—¶æ•…æ„æŠ¢å¤ºä½ çš„é•œå¤´\nã€å…¶ä»–ã€‘èƒŒåæœ‰å¼ºå¤§çš„é‡‘ä¸»æ”¯æŒï¼Œä¸å®¹å°è§‘"],
                               "å¼ å¯¼æ¼”": ["ã€æè¿°ã€‘çŸ¥åå¯¼æ¼”ï¼Œè„¾æ°”ç«çˆ†ä½†çœ¼å…‰ç‹¬åˆ°ï¼Œåœ¨åœˆå†…æœ‰å¾ˆé«˜çš„å¨æœ›å’Œå½±å“åŠ›\nã€å…³ç³»ã€‘åˆä½œä¼™ä¼´ï¼Œå¯¹ä½ çš„æ¼”æŠ€é¢‡ä¸ºè®¤å¯\nã€å…³é”®äº‹ä»¶ã€‘ä¸»åŠ¨é‚€è¯·ä½ å‡ºæ¼”æ–°ç”µå½±ã€Šæ¢¦æƒ³ä¹‹å…‰ã€‹çš„å¥³ä¸»è§’\nã€å…¶ä»–ã€‘æ­£åœ¨ç­¹å¤‡ä¸€éƒ¨å¤§åˆ¶ä½œç”µå½±ï¼Œå¯èƒ½æ˜¯ä½ çš„æœºä¼š"],
                               "å°åŠ©ç†é˜¿ç¾": ["ã€æè¿°ã€‘ä½ çš„è´´èº«åŠ©ç†ï¼Œæ€§æ ¼å¼€æœ—æ´»æ³¼ï¼Œå¯¹ä½ å¿ å¿ƒè€¿-è€¿ï¼Œæ˜¯ä½ åœˆå†…æœ€ä¿¡ä»»çš„äºº\nã€å…³ç³»ã€‘å¿ å®åŠ©æ‰‹å’Œæœ‹å‹ï¼Œæ— è¯ä¸è°ˆçš„é—ºèœœ\nã€å…³é”®äº‹ä»¶ã€‘åœ¨ä½ æœ€ä½è°·æ—¶ä¾ç„¶é€‰æ‹©ç•™åœ¨ä½ èº«è¾¹æ”¯æŒä½ \nã€å…¶ä»–ã€‘å®¶å¢ƒæ™®é€šï¼ŒæŠŠè¿™ä»½å·¥ä½œçœ‹å¾—å¾ˆé‡è¦"],
                               "ç»çºªäººç‹å§": ["ã€æè¿°ã€‘èµ„æ·±ç»çºªäººï¼Œæ‰‹æ®µè€ç»ƒï¼Œäººè„‰å¹¿æ³›ï¼Œä½†æœ‰æ—¶è¿‡äºç°å®å’ŒåŠŸåˆ©\nã€å…³ç³»ã€‘äº‹ä¸šä¸Šçš„é¢†è·¯äººï¼Œä½†ä½ ä»¬ä¹‹é—´å­˜åœ¨åˆ†æ­§\nã€å…³é”®äº‹ä»¶ã€‘ä¸ºäº†å…¬å¸åˆ©ç›Šï¼Œæ›¾è¯•å›¾è®©ä½ æ¥å—ä¸€ä¸ªä½ ä¸å–œæ¬¢çš„ä»£è¨€\nã€å…¶ä»–ã€‘æŒæ¡ç€ä½ æœªæ¥å‘å±•çš„å…³é”®èµ„æº"]
                            },
                             "åœ°å›¾": {
                                "å®¶": ["é™‹å®¤", "ä¸€ä¸ªä½äºè€æ—§å°åŒºçš„é¡¶å±‚å…¬å¯“ï¼Œé¢ç§¯ç‹­å°ï¼Œä½†è¢«ä½ æ‰“ç†å¾—äº•äº•æœ‰æ¡ï¼Œå……æ»¡äº†ç”Ÿæ´»æ°”æ¯ï¼Œæ˜¯ä½ åœ¨è¿™ä¸ªç¹åéƒ½å¸‚é‡Œå”¯ä¸€çš„é¿é£æ¸¯ã€‚"],
                                "ç‡•äº¬å¸‚": {
                                    "æè¿°": "å›½å®¶æ–‡åŒ–ã€æ”¿æ²»ä¸­å¿ƒã€‚ä¼ ç»Ÿå½±è§†åœˆä¸ä¸»æµåª’ä½“çš„æ ¸å¿ƒåœ°å¸¦ã€‚åº„é‡ã€ä¸¥è°¨ï¼Œäººæƒ…ç¤¾ä¼šä¸æƒåŠ›å…³ç³»ç½‘çš„ä¸­å¿ƒã€‚",
                                    "åæ ‡": "25%,48%",
                                    "åæ˜Ÿå¨±ä¹": { "æè¿°": "ã€åæ˜Ÿå¨±ä¹ã€‘çš„æ€»éƒ¨ï¼Œä½äºç‡•äº¬å¸‚å¸‚ä¸­å¿ƒå•†åŠ¡åŒºçš„æ ‡å¿—æ€§å»ºç­‘ã€‚", "çŠ¶æ€": "æ­£å¸¸è¿è¥", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] },
                                    "ç‡•äº¬ç”µå½±å‚": { "æè¿°": "å›½å†…æœ€å¤§çš„å›½æœ‰ç”µå½±åˆ¶ç‰‡åŸºåœ°ä¹‹ä¸€ï¼Œæ‹¥æœ‰å¤šä¸ªå¹´ä»£çš„å®æ™¯æ‹æ‘„åœºåœ°ã€‚", "çŠ¶æ€": "å¤šä¸ªå‰§ç»„æ‹æ‘„ä¸­", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] },
                                    "å›½å®¶å¤§å‰§é™¢": { "æè¿°": "å›½å†…ç”µå½±ç•Œæœ€é«˜è£èª‰ã€é‡‘å‡¤å¥–ã€‘çš„æŒ‡å®šä¸¾åŠåœ°ç‚¹ã€‚", "çŠ¶æ€": "ä¼‘é¦†", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] },
                                    "è²ä¼šæ‰€": { "æè¿°": "ä¸€å®¶ä¸å¯¹å¤–å¼€æ”¾çš„ç§å¯†ä¸­å¼ä¼šæ‰€ï¼Œäº¬åœˆæ ¸å¿ƒäººç‰©çš„ç¤¾äº¤åœºæ‰€ã€‚", "çŠ¶æ€": "ä»…å¯¹ä¼šå‘˜å¼€æ”¾", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] }
                                },
                                "ç”³æµ·å¸‚": {
                                    "æè¿°": "å›½é™…åŒ–é‡‘èã€æ—¶å°šä¸è´¸æ˜“ä¸­å¿ƒã€‚å¶åƒäº§ä¸šã€ç²‰ä¸ç»æµä¸æ–°å…´èµ„æœ¬çš„å¤§æœ¬è¥ã€‚ç°ä»£ã€æµ®åï¼Œå•†ä¸šæ°”æ¯æµ“åšï¼Œä¸€åˆ‡çš†å¯é‡åŒ–ä¸ºä»·å€¼ã€‚",
                                    "åæ ‡": "38%,82%",
                                    "ç’€ç’¨æ—¶ä»£": { "æè¿°": "é›†åŠå…¬ã€è®­ç»ƒã€å½•éŸ³ã€ç›´æ’­ä¸ºä¸€ä½“çš„ç°ä»£åŒ–ç»¼åˆæ¥¼ã€‚", "çŠ¶æ€": "ç»ƒä¹ ç”ŸæŒ¥æ´’æ±—æ°´ä¸­", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] },
                                    "äº‘å·…èµ„æœ¬": { "æè¿°": "ä½äºç”³æµ·å¸‚ç¯çƒé‡‘èä¸­å¿ƒé¡¶å±‚ï¼Œã€äº‘å·…èµ„æœ¬ã€‘çš„å¯¹å¤–è”ç»œç‚¹ä¹‹ä¸€ã€‚", "çŠ¶æ€": "æ­£å¸¸è¿ä½œ", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] },
                                    "å¯†é˜ä¿±ä¹éƒ¨": { "æè¿°": "ä½äºç”³æµ·å¸‚å¤–æ»©å†å²å»ºç­‘å†…çš„é¡¶çº§ç§äººä¿±ä¹éƒ¨ã€‚", "çŠ¶æ€": "ä»…å¯¹ä¼šå‘˜å¼€æ”¾", "å¯è§¦å‘äº‹ä»¶": ["- å‚åŠ ä¸€åœºæ…ˆå–„æ™šå®´\n- ç»“è¯†ä¸€ä½é‡‘èå¤§é³„"] },
                                    "ç”³æµ·å±•è§ˆä¸­å¿ƒ": { "æè¿°": "ç”³æµ·å¸‚æ‰¿åŠå¤§å‹æ´»åŠ¨çš„å¤šåŠŸèƒ½åœºé¦†ï¼Œä¾‹å¦‚æ—¶è£…å‘¨ï¼Œæ˜Ÿå…‰ç››å…¸ç­‰ã€‚", "çŠ¶æ€": "æš‚æ— å¤§å‹æ´»åŠ¨", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] }
                                },
                                "æ¨ªåŸ": {
                                    "æè¿°": "å…¨çƒæœ€å¤§çš„å½±è§†å®æ™¯æ‹æ‘„åŸºåœ°ï¼Œè¢«èª‰ä¸º\"ä¸œæ–¹å¥½è±å\"ã€‚é¾™è›‡æ··æ‚ï¼Œå……æ»¡æœºé‡ä¸æ··ä¹±ã€‚å‰§ç»„æ–‡åŒ–æ˜¯è¿™é‡Œçš„å”¯ä¸€æ³•åˆ™ã€‚",
                                    "åæ ‡": "50%,15%",
                                    "æ¨ªåŸå½±è§†åŸ": { "æè¿°": "æ¨ªåŸçš„æ ¸å¿ƒæ‹æ‘„åŒºåŸŸï¼Œæ‹¥æœ‰ä»ç§¦æ±‰å®«æ®¿åˆ°æ˜æ¸…å¸‚äº•ç­‰å¤šç§é£æ ¼çš„å»ºç­‘ç¾¤ã€‚", "çŠ¶æ€": "é¾™è›‡æ··æ‚", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] },
                                    "æ¼”å‘˜å…¬ç¤¾": { "æè¿°": "ä¸ºå¤§é‡æœªç­¾çº¦çš„\"æ¨ªæ¼‚\"æ¼”å‘˜æä¾›ç™»è®°ã€æ¥æ´»æœåŠ¡çš„éå®˜æ–¹ç»„ç»‡ã€‚", "çŠ¶æ€": "äººæ»¡ä¸ºæ‚£", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] },
                                    "æ¨ªåŸå¤§é…’åº—": { "æè¿°": "æ¨ªåŸæœ€é«˜æ¡£çš„é…’åº—ï¼Œé€šå¸¸ä¸ºå¤§å‰§ç»„çš„ä¸»åˆ›äººå‘˜ä¸‹æ¦»ä¹‹å¤„ã€‚", "çŠ¶æ€": "å®‰ä¿æ£®ä¸¥", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] }
                                },
                                "æ¸¯åŸ": {
                                    "æè¿°": "äºšæ´²å¨±ä¹äº§ä¸šçš„é‡è¦æ¢çº½ä¹‹ä¸€ï¼Œæ‹¥æœ‰æˆç†Ÿçš„ç”µå½±å·¥ä¸šä½“ç³»å’Œç‹¬ç‰¹çš„éƒ½å¸‚æ–‡åŒ–ã€‚ä¸­è¥¿æ–‡åŒ–äº¤èï¼ŒèŠ‚å¥å¿«ï¼Œæ³¨é‡æ•ˆç‡å’Œä¸“ä¸šç²¾ç¥ï¼ŒåŒæ—¶ä¹Ÿä¿ç•™ç€ä¼ ç»Ÿçš„æ±Ÿæ¹–ä¹‰æ°”ã€‚",
                                    "åæ ‡": "85%,70%",
                                    "å¤©ç©¹ä¼ åª’": { "æè¿°": "ã€å¤©ç©¹ä¼ åª’ã€‘åœ¨æ¸¯åŸè®¾ç«‹çš„åŒºåŸŸæ€»éƒ¨ã€‚", "çŠ¶æ€": "æ­£å¸¸è¿è¥", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] },
                                    "å…°æ¡‚åŠ": { "æè¿°": "æ¸¯åŸæœ€è‘—åçš„å¤œç”Ÿæ´»èšé›†åœ°ï¼Œéå¸ƒé…’å§ã€é¤å…å’Œä¿±ä¹éƒ¨ã€‚", "çŠ¶æ€": "å¤œå¹•ä¸‹ç¯ç«è¾‰ç…Œ", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] },
                                    "ç»´å¤šåˆ©äºšæ¸¯": { "æè¿°": "ä¸–ç•Œè‘—åçš„æµ·æ¸¯ï¼Œæ˜¯æ¸¯åŸçš„åœ°æ ‡æ™¯è§‚ã€‚", "çŠ¶æ€": "æ¸¸å®¢å¦‚ç»‡", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] },
                                    "WENå·¥ä½œå®¤": { "æè¿°": "é«˜çº§è®¾è®¡å¸ˆå“ç‰ŒWENçš„å·¥ä½œå®¤ã€‚", "çŠ¶æ€": "è°¢ç»æ¢è®¿", "å¯è§¦å‘äº‹ä»¶": ["- æš‚æ— "] }
                                }
                            }
                        };
                         
                         // åº”ç”¨æ¨¡æ‹Ÿæ•°æ®
                         if (mockData.ç”¨æˆ·) {
                             applyUserSpecificData(mockData.ç”¨æˆ·);
                         }
                         if (mockData.å½“å‰å·¥ä½œé¡¹ç›®) {
                             applyProjectData(mockData.å½“å‰å·¥ä½œé¡¹ç›®);
                         }
                         if (mockData.é€‰é¡¹) {
                             applyOptionsData(mockData.é€‰é¡¹, mockData);
                         }
                         if (mockData.è§’è‰²) {
                             processCharacters(mockData.è§’è‰²);
                         }
                         if (mockData.äººè„‰) {
                             applyRelationshipsData(mockData.äººè„‰);
                         }
                         if (mockData.åœ°å›¾) {
                             applyMapData(mockData.åœ°å›¾);
                         }
                     }
                return;
            }

                const messages = getChatMessages(getCurrentMessageId());
                const lastMessage = messages[messages.length - 1];
                const characterData = lastMessage?.data?.stat_data;

            if (!characterData) {
                    console.error("æœªèƒ½è·å–åˆ°'stat_data'ã€‚");
                    showUserFriendlyError('æ•°æ®è·å–å¤±è´¥', 'æ— æ³•ä»æ¶ˆæ¯ä¸­è·å–stat_dataæ•°æ®', 'è¯·ç¡®ä¿AIå·²ç”ŸæˆåŒ…å«çŠ¶æ€æ•°æ®çš„æ¶ˆæ¯ï¼Œæˆ–å°è¯•é‡æ–°ç”Ÿæˆï¼ˆé‡rollï¼‰');
                    hasErrors = true;
                    // ä¸ç›´æ¥è¿”å›ï¼Œç»§ç»­å°è¯•ç”¨ç©ºæ•°æ®åˆå§‹åŒ–ç•Œé¢
            }

            // åˆ†åˆ«å¤„ç†ç”¨æˆ·å’ŒåŠ¨æ€è§’è‰²æ•°æ®ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½æœ‰ç‹¬ç«‹çš„é”™è¯¯å¤„ç†
            if (characterData && characterData.ç”¨æˆ·) {
                try {
                applyUserSpecificData(characterData.ç”¨æˆ·);
                } catch (error) {
                    console.error("ç”¨æˆ·æ•°æ®å¤„ç†å¤±è´¥:", error);
                    showUserFriendlyError('ç”¨æˆ·æ•°æ®é”™è¯¯', `å¤„ç†ç”¨æˆ·åŸºç¡€ä¿¡æ¯æ—¶å‡ºé”™: ${error.message}`, 'è¯·æ£€æŸ¥æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
                    hasErrors = true;
            }
            }
            if (characterData && characterData.å½“å‰å·¥ä½œé¡¹ç›®) {
                try {
                applyProjectData(characterData.å½“å‰å·¥ä½œé¡¹ç›®);
                } catch (error) {
                    console.error("é¡¹ç›®æ•°æ®å¤„ç†å¤±è´¥:", error);
                    showUserFriendlyError('é¡¹ç›®æ•°æ®é”™è¯¯', `å¤„ç†å½“å‰é¡¹ç›®ä¿¡æ¯æ—¶å‡ºé”™: ${error.message}`, 'è¯·æ£€æŸ¥é¡¹ç›®æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
                    hasErrors = true;
            }
            }
            if (characterData && characterData.é€‰é¡¹) {
                try {
                applyOptionsData(characterData.é€‰é¡¹, characterData);
                } catch (error) {
                    console.error("é€‰é¡¹æ•°æ®å¤„ç†å¤±è´¥:", error);
                    showUserFriendlyError('é€‰é¡¹æ•°æ®é”™è¯¯', `å¤„ç†æ·éª°é€‰é¡¹æ—¶å‡ºé”™: ${error.message}`, 'è¯·æ£€æŸ¥é€‰é¡¹æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
                    hasErrors = true;
            }
            }
            if (characterData && characterData.è§’è‰²) {
                try {
                processCharacters(characterData.è§’è‰²);
                } catch (error) {
                    console.error("è§’è‰²æ•°æ®å¤„ç†å¤±è´¥:", error);
                    showUserFriendlyError('è§’è‰²æ•°æ®é”™è¯¯', `å¤„ç†è§’è‰²ä¿¡æ¯æ—¶å‡ºé”™: ${error.message}`, 'è¯·æ£€æŸ¥è§’è‰²æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
                    hasErrors = true;
            }
            }
            if (characterData && characterData.äººè„‰) {
                try {
                applyRelationshipsData(characterData.äººè„‰);
                } catch (error) {
                    console.error("äººè„‰æ•°æ®å¤„ç†å¤±è´¥:", error);
                    showUserFriendlyError('äººè„‰æ•°æ®é”™è¯¯', `å¤„ç†äººé™…å…³ç³»ä¿¡æ¯æ—¶å‡ºé”™: ${error.message}`, 'è¯·æ£€æŸ¥äººè„‰æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
                    hasErrors = true;
            }
            }
            if (characterData && characterData.åœ°å›¾) {
                try {
                applyMapData(characterData.åœ°å›¾);
                } catch (error) {
                    console.error("åœ°å›¾æ•°æ®å¤„ç†å¤±è´¥:", error);
                    showUserFriendlyError('åœ°å›¾æ•°æ®é”™è¯¯', `å¤„ç†åœ°å›¾ä¿¡æ¯æ—¶å‡ºé”™: ${error.message}`, 'è¯·æ£€æŸ¥åœ°å›¾æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
                    hasErrors = true;
                }
            }

            // å¦‚æœæœ‰é”™è¯¯ä½†ç•Œé¢ä»ç„¶å¯ç”¨ï¼Œæ˜¾ç¤ºæ€»ç»“ä¿¡æ¯
            if (hasErrors) {
                showUserFriendlyError('éƒ¨åˆ†æ•°æ®åŠ è½½å¼‚å¸¸', 'çŠ¶æ€æ å·²å°½åŠ›åŠ è½½å¯ç”¨æ•°æ®ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½æ˜¾ç¤ºä¸ºnull', 'å»ºè®®é‡æ–°ç”Ÿæˆå®Œæ•´çš„çŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰ä»¥è·å¾—æœ€ä½³ä½“éªŒ');
            }

        } catch (error) {
                console.error("çŠ¶æ€æ æ›´æ–°å¤±è´¥:", error);
                showUserFriendlyError('çŠ¶æ€æ ä¸¥é‡é”™è¯¯', `ç³»ç»Ÿé‡åˆ°ä¸¥é‡é”™è¯¯: ${error.message}`, 'è¯·å°è¯•åˆ·æ–°é¡µé¢ï¼Œæˆ–é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
                
                // å³ä½¿å‡ºç°ä¸¥é‡é”™è¯¯ï¼Œä¹Ÿå°è¯•ä¿æŒåŸºæœ¬ç•Œé¢å¯ç”¨
                const container = document.getElementById('status-main');
                if(container) {
                    // ä¸å®Œå…¨æ›¿æ¢å†…å®¹ï¼Œè€Œæ˜¯åœ¨é¡¶éƒ¨æ·»åŠ é”™è¯¯æç¤º
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'background: #ff4444; color: white; padding: 10px; margin: 5px; border-radius: 5px; text-align: center;';
                    errorDiv.innerHTML = 'âš ï¸ çŠ¶æ€æ é‡åˆ°é”™è¯¯ï¼Œå·²æ˜¾ç¤ºé”™è¯¯è¯¦æƒ…ï¼Œç•Œé¢ä»å¯ç»§ç»­ä½¿ç”¨';
                    container.insertBefore(errorDiv, container.firstChild);
                }
            }
        }
        
        // [DOMå®ˆæŠ¤ç¨‹åº] - é˜²æ­¢å¤–éƒ¨è„šæœ¬ç ´åDOMç»“æ„
        let domObserver = null;
        let isStructureFixed = false; // é¿å…é‡å¤ä¿®å¤
        
        function fixAccountBalanceStructure() {
            try {
                const balanceSection = document.querySelector('.account-balance-section');
                const statusContent = document.querySelector('.status-content');
                
                if (!balanceSection || !statusContent) {
                    console.warn('æ‰¾ä¸åˆ°è´¦æˆ·ä½™é¢ç›¸å…³å…ƒç´ ï¼Œè·³è¿‡ç»“æ„ä¿®å¤');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦ä¿®å¤ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰
                const currentChildren = Array.from(balanceSection.children);
                const hasCorrectStructure = (
                    currentChildren.length === 3 &&
                    balanceSection.querySelector('.balance-left') &&
                    balanceSection.querySelector('.balance-amount') &&
                    balanceSection.querySelector('.balance-decoration') &&
                    !balanceSection.querySelector('.details-grid')
                );
                
                if (hasCorrectStructure && isStructureFixed) {
                    console.log('âœ… DOMç»“æ„å·²æ­£ç¡®ï¼Œè·³è¿‡ä¿®å¤');
                    return;
                }
                
                console.log('ğŸ”§ ä¿®å¤è´¦æˆ·ä½™é¢DOMç»“æ„...');
                console.log('å½“å‰å­å…ƒç´ :', currentChildren.map(child => `${child.tagName}.${child.className}`));
                
                // å¦‚æœdetails-gridé”™è¯¯åœ°åœ¨account-balance-sectionå†…ï¼Œå°†å…¶ç§»å‡º
                const detailsGrid = balanceSection.querySelector('.details-grid');
                if (detailsGrid) {
                    console.log('âš ï¸ å‘ç°details-gridåœ¨account-balance-sectionå†…ï¼Œæ­£åœ¨ç§»å‡º...');
                    statusContent.appendChild(detailsGrid);
                }
                
                // ä¿å­˜æˆ–é‡å»ºæ­£ç¡®çš„å­å…ƒç´ 
                let balanceLeft = balanceSection.querySelector('.balance-left');
                let balanceElement = balanceSection.querySelector('#user-account-balance');
                let iconElement = balanceSection.querySelector('.icon');
                
                // æ¸…ç©ºå®¹å™¨å¹¶é‡å»ºæ­£ç¡®ç»“æ„
                console.log('ğŸ”„ é‡å»ºæ­£ç¡®çš„DOMç»“æ„...');
                balanceSection.innerHTML = '';
                
                // é‡å»ºç®€åŒ–çš„Flexå¸ƒå±€ç»“æ„
                balanceSection.innerHTML = `
                    <div class="balance-left">
                        <div class="balance-icon"></div>
                        <div class="balance-label">è´¦æˆ·ä½™é¢</div>
                    </div>
                    <div class="balance-amount">
                        <div class="property-value" id="user-account-balance">Â¥-</div>
                    </div>
                    <svg class="balance-decoration" viewBox="0 0 24 24">
                        <path d="M12 2L9.5 9.5 2 12l7.5 2.5L12 22l2.5-7.5L22 12l-7.5-2.5z"/>
                    </svg>
                `;
                console.log('âœ… å·²é‡å»ºè´¦æˆ·ä½™é¢ç»„ä»¶ä¸ºæ–°çš„ç®€åŒ–ç»“æ„');
                
                // å¼ºåˆ¶é‡æ–°è®¡ç®—Gridå¸ƒå±€
                balanceSection.style.display = 'grid';
                balanceSection.offsetHeight; // è§¦å‘é‡æ’
                
                // éªŒè¯å’Œä¿®å¤balance-leftå†…éƒ¨ç»“æ„
                setTimeout(() => {
                    const finalChildren = Array.from(balanceSection.children);
                    console.log('âœ… æ–°ç»“æ„å­å…ƒç´ :', finalChildren.map(child => `${child.tagName}.${child.className}#${child.id || 'æ— '}`));
                    
                    const computedStyle = window.getComputedStyle(balanceSection);
                    console.log('âœ… Flexå¸ƒå±€æ¨¡å¼:', computedStyle.display);
                    
                    const balanceElement = document.getElementById('user-account-balance');
                    if (balanceElement) {
                        console.log('âœ… è´¦æˆ·ä½™é¢å…ƒç´ å·²å°±ä½');
                    }
                    
                    const balanceIcon = balanceSection.querySelector('.balance-icon');
                    if (balanceIcon) {
                        console.log('âœ… é‡‘å¸å›¾æ ‡ä½¿ç”¨CSSç”Ÿæˆçš„Â¥ç¬¦å·');
                    }
                    
                    console.log('ğŸ¯ æ–°çš„è´¦æˆ·ä½™é¢ç»„ä»¶åˆå§‹åŒ–å®Œæˆ');
                }, 100);
                
                // æ ‡è®°ä¸ºå·²ä¿®å¤
                isStructureFixed = true;
                
                // å¯åŠ¨DOMå®ˆæŠ¤ç¨‹åº
                startDomGuardian();
                
                console.log('âœ… DOMç»“æ„ä¿®å¤å®Œæˆ');
                
            } catch (error) {
                console.error('DOMç»“æ„ä¿®å¤å¤±è´¥:', error);
                isStructureFixed = false; // å¤±è´¥æ—¶é‡ç½®æ ‡è®°
            }
        }
        
        // [DOMå®ˆæŠ¤ç¨‹åº] - ç›‘è§†å¹¶é˜»æ­¢å¤–éƒ¨è„šæœ¬ç ´åDOMç»“æ„
        function startDomGuardian() {
            if (domObserver) {
                domObserver.disconnect(); // æ–­å¼€ç°æœ‰è§‚å¯Ÿå™¨
            }
            
            const balanceSection = document.querySelector('.account-balance-section');
            const statusContent = document.querySelector('.status-content');
            
            if (!balanceSection || !statusContent) return;
            
            console.log('ğŸ›¡ï¸ å¯åŠ¨DOMå®ˆæŠ¤ç¨‹åº...');
            
            domObserver = new MutationObserver((mutations) => {
                // æš‚æ—¶æ–­å¼€è§‚å¯Ÿå™¨ï¼Œé˜²æ­¢ä¿®å¤æ—¶è§¦å‘é€’å½’
                domObserver.disconnect();
                
                let needsRepair = false;
                
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        // åªæ£€æŸ¥å…³é”®çš„ç»“æ„é—®é¢˜ï¼Œä¸æ£€æŸ¥å†…éƒ¨ä¿®å¤
                        const detailsGrid = balanceSection.querySelector('.details-grid');
                        if (detailsGrid) {
                            console.warn('ğŸš¨ æ£€æµ‹åˆ°DOMç ´åï¼šdetails-gridè¢«é”™è¯¯ç§»å…¥ï¼Œæ­£åœ¨ä¿®å¤...');
                            statusContent.appendChild(detailsGrid);
                            needsRepair = true;
                        }
                        
                        // æ£€æŸ¥æ–°çš„Flexå¸ƒå±€ç»“æ„
                        const currentChildren = Array.from(balanceSection.children);
                        if (currentChildren.length !== 3 || 
                            !balanceSection.querySelector('.balance-left') ||
                            !balanceSection.querySelector('#user-account-balance') ||
                            !balanceSection.querySelector('.balance-decoration')) {
                            needsRepair = true;
                        }
                    }
                });
                
                if (needsRepair) {
                    console.log('ğŸ”§ DOMå®ˆæŠ¤ç¨‹åºè§¦å‘ä¿®å¤...');
                    isStructureFixed = false;
                    fixAccountBalanceStructure();
                } else {
                    // é‡æ–°è¿æ¥è§‚å¯Ÿå™¨
                    setTimeout(() => {
                        if (domObserver) {
                            domObserver.observe(balanceSection, { childList: true, subtree: false });
                            domObserver.observe(statusContent, { childList: true, subtree: false });
                        }
                    }, 100);
                }
            });
            
            // ç›‘è§†account-balance-sectionçš„ç›´æ¥å­å…ƒç´ å˜åŒ–ï¼ˆä¸åŒ…æ‹¬subtreeï¼‰
            domObserver.observe(balanceSection, {
                childList: true,
                subtree: false  // å…³é”®ï¼šä¸ç›‘è§†å­æ ‘ï¼Œé¿å…å†…éƒ¨ä¿®æ”¹è§¦å‘å¾ªç¯
            });
            
            // ä¹Ÿç›‘è§†status-contentçš„å˜åŒ–ï¼Œé˜²æ­¢æ•´ä¸ªsectionè¢«ç§»åŠ¨
            domObserver.observe(statusContent, {
                childList: true,
                subtree: false
            });
            
            console.log('âœ… DOMå®ˆæŠ¤ç¨‹åºå·²å¯åŠ¨ï¼Œæ­£åœ¨ç›‘è§†ç»“æ„å˜åŒ–');
        }
        
        function applyUserSpecificData(userData) {
            // [é‡è¦] é¦–å…ˆä¿®å¤DOMç»“æ„
            fixAccountBalanceStructure();
            
            // [å¼€å§‹æ›´æ–°ç”¨æˆ·UIå†…å®¹]

            // 1. æ›´æ–°å¤´éƒ¨ä¿¡æ¯ (å¤´åƒ, å§“å, èŒä¸š)
            const avatarUrl = SafeGetValue(userData, 'å¤´åƒé“¾æ¥', 'https://i.postimg.cc/yxzb66xk/Weixin-Image-20250827032229.jpg');
            safeSetElement('user-avatar', avatarUrl, 'src');
            safeSetElement('user-name-header', SafeGetValue(userData, 'å§“å'), 'text');
            safeSetElement('user-rank-header', SafeGetValue(userData, 'èŒä¸š'), 'text');
            safeSetElement('user-date', SafeGetValue(userData, 'æ—¥æœŸ'), 'text');
            safeSetElement('user-time', SafeGetValue(userData, 'æ—¶é—´'), 'text');

            // 2. è´¦æˆ·ä½™é¢
            const balance = safeProcessNumber(SafeGetValue(userData, 'è´¦æˆ·ä½™é¢', 0), 'user-account-balance', 'è´¦æˆ·ä½™é¢');
            try {
                const formattedBalance = 'Â¥' + new Intl.NumberFormat('en-US').format(balance);
                safeSetElement('user-account-balance', formattedBalance, 'text');
            } catch (error) {
                console.error('è´¦æˆ·ä½™é¢æ ¼å¼åŒ–å¤±è´¥:', error);
                safeSetElement('user-account-balance', 'Â¥null', 'text');
                showUserFriendlyError('ä½™é¢æ˜¾ç¤ºé”™è¯¯', 'è´¦æˆ·ä½™é¢æ ¼å¼åŒ–å¤±è´¥', 'è¯·æ£€æŸ¥ä½™é¢æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
            }

            // 3. ä½ç½®
            safeSetElement('user-location', SafeGetValue(userData, 'ä½ç½®'), 'text');

            // 4. è¡£ç€
            safeSetElement('user-attire', SafeGetValue(userData, 'è¡£ç€'), 'text');

            // 5. å¦†å®¹
            safeSetElement('user-makeup', SafeGetValue(userData, 'å¦†å®¹'), 'text');

            // 6. è¡Œä¸º
            safeSetElement('user-behavior', SafeGetValue(userData, 'è¡Œä¸º'), 'text');

            // 7. æ€§æ¬²å€¼
            const lustValue = safeProcessNumber(SafeGetValue(userData, 'æ€§æ¬²å€¼', 0), 'user-lust-value', 'æ€§æ¬²å€¼');
            safeSetElement('user-lust-value', lustValue, 'text');

            // 8. åŸºç¡€å±æ€§æ•°å€¼
            // åŠ›é‡
            const strengthValue = safeProcessNumber(SafeGetValue(userData, 'åŠ›é‡', 0), 'user-strength-value', 'åŠ›é‡');
            safeSetElement('user-strength-value', strengthValue, 'text');
            updateProgressBar('user-strength-progress', strengthValue);

            // ä½“è´¨
            const constitutionValue = safeProcessNumber(SafeGetValue(userData, 'ä½“è´¨', 0), 'user-constitution-value', 'ä½“è´¨');
            safeSetElement('user-constitution-value', constitutionValue, 'text');
            updateProgressBar('user-constitution-progress', constitutionValue);

            // æ•æ·
            const agilityValue = safeProcessNumber(SafeGetValue(userData, 'æ•æ·', 0), 'user-agility-value', 'æ•æ·');
            safeSetElement('user-agility-value', agilityValue, 'text');
            updateProgressBar('user-agility-progress', agilityValue);

            // æ™ºåŠ›
            const intelligenceValue = safeProcessNumber(SafeGetValue(userData, 'æ™ºåŠ›', 0), 'user-intelligence-value', 'æ™ºåŠ›');
            safeSetElement('user-intelligence-value', intelligenceValue, 'text');
            updateProgressBar('user-intelligence-progress', intelligenceValue);

            // æ„å¿—
            const willValue = safeProcessNumber(SafeGetValue(userData, 'æ„å¿—', 0), 'user-will-value', 'æ„å¿—');
            safeSetElement('user-will-value', willValue, 'text');
            updateProgressBar('user-will-progress', willValue);

            // æ„ŸçŸ¥
            const perceptionValue = safeProcessNumber(SafeGetValue(userData, 'æ„ŸçŸ¥', 0), 'user-perception-value', 'æ„ŸçŸ¥');
            safeSetElement('user-perception-value', perceptionValue, 'text');
            updateProgressBar('user-perception-progress', perceptionValue);

            // é­…åŠ›
            const charismaValue = safeProcessNumber(SafeGetValue(userData, 'é­…åŠ›', 0), 'user-charisma-value', 'é­…åŠ›');
            safeSetElement('user-charisma-value', charismaValue, 'text');
            updateProgressBar('user-charisma-progress', charismaValue);

            // è¿æ°”
            const luckValue = safeProcessNumber(SafeGetValue(userData, 'è¿æ°”', 0), 'user-luck-value', 'è¿æ°”');
            safeSetElement('user-luck-value', luckValue, 'text');
            updateProgressBar('user-luck-progress', luckValue);

            // è¡Œä¸šåœ°ä½
            const industryStatusValue = safeProcessNumber(SafeGetValue(userData, 'è¡Œä¸šåœ°ä½', 0), 'user-industry-status-value', 'è¡Œä¸šåœ°ä½');
            safeSetElement('user-industry-status-value', industryStatusValue, 'text');
            updateProgressBar('user-industry-status-progress', industryStatusValue);

            // é£è¯„ (ç‰¹æ®Šå¤„ç†)
            const reputationValue = safeProcessNumber(SafeGetValue(userData, 'é£è¯„', 0), 'user-reputation-value', 'é£è¯„');
            try {
            const reputationElement = document.getElementById('user-reputation-value');
                if (reputationElement) {
            reputationElement.innerText = reputationValue;
            
            // æ ¹æ®é£è¯„å€¼è®¾ç½®ç‰¹æ®Šæ ·å¼å’Œè¿›åº¦æ¡
            if (reputationValue < 0) {
                reputationElement.classList.add('negative');
                reputationElement.classList.remove('positive');
            } else if (reputationValue > 0) {
                reputationElement.classList.add('positive');
                reputationElement.classList.remove('negative');
            } else {
                reputationElement.classList.remove('positive', 'negative');
                    }
                } else {
                    showUserFriendlyError('é£è¯„å…ƒç´ ç¼ºå¤±', 'æ‰¾ä¸åˆ°é£è¯„æ˜¾ç¤ºå…ƒç´ ', 'è¯·æ£€æŸ¥é¡µé¢æ˜¯å¦å®Œæ•´åŠ è½½');
            }
            
            // é£è¯„è¿›åº¦æ¡ç‰¹æ®Šè®¡ç®—ï¼š-100åˆ°100æ˜ å°„åˆ°0åˆ°100
            const reputationProgress = (reputationValue + 100) / 2;
            updateProgressBar('user-reputation-progress', reputationProgress);
            } catch (error) {
                console.error('é£è¯„å¤„ç†å¤±è´¥:', error);
                showUserFriendlyError('é£è¯„æ˜¾ç¤ºé”™è¯¯', `é£è¯„æ•°æ®å¤„ç†å¤±è´¥: ${error.message}`, 'è¯·æ£€æŸ¥é£è¯„æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
            }

            // 9. èƒ½åŠ›æ•°å€¼
            // æ¼”æŠ€
            const actingValue = safeProcessNumber(SafeGetValue(userData, 'æ¼”æŠ€', 0), 'user-acting-value', 'æ¼”æŠ€');
            safeSetElement('user-acting-value', actingValue, 'text');
            updateProgressBar('user-acting-progress', actingValue);

            // å”±åŠŸ
            const singingValue = safeProcessNumber(SafeGetValue(userData, 'å”±åŠŸ', 0), 'user-singing-value', 'å”±åŠŸ');
            safeSetElement('user-singing-value', singingValue, 'text');
            updateProgressBar('user-singing-progress', singingValue);

            // èˆè¹ˆ
            const dancingValue = safeProcessNumber(SafeGetValue(userData, 'èˆè¹ˆ', 0), 'user-dancing-value', 'èˆè¹ˆ');
            safeSetElement('user-dancing-value', dancingValue, 'text');
            updateProgressBar('user-dancing-progress', dancingValue);

            // ç»¼è‰ºæ„Ÿ
            const varietyValue = safeProcessNumber(SafeGetValue(userData, 'ç»¼è‰ºæ„Ÿ', 0), 'user-variety-value', 'ç»¼è‰ºæ„Ÿ');
            safeSetElement('user-variety-value', varietyValue, 'text');
            updateProgressBar('user-variety-progress', varietyValue);

            // å­¦ä¹ èƒ½åŠ›
            const learningValue = safeProcessNumber(SafeGetValue(userData, 'å­¦ä¹ èƒ½åŠ›', 0), 'user-learning-value', 'å­¦ä¹ èƒ½åŠ›');
            safeSetElement('user-learning-value', learningValue, 'text');
            updateProgressBar('user-learning-progress', learningValue);

            // å•†ä¸šä»·å€¼
            const commercialValue = safeProcessNumber(SafeGetValue(userData, 'å•†ä¸šä»·å€¼', 0), 'user-commercial-value', 'å•†ä¸šä»·å€¼');
            safeSetElement('user-commercial-value', commercialValue, 'text');
            updateProgressBar('user-commercial-progress', commercialValue);

            // åˆ›ä½œèƒ½åŠ›
            const creativityValue = safeProcessNumber(SafeGetValue(userData, 'åˆ›ä½œèƒ½åŠ›', 0), 'user-creativity-value', 'åˆ›ä½œèƒ½åŠ›');
            safeSetElement('user-creativity-value', creativityValue, 'text');
            updateProgressBar('user-creativity-progress', creativityValue);

            // å•†ä¸šèƒ½åŠ›
            const businessValue = safeProcessNumber(SafeGetValue(userData, 'å•†ä¸šèƒ½åŠ›', 0), 'user-business-value', 'å•†ä¸šèƒ½åŠ›');
            safeSetElement('user-business-value', businessValue, 'text');
            updateProgressBar('user-business-progress', businessValue);

            // è‰²æ¬²
            const lustAbilityValue = safeProcessNumber(SafeGetValue(userData, 'è‰²æ¬²', 0), 'user-desire-value', 'è‰²æ¬²');
            safeSetElement('user-desire-value', lustAbilityValue, 'text');
            updateProgressBar('user-desire-progress', lustAbilityValue);
            
            // 10. ç³»ç»Ÿé¢æ¿ - ä½¿ç”¨ innerHTML å’Œ replace æ¥å¤„ç†æ¢è¡Œç¬¦
            try {
                const scheduleText = SafeGetValue(userData, 'æ—¥ç¨‹å®‰æ’', '-');
                const formattedSchedule = (scheduleText || '-').toString().replace(/\\n|\n/g, '<br>');
                safeSetElement('user-schedule', formattedSchedule, 'html');

                const taskText = SafeGetValue(userData, 'å½“å‰ä»»åŠ¡', '-');
                const formattedTask = (taskText || '-').toString().replace(/\\n|\n/g, '<br>');
                safeSetElement('user-task', formattedTask, 'html');

                const memoText = SafeGetValue(userData, 'å¤‡å¿˜å½•', '-');
                const formattedMemo = (memoText || '-').toString().replace(/\\n|\n/g, '<br>');
                safeSetElement('user-memo', formattedMemo, 'html');
            } catch (error) {
                console.error('ç³»ç»Ÿé¢æ¿æ–‡æœ¬å¤„ç†å¤±è´¥:', error);
                showUserFriendlyError('æ–‡æœ¬å¤„ç†é”™è¯¯', `å¤„ç†ç³»ç»Ÿé¢æ¿æ–‡æœ¬æ—¶å‡ºé”™: ${error.message}`, 'è¯·æ£€æŸ¥æ–‡æœ¬æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
                safeSetElement('user-schedule', 'null', 'text');
                safeSetElement('user-task', 'null', 'text');
                safeSetElement('user-memo', 'null', 'text');
            }
        }

        function applyProjectData(projectData) {
            try {
            // é¡¹ç›®åç§°
            const projectName = SafeGetValue(projectData, 'é¡¹ç›®åç§°', 'æš‚æ— é¡¹ç›®');
                safeSetElement('project-name', projectName, 'text');

            // é¡¹ç›®è¯„çº§
            const projectRating = SafeGetValue(projectData, 'é¡¹ç›®è¯„çº§', 'æš‚æ— ');
            const ratingElement = document.getElementById('project-rating');
            if (ratingElement) {
            ratingElement.innerText = projectRating;
            
            // è®¾ç½®è¯„çº§æ ·å¼
            ratingElement.className = 'project-rating';
            switch(projectRating.toLowerCase()) {
                case 's+':
                    ratingElement.classList.add('s-plus');
                    break;
                case 's':
                    ratingElement.classList.add('s');
                    break;
                case 'a':
                    ratingElement.classList.add('a');
                    break;
                case 'b':
                    ratingElement.classList.add('b');
                    break;
                case 'c':
                    ratingElement.classList.add('c');
                    break;
                case 'd':
                    ratingElement.classList.add('d');
                    break;
                default:
                    ratingElement.classList.add('default');
                }
            } else {
                showUserFriendlyError('é¡¹ç›®è¯„çº§å…ƒç´ ç¼ºå¤±', 'æ‰¾ä¸åˆ°é¡¹ç›®è¯„çº§æ˜¾ç¤ºå…ƒç´ ', 'è¯·æ£€æŸ¥é¡µé¢æ˜¯å¦å®Œæ•´åŠ è½½');
            }

            // é¡¹ç›®ç±»å‹
            safeSetElement('project-type', SafeGetValue(projectData, 'é¡¹ç›®ç±»å‹', 'æš‚æ— '), 'text');

            // å½“å‰è¿›åº¦
            safeSetElement('project-progress', SafeGetValue(projectData, 'å½“å‰è¿›åº¦', 'æœªå¼€å§‹'), 'text');

            // ç”¨æˆ·èŒè´£
            safeSetElement('project-responsibility', SafeGetValue(projectData, 'ç”¨æˆ·èŒè´£', 'æš‚æ— '), 'text');

            // åŸºç¡€é…¬åŠ³
            const baseSalary = safeProcessNumber(SafeGetValue(projectData, 'åŸºç¡€é…¬åŠ³', 0), 'project-salary', 'åŸºç¡€é…¬åŠ³');
            try {
                const formattedSalary = `<span class="salary-amount">Â¥${new Intl.NumberFormat('en-US').format(baseSalary)}</span>`;
                safeSetElement('project-salary', formattedSalary, 'html');
            } catch (error) {
                console.error('åŸºç¡€é…¬åŠ³æ ¼å¼åŒ–å¤±è´¥:', error);
                safeSetElement('project-salary', 'Â¥null', 'text');
                showUserFriendlyError('é…¬åŠ³æ˜¾ç¤ºé”™è¯¯', 'åŸºç¡€é…¬åŠ³æ ¼å¼åŒ–å¤±è´¥', 'è¯·æ£€æŸ¥é…¬åŠ³æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
            }

            // é™„åŠ é…¬åŠ³
            safeSetElement('project-bonus', SafeGetValue(projectData, 'é™„åŠ é…¬åŠ³', 'æ— '), 'text');

            // é¡¹ç›®ç®€ä»‹
            const description = SafeGetValue(projectData, 'é¡¹ç›®ç®€ä»‹', 'æš‚æ— é¡¹ç›®ç®€ä»‹');
            const formattedDescription = (description || 'æš‚æ— é¡¹ç›®ç®€ä»‹').toString().replace(/\\n|\n/g, '<br>');
            safeSetElement('project-description', formattedDescription, 'html');

            // é¡¹ç›®æµç¨‹ (ç®€åŒ–å¤„ç†ï¼Œç›´æ¥æ˜¾ç¤ºåŸå§‹æ•°æ®)
            const flowText = SafeGetValue(projectData, 'é¡¹ç›®æµç¨‹', 'æš‚æ— æµç¨‹ä¿¡æ¯');
            safeSetElement('project-flow', flowText, 'text');
            
            } catch (error) {
                console.error('é¡¹ç›®æ•°æ®å¤„ç†å¤±è´¥:', error);
                showUserFriendlyError('é¡¹ç›®æ•°æ®é”™è¯¯', `å¤„ç†é¡¹ç›®ä¿¡æ¯æ—¶å‡ºé”™: ${error.message}`, 'è¯·æ£€æŸ¥é¡¹ç›®æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
            }
        }

        function applyOptionsData(optionsData, fullData) {
            try {
                // ä¿å­˜å®Œæ•´æ•°æ®ä¾›é‡æ·ä½¿ç”¨
                window.lastFullData = fullData;
                
                // ä½¿ç”¨æ–°çš„åŠ¨æ€å¤„ç†å‡½æ•°
                processOptions(optionsData, fullData);
                
            } catch (error) {
                console.error('é€‰é¡¹æ•°æ®å¤„ç†å¤±è´¥:', error);
                showUserFriendlyError('é€‰é¡¹æ•°æ®å¤„ç†å¤±è´¥', 'é€‰é¡¹æ·éª°é¡µé¢æ•°æ®åŠ è½½å¤±è´¥ï¼Œå¯èƒ½åŸå› ï¼šæ•°æ®æ ¼å¼é”™è¯¯æˆ–ç½‘ç»œé—®é¢˜ã€‚å»ºè®®é‡æ–°åŠ è½½é¡µé¢æˆ–é‡rollæ•°æ®ã€‚');
            }
        }

        // ğŸ¯ æ–°å¢ï¼šåŠ¨æ€å¤„ç†é€‰é¡¹çš„æ ¸å¿ƒå‡½æ•°
        function processOptions(optionsData, fullData) {
            const optionsContainer = document.getElementById('options-container');
            if (!optionsContainer || !optionsData) return;
            
            // ä¿ç•™çº¯æ·éª°é€‰é¡¹ï¼Œæ¸…é™¤å…¶ä»–åŠ¨æ€é€‰é¡¹
            const pureOption = optionsContainer.querySelector('.pure-dice-option');
            optionsContainer.innerHTML = '';
            if (pureOption) {
                optionsContainer.appendChild(pureOption);
            }
            
            // è·å–æ‰€æœ‰é€‰é¡¹é”®ï¼ŒåŠ¨æ€åˆ›å»ºé€‰é¡¹
            const optionKeys = Object.keys(optionsData).filter(key => key !== '$meta');
            console.log(`ğŸ² æ£€æµ‹åˆ° ${optionKeys.length} ä¸ªé€‰é¡¹:`, optionKeys);
            
            optionKeys.forEach((key, index) => {
                const optionIndex = index + 1;
                const optionData = SafeGetValue(optionsData, key, {});
                
                // åˆ›å»ºé€‰é¡¹HTMLç»“æ„
                const optionElement = createOptionElement(key, optionIndex, optionData, fullData);
                optionsContainer.appendChild(optionElement);
            });
            
            // æ›´æ–°é€‰é¡¹é”®æ˜ å°„ï¼ˆç”¨äºæ·éª°å‡½æ•°ï¼‰
            window.currentOptionKeys = optionKeys;
            console.log('âœ… é€‰é¡¹æ·éª°é¡µé¢åŠ¨æ€ç”Ÿæˆå®Œæˆ');
        }

        // ğŸ¯ æ–°å¢ï¼šåˆ›å»ºå•ä¸ªé€‰é¡¹å…ƒç´ 
        function createOptionElement(optionKey, optionIndex, optionData, fullData) {
            const behavior = SafeGetValue(optionData, 'è¡Œä¸º', 'æš‚æ— è¡Œä¸ºæè¿°');
            const attributesText = SafeGetValue(optionData, 'åˆ¤å®šå±æ€§', '');
            
            // åˆ›å»ºé€‰é¡¹å®¹å™¨
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option-item';
            optionDiv.setAttribute('data-option', optionIndex);
            optionDiv.setAttribute('data-option-key', optionKey);
            
            // è¡Œä¸ºæè¿°
            const behaviorDiv = document.createElement('div');
            behaviorDiv.className = 'option-behavior';
            behaviorDiv.textContent = behavior;
            
            // å±æ€§æ ‡ç­¾å®¹å™¨
            const attributesDiv = document.createElement('div');
            attributesDiv.className = 'option-attributes';
            
            // å¤„ç†åˆ¤å®šå±æ€§
            processOptionAttributes(attributesText, attributesDiv, fullData);
            
            // æŒ‰é’®ç»„
            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'option-buttons';
            buttonsDiv.innerHTML = `
                <button class="action-btn view-result-btn" onclick="showDiceResult(${optionIndex})">æŸ¥çœ‹ç»“æœ</button>
                <button class="action-btn direct-send-btn" onclick="directSend(${optionIndex})">ç›´æ¥å‘é€</button>
                <button class="action-btn input-send-btn" onclick="inputAndSend(${optionIndex})">è¾“å…¥åå‘é€</button>
            `;
            
            // ç»„è£…å…ƒç´ 
            optionDiv.appendChild(behaviorDiv);
            optionDiv.appendChild(attributesDiv);
            optionDiv.appendChild(buttonsDiv);
            
            return optionDiv;
        }

        // ğŸ¯ æ–°å¢ï¼šå¤„ç†é€‰é¡¹å±æ€§æ ‡ç­¾
        function processOptionAttributes(attributesText, container, fullData) {
            container.innerHTML = '';
            
            if (attributesText && Array.isArray(attributesText) && attributesText.length > 0) {
                const attributes = attributesText[0].split('/');
                attributes.forEach(attr => {
                    const trimmedAttr = attr.trim();
                    if (trimmedAttr) {
                        const value = getAttributeValue(trimmedAttr, fullData);
                        createAttributeTag(container, trimmedAttr, value);
                    }
                });
            } else if (typeof attributesText === 'string' && attributesText !== '') {
                const attributes = attributesText.split('/');
                attributes.forEach(attr => {
                    const trimmedAttr = attr.trim();
                    if (trimmedAttr) {
                        const value = getAttributeValue(trimmedAttr, fullData);
                        createAttributeTag(container, trimmedAttr, value);
                    }
                });
            }
        }

        // ğŸ¯ æ–°å¢ï¼šè·å–é€‰é¡¹é”®çš„è¾…åŠ©å‡½æ•°ï¼ˆå«fallbackå¤„ç†ï¼‰
        function getOptionKey(optionIndex) {
            const optionKeys = window.currentOptionKeys || ['è¡Œä¸ºä¸€', 'è¡Œä¸ºäºŒ', 'è¡Œä¸ºä¸‰', 'è¡Œä¸ºå››'];
            return optionKeys[optionIndex - 1];
        }

        // ğŸ¯ æ–°å¢ï¼šå®‰å…¨è·å–é€‰é¡¹æ•°æ®çš„è¾…åŠ©å‡½æ•°
        function getOptionData(optionIndex, fullData) {
            const optionKey = getOptionKey(optionIndex);
            if (!optionKey) {
                console.warn(`é€‰é¡¹ç´¢å¼• ${optionIndex} æ— æ•ˆï¼Œä½¿ç”¨fallback`);
                return {};
            }
            
            const optionsData = SafeGetValue(fullData, 'é€‰é¡¹', {});
            return SafeGetValue(optionsData, optionKey, {});
        }

        function getAttributeValue(attributeName, fullData) {
            // ç”¨æˆ·å±æ€§æ˜ å°„
            const userAttributeMap = {
                'åŠ›é‡': 'åŠ›é‡',
                'ä½“è´¨': 'ä½“è´¨', 
                'æ•æ·': 'æ•æ·',
                'æ™ºåŠ›': 'æ™ºåŠ›',
                'æ„å¿—': 'æ„å¿—',
                'æ„ŸçŸ¥': 'æ„ŸçŸ¥',
                'é­…åŠ›': 'é­…åŠ›',
                'è¿æ°”': 'è¿æ°”',
                'é£è¯„': 'é£è¯„',
                'è¡Œä¸šåœ°ä½': 'è¡Œä¸šåœ°ä½',
                'è‰²æ¬²': 'è‰²æ¬²',
                'æ€§æ¬²å€¼': 'æ€§æ¬²å€¼',
                'è¡¨æ¼”èƒ½åŠ›': 'æ¼”æŠ€',
                'æ¼”æŠ€': 'æ¼”æŠ€', // ğŸ› ä¿®å¤ï¼šæ·»åŠ æ¼”æŠ€çš„ç›´æ¥æ˜ å°„
                'å”±åŠŸ': 'å”±åŠŸ',
                'èˆè¹ˆèƒ½åŠ›': 'èˆè¹ˆ',
                'èˆè¹ˆ': 'èˆè¹ˆ', // ğŸ› ä¿®å¤ï¼šæ·»åŠ èˆè¹ˆçš„ç›´æ¥æ˜ å°„
                'ç»¼è‰ºæ„Ÿ': 'ç»¼è‰ºæ„Ÿ',
                'å•†ä¸šä»·å€¼': 'å•†ä¸šä»·å€¼',
                'åˆ›ä½œèƒ½åŠ›': 'åˆ›ä½œèƒ½åŠ›',
                'å­¦ä¹ èƒ½åŠ›': 'å­¦ä¹ èƒ½åŠ›',
                'å•†ä¸šèƒ½åŠ›': 'å•†ä¸šèƒ½åŠ›',
                'è´¦æˆ·ä½™é¢': 'è´¦æˆ·ä½™é¢'
            };

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·å±æ€§
            if (userAttributeMap[attributeName]) {
                const userData = SafeGetValue(fullData, 'ç”¨æˆ·', {});
                const value = SafeGetValue(userData, userAttributeMap[attributeName], 0);
                
                // ç‰¹æ®Šå¤„ç†è´¦æˆ·ä½™é¢ï¼Œè¿”å›æè¿°è€Œä¸æ˜¯æ•°å€¼
                if (attributeName === 'è´¦æˆ·ä½™é¢') {
                    return getBalanceDescription(value);
                }
                
                return value;
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯é¡¹ç›®è¯„çº§
            if (attributeName === 'é¡¹ç›®è¯„çº§') {
                const projectData = SafeGetValue(fullData, 'å½“å‰å·¥ä½œé¡¹ç›®', {});
                return SafeGetValue(projectData, 'é¡¹ç›®è¯„çº§', 'æš‚æ— ');
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯è§’è‰²å¥½æ„Ÿåº¦
            if (attributeName.endsWith('å¥½æ„Ÿåº¦')) {
                const characterName = attributeName.replace('å¥½æ„Ÿåº¦', '');
                const charactersData = SafeGetValue(fullData, 'è§’è‰²', {});
                const characterData = SafeGetValue(charactersData, characterName, {});
                return SafeGetValue(characterData, 'å¥½æ„Ÿåº¦', 0);
            }

            return 0;
        }

        function getBalanceDescription(balance) {
            if (balance <= -10000000) return 'å·¨é¢å€ºåŠ¡';
            if (balance >= -9999999 && balance <= -1000000) return 'è´Ÿå€ºç´¯ç´¯';
            if (balance >= -999999 && balance <= -1) return 'ä¸¥é‡è´Ÿå€º';
            if (balance >= 0 && balance <= 9999) return 'æ‰‹å¤´æ‹®æ®';
            if (balance >= 10000 && balance <= 499999) return 'æ™®é€šæ°´å¹³';
            if (balance >= 500000 && balance <= 9999999) return 'æœ‰ç‚¹å¯Œè£•';
            if (balance >= 10000000 && balance <= 49999999) return 'éå¸¸å¯Œæœ‰';
            if (balance >= 50000000) return 'é¡¶çº§è´¢é˜€';
            return 'æœªçŸ¥çŠ¶æ€';
        }

        // æ·éª°ç³»ç»Ÿå…¨å±€å˜é‡
        let currentDiceData = {};
        let lockedResults = {}; // å­˜å‚¨é”å®šçš„ç»“æœï¼Œkeyä¸ºoptionIndex

        function createAttributeTag(container, attributeName, value) {
            const tag = document.createElement('div');
            tag.className = 'attribute-tag';
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = attributeName;
            
            const valueSpan = document.createElement('span');
            valueSpan.className = 'attribute-value';
            valueSpan.textContent = value;
            
            tag.appendChild(nameSpan);
            tag.appendChild(valueSpan);
            container.appendChild(tag);
        }

        // æ·éª°ç³»ç»Ÿæ ¸å¿ƒåŠŸèƒ½
        function performDiceRoll(optionIndex, fullData) {
            // ğŸ¯ ä½¿ç”¨è¾…åŠ©å‡½æ•°è·å–é€‰é¡¹æ•°æ®
            const optionData = getOptionData(optionIndex, fullData);
            
            // è·å–åˆ¤å®šå±æ€§
            const attributesText = SafeGetValue(optionData, 'åˆ¤å®šå±æ€§', '');
            let attributes = [];
            
            if (attributesText && Array.isArray(attributesText) && attributesText.length > 0) {
                attributes = attributesText[0].split('/').map(attr => attr.trim()).filter(attr => attr);
            } else if (typeof attributesText === 'string' && attributesText !== '') {
                attributes = attributesText.split('/').map(attr => attr.trim()).filter(attr => attr);
            }

            // è·å–æ•°å€¼å¹¶è¿›è¡Œå½’ä¸€åŒ–
            const normalizedValues = [];
            attributes.forEach(attr => {
                const value = getRawAttributeValue(attr, fullData);
                const normalizedValue = normalizeValue(attr, value);
                normalizedValues.push(normalizedValue);
            });

            // è®¡ç®—åŸºç¡€ST
            const baseST = normalizedValues.length > 0 ? Math.floor(normalizedValues.reduce((sum, val) => sum + val, 0) / normalizedValues.length) : 0;
            
            // è·å–è¿æ°”å€¼å¹¶è®¡ç®—è¿æ°”åŠ æˆ
            const userData = SafeGetValue(fullData, 'ç”¨æˆ·', {});
            const luckValue = SafeGetValue(userData, 'è¿æ°”', 0);
            const luckBonus = Math.floor(luckValue / 10);
            
            // æŠ•æ·d100
            const diceRoll = Math.floor(Math.random() * 100) + 1;
            
            // æ£€æŸ¥ç‰¹æ®Šç‚¹æ•°
            const tensDigit = Math.floor(diceRoll / 10);
            const onesDigit = diceRoll % 10;
            const hasSpecialPoints = (tensDigit === onesDigit && diceRoll >= 11);
            const specialPoints = hasSpecialPoints ? 1 : 0;
            
            // è®¡ç®—æœ€ç»ˆST
            const finalST = baseST + luckBonus + specialPoints;
            
            // åˆ¤å®šç»“æœ
            const result = determineDiceResult(diceRoll, finalST);
            
            // ä¿å­˜æ•°æ®ä¾›å¼¹çª—ä½¿ç”¨
            currentDiceData = {
                optionIndex,
                attributes,
                normalizedValues,
                baseST,
                luckValue,
                luckBonus,
                diceRoll,
                hasSpecialPoints,
                specialPoints,
                finalST,
                result
            };
            
            // é”å®šç»“æœ
            lockedResults[optionIndex] = currentDiceData;
        }

        function performPureDiceRoll(fullData) {
            // æŠ•æ·d100
            const diceRoll = Math.floor(Math.random() * 100) + 1;
            
            // åˆ¤å®šç»“æœ (çº¯æ·éª°è§„åˆ™)
            let result;
            if (diceRoll >= 91) {
                result = { type: 'critical-failure', text: 'å¤§å¤±è´¥' };
            } else if (diceRoll >= 51) {
                result = { type: 'failure', text: 'å¤±è´¥' };
            } else if (diceRoll >= 11) {
                result = { type: 'success', text: 'æˆåŠŸ' };
            } else {
                result = { type: 'critical-success', text: 'å¤§æˆåŠŸ' };
            }
            
            // ä¿å­˜æ•°æ®ä¾›å¼¹çª—ä½¿ç”¨
            currentDiceData = {
                optionIndex: 'pure',
                isPureDice: true,
                diceRoll,
                result
            };
            
            // é”å®šç»“æœ
            lockedResults['pure'] = currentDiceData;
        }

        function getRawAttributeValue(attributeName, fullData) {
            // ç”¨æˆ·å±æ€§æ˜ å°„
            const userAttributeMap = {
                'åŠ›é‡': 'åŠ›é‡', 'ä½“è´¨': 'ä½“è´¨', 'æ•æ·': 'æ•æ·', 'æ™ºåŠ›': 'æ™ºåŠ›',
                'æ„å¿—': 'æ„å¿—', 'æ„ŸçŸ¥': 'æ„ŸçŸ¥', 'é­…åŠ›': 'é­…åŠ›', 'è¿æ°”': 'è¿æ°”',
                'é£è¯„': 'é£è¯„', 'è¡Œä¸šåœ°ä½': 'è¡Œä¸šåœ°ä½', 'è‰²æ¬²': 'è‰²æ¬²', 'æ€§æ¬²å€¼': 'æ€§æ¬²å€¼',
                'è¡¨æ¼”èƒ½åŠ›': 'æ¼”æŠ€', 'æ¼”æŠ€': 'æ¼”æŠ€', // ğŸ› ä¿®å¤ï¼šæ·»åŠ æ¼”æŠ€çš„ç›´æ¥æ˜ å°„
                'å”±åŠŸ': 'å”±åŠŸ', 'èˆè¹ˆèƒ½åŠ›': 'èˆè¹ˆ', 'èˆè¹ˆ': 'èˆè¹ˆ', // ğŸ› ä¿®å¤ï¼šæ·»åŠ èˆè¹ˆçš„ç›´æ¥æ˜ å°„
                'ç»¼è‰ºæ„Ÿ': 'ç»¼è‰ºæ„Ÿ', 'å•†ä¸šä»·å€¼': 'å•†ä¸šä»·å€¼', 'åˆ›ä½œèƒ½åŠ›': 'åˆ›ä½œèƒ½åŠ›', 
                'å­¦ä¹ èƒ½åŠ›': 'å­¦ä¹ èƒ½åŠ›', 'å•†ä¸šèƒ½åŠ›': 'å•†ä¸šèƒ½åŠ›', 'è´¦æˆ·ä½™é¢': 'è´¦æˆ·ä½™é¢'
            };

            // æ£€æŸ¥æ˜¯å¦æ˜¯ç”¨æˆ·å±æ€§
            if (userAttributeMap[attributeName]) {
                const userData = SafeGetValue(fullData, 'ç”¨æˆ·', {});
                return SafeGetValue(userData, userAttributeMap[attributeName], 0);
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯é¡¹ç›®è¯„çº§
            if (attributeName === 'é¡¹ç›®è¯„çº§') {
                const projectData = SafeGetValue(fullData, 'å½“å‰å·¥ä½œé¡¹ç›®', {});
                return SafeGetValue(projectData, 'é¡¹ç›®è¯„çº§', 'D');
            }

            // æ£€æŸ¥æ˜¯å¦æ˜¯è§’è‰²å¥½æ„Ÿåº¦
            if (attributeName.endsWith('å¥½æ„Ÿåº¦')) {
                const characterName = attributeName.replace('å¥½æ„Ÿåº¦', '');
                const charactersData = SafeGetValue(fullData, 'è§’è‰²', {});
                const characterData = SafeGetValue(charactersData, characterName, {});
                return SafeGetValue(characterData, 'å¥½æ„Ÿåº¦', 0);
            }

            return 0;
        }

        function normalizeValue(attributeName, value) {
            // é£è¯„ (-100 åˆ° +100)
            if (attributeName === 'é£è¯„') {
                return Math.floor((value + 100) / 2);
            }
            
            // è§’è‰²å¥½æ„Ÿåº¦ (0-1000)
            if (attributeName.endsWith('å¥½æ„Ÿåº¦')) {
                return Math.floor(value / 10);
            }
            
            // è´¦æˆ·ä½™é¢ (ç‰¹æ®Šæ˜ å°„)
            if (attributeName === 'è´¦æˆ·ä½™é¢') {
                if (value <= -10000000) return 0;
                if (value >= -9999999 && value <= -1000000) return 10;
                if (value >= -999999 && value <= -1) return 25;
                if (value >= 0 && value <= 9999) return 40;
                if (value >= 10000 && value <= 499999) return 50;
                if (value >= 500000 && value <= 9999999) return 70;
                if (value >= 10000000 && value <= 49999999) return 85;
                if (value >= 50000000) return 95;
                return 40;
            }
            
            // é¡¹ç›®è¯„çº§
            if (attributeName === 'é¡¹ç›®è¯„çº§') {
                const ratingMap = { 'S+': 20, 'S': 35, 'A': 50, 'B': 60, 'C': 75, 'D': 90 };
                return ratingMap[value] || 50;
            }
            
            // å¸¸è§„æ•°å€¼ (0-100)
            return Math.max(0, Math.min(100, value));
        }

        function determineDiceResult(diceRoll, finalST) {
            // å¤§å¤±è´¥ (98-100)
            if (diceRoll >= 98) {
                return { type: 'critical-failure', text: 'å¤§å¤±è´¥' };
            }
            
            // å¤§æˆåŠŸ (â‰¤ ST/10)
            const criticalSuccessThreshold = Math.floor(finalST / 10);
            if (diceRoll <= criticalSuccessThreshold && diceRoll >= 1) {
                return { type: 'critical-success', text: 'å¤§æˆåŠŸ' };
            }
            
            // æˆåŠŸ (â‰¤ ST)
            if (diceRoll <= finalST) {
                return { type: 'success', text: 'æˆåŠŸ' };
            }
            
            // å¤±è´¥
            return { type: 'failure', text: 'å¤±è´¥' };
        }

        function getResultDescription(resultType) {
            const descriptions = {
                'critical-success': [
                    'å¤©åŠ©ä½ ä¹Ÿï¼è¿™æ¬¡ç®€ç›´æ˜¯ç¥æ¥ä¹‹ç¬”ï¼',
                    'å®Œç¾æ‰§è¡Œï¼Œè¿è€å¤©éƒ½åœ¨ä¸ºä½ é¼“æŒï¼',
                    'è¿™å°±æ˜¯ä¼ è¯´ä¸­çš„ä¸»è§’å…‰ç¯å—ï¼Ÿ',
                    'æ•™ç§‘ä¹¦çº§åˆ«çš„æ“ä½œï¼Œå ªç§°è‰ºæœ¯ï¼'
                ],
                'success': [
                    'ä¸é”™ä¸é”™ï¼Œä¸€åˆ‡éƒ½æŒ‰è®¡åˆ’è¿›è¡Œï¼',
                    'ç¨³æ‰ç¨³æ‰“ï¼Œè¿™å°±æ˜¯å®åŠ›çš„ä½“ç°ï¼',
                    'è™½ç„¶ä¸ç®—æƒŠè‰³ï¼Œä½†è¶³å¤Ÿé è°±ï¼',
                    'è¿æ°”ä¸é”™ï¼ŒåŠªåŠ›æœ‰äº†å›æŠ¥ï¼'
                ],
                'failure': [
                    'å”‰ï¼Œè¿™æ¬¡è¿æ°”å·®äº†é‚£ä¹ˆä¸€ç‚¹ç‚¹...',
                    'å¤±è¯¯åœ¨æ‰€éš¾å…ï¼Œä¸‹æ¬¡å†æ¥ï¼',
                    'çœ‹æ¥è¿˜éœ€è¦æ›´å¤šçš„å‡†å¤‡å‘¢...',
                    'è™½è´¥çŠ¹è£ï¼Œè‡³å°‘å°è¯•è¿‡äº†ï¼'
                ],
                'critical-failure': [
                    'è¿™...è¿™ç®€ç›´æ˜¯ç¾éš¾ç°åœºå•Šï¼',
                    'æ­å–œä½ ï¼ŒæˆåŠŸåœ°æç ¸äº†ä¸€åˆ‡ï¼',
                    'æœ‰æ—¶å€™å¤±è´¥ä¹Ÿæ˜¯ä¸€ç§æ‰èƒ½ï¼',
                    'è¿™ç§å€’éœ‰ç¨‹åº¦ï¼Œå·²ç»å¯ä»¥å†™è¿›æ•™ç§‘ä¹¦äº†ï¼'
                ]
            };
            
            const typeDescriptions = descriptions[resultType] || descriptions['failure'];
            return typeDescriptions[Math.floor(Math.random() * typeDescriptions.length)];
        }

        function showDiceResult(optionIndex) {
            // å¦‚æœæ²¡æœ‰é”å®šç»“æœï¼Œå…ˆæ‰§è¡Œæ·éª°
            if (!lockedResults[optionIndex]) {
                if (optionIndex === 'pure') {
                    performPureDiceRoll(window.lastFullData || {});
                } else {
                    performDiceRoll(optionIndex, window.lastFullData || {});
                }
            }
            
            const data = lockedResults[optionIndex];
            if (!data) return;
            
            // è®¾ç½®å½“å‰æ•°æ®ç”¨äºå¼¹çª—æ˜¾ç¤º
            currentDiceData = data;
            
            // æ›´æ–°å¼¹çª—å†…å®¹
            document.getElementById('dice-outcome').textContent = data.result.text;
            document.getElementById('dice-outcome').className = `dice-outcome ${data.result.type}`;
            document.getElementById('dice-description').textContent = getResultDescription(data.result.type);
            
            document.getElementById('dice-roll-value').textContent = data.diceRoll;
            
            // æ ¹æ®æ˜¯å¦ä¸ºçº¯æ·éª°æ¥æ˜¾ç¤ºä¸åŒçš„è¯¦ç»†ä¿¡æ¯
            const stItem = document.querySelector('.dice-detail-item:nth-child(2)');
            const luckItem = document.querySelector('.dice-detail-item:nth-child(3)');
            const specialItem = document.getElementById('special-points-item');
            const finalItem = document.querySelector('.dice-detail-item:nth-child(5)');
            const formulaItem = document.querySelector('.dice-formula');
            
            if (data.isPureDice) {
                // çº¯æ·éª°æ¨¡å¼ï¼šéšè—æ‰€æœ‰å¤æ‚æ•°å€¼
                stItem.style.display = 'none';
                luckItem.style.display = 'none';
                specialItem.style.display = 'none';
                finalItem.style.display = 'none';
                formulaItem.style.display = 'none';
            } else {
                // æ­£å¸¸æ¨¡å¼ï¼šæ˜¾ç¤ºæ‰€æœ‰æ•°å€¼
                stItem.style.display = 'flex';
                luckItem.style.display = 'flex';
                finalItem.style.display = 'flex';
                formulaItem.style.display = 'block';
                
                document.getElementById('dice-st-value').textContent = data.baseST;
                document.getElementById('dice-luck-bonus').textContent = `+${data.luckBonus}`;
                document.getElementById('dice-final-st').textContent = data.finalST;
                
                // ç‰¹æ®Šç‚¹æ•°æ˜¾ç¤º
                if (data.hasSpecialPoints) {
                    specialItem.style.display = 'flex';
                    document.getElementById('dice-special-points').textContent = `+${data.specialPoints}`;
                } else {
                    specialItem.style.display = 'none';
                }
                
                // æ¯”è¾ƒå…¬å¼
                const comparison = data.diceRoll <= data.finalST ? 'â‰¤' : '>';
                document.getElementById('dice-comparison').textContent = `${data.diceRoll} ${comparison} ${data.finalST}`;
            }
            
            // æ˜¾ç¤ºå¼¹çª—
            document.getElementById('dice-result-modal').style.display = 'flex';
        }

        function closeDiceModal() {
            document.getElementById('dice-result-modal').style.display = 'none';
        }

        function rerollDice() {
            if (!currentDiceData) return;
            
            const data = currentDiceData;
            const newDiceRoll = Math.floor(Math.random() * 100) + 1;
            
            if (data.isPureDice) {
                // çº¯æ·éª°é‡æ·
                let result;
                if (newDiceRoll >= 91) {
                    result = { type: 'critical-failure', text: 'å¤§å¤±è´¥' };
                } else if (newDiceRoll >= 51) {
                    result = { type: 'failure', text: 'å¤±è´¥' };
                } else if (newDiceRoll >= 11) {
                    result = { type: 'success', text: 'æˆåŠŸ' };
                } else {
                    result = { type: 'critical-success', text: 'å¤§æˆåŠŸ' };
                }
                
                currentDiceData = {
                    ...data,
                    diceRoll: newDiceRoll,
                    result
                };
                
                // æ›´æ–°é”å®šç»“æœ
                lockedResults['pure'] = currentDiceData;
            } else {
                // æ­£å¸¸æ·éª°é‡æ·
                const tensDigit = Math.floor(newDiceRoll / 10);
                const onesDigit = newDiceRoll % 10;
                const hasSpecialPoints = (tensDigit === onesDigit && newDiceRoll >= 11);
                const specialPoints = hasSpecialPoints ? 1 : 0;
                
                const finalST = data.baseST + data.luckBonus + specialPoints;
                const result = determineDiceResult(newDiceRoll, finalST);
                
                currentDiceData = {
                    ...data,
                    diceRoll: newDiceRoll,
                    hasSpecialPoints,
                    specialPoints,
                    finalST,
                    result
                };
                
                // æ›´æ–°é”å®šç»“æœ
                lockedResults[data.optionIndex] = currentDiceData;
            }
            
            // æ›´æ–°æ˜¾ç¤º
            showDiceResult(data.optionIndex);
        }

        function getResultEffect(resultType) {
            const effects = {
                'critical-success': 'ç”¨æˆ·å°†å®Œç¾è¾¾æˆç›®æ ‡ï¼Œè¿˜å¼•å‘äº†è¿é”å¥‡è¿¹ï¼Œè¿™ä¼šæ˜¯ä¸€ä¸ªè®©å±€åŠ¿å¯¹ç”¨æˆ·æ›´æœ‰åˆ©çš„èµ ç¤¼ã€‚',
                'success': 'ç”¨æˆ·æ­¤æ¬¡è¡ŒåŠ¨å°†é¡ºåˆ©å®Œæˆï¼Œè¾¾æˆé¢„å®šç›®æ ‡ã€‚',
                'failure': 'ç”¨æˆ·æ­¤æ¬¡è¡ŒåŠ¨å°†ä¸èƒ½å¦‚æ„¿å®Œæˆã€‚å¯èƒ½ä¼šå‡ºä¸€äº›æ£˜æ‰‹çš„å°æƒ…å†µã€‚',
                'critical-failure': 'ç”¨æˆ·æ­¤æ¬¡çš„è¡Œä¸ºå°†å¼•å‘ç¾éš¾æ€§çš„åæœï¼Œå°†ç”¨æˆ·æ¨å…¥äº†æ›´æ·±çš„å±æœºã€‚'
            };
            return effects[resultType] || effects['failure'];
        }

        function injectMessageToInput(optionIndex, fullData, result, diceRoll) {
            // ğŸ¯ ä½¿ç”¨è¾…åŠ©å‡½æ•°è·å–é€‰é¡¹æ•°æ®
            const optionData = getOptionData(optionIndex, fullData);
            const behavior = SafeGetValue(optionData, 'è¡Œä¸º', ['æš‚æ— è¡Œä¸ºæè¿°']);
            const behaviorText = Array.isArray(behavior) ? behavior[0] : behavior;
            
            const resultEffect = getResultEffect(result.type);
            
            const messageContent = `${behaviorText}ç”¨æˆ·ä¸ºæ­¤æ¬¡æƒ…èŠ‚å‘å±•æ·äº†éª°å­<!--ï¼Œç”¨æˆ·æ­¤æ¬¡æ·éª°ç»“æœä¸º${diceRoll}ï¼Œç»“æœæ˜¯${result.text}ï¼Œå¯¹æ­¤æ¬¡å‰§æƒ…çš„å½±å“ä¸ºï¼š${resultEffect}-->`;
            
            try {
                window.parent.document.querySelector('#send_textarea').value = messageContent;
                // ä¿å­˜å®Œæ•´æ•°æ®ä¾›é‡æ·ä½¿ç”¨
                window.lastFullData = fullData;
            } catch (error) {
                console.error('å‘é€æ•°æ®åˆ°çˆ¶çª—å£æ—¶å‡ºé”™:', error);
                console.error('æ­¤åŠŸèƒ½éœ€è¦é¡µé¢è¢«åµŒå…¥åˆ°æ­£ç¡®é…ç½®çš„çˆ¶çª—å£ä¸­æ‰èƒ½å·¥ä½œã€‚');
                console.log('ç”Ÿæˆçš„æ¶ˆæ¯:', messageContent);
                alert('æ— æ³•è‡ªåŠ¨å‘é€ã€‚æ¶ˆæ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
            }
        }

        function injectPureDiceMessageToInput(result, diceRoll) {
            const resultEffect = getResultEffect(result.type);
            
            const messageContent = `ç”¨æˆ·ä¸ºæ­¤æ¬¡æƒ…èŠ‚å‘å±•æ·äº†éª°å­<!--æ·éª°ç»“æœä¸º${diceRoll}ï¼Œç»“æœæ˜¯${result.text}ï¼Œå¯¹æ­¤æ¬¡å‰§æƒ…çš„å½±å“ä¸ºï¼š${resultEffect}-->`;
            
            try {
                window.parent.document.querySelector('#send_textarea').value = messageContent;
            } catch (error) {
                console.error('å‘é€æ•°æ®åˆ°çˆ¶çª—å£æ—¶å‡ºé”™:', error);
                console.error('æ­¤åŠŸèƒ½éœ€è¦é¡µé¢è¢«åµŒå…¥åˆ°æ­£ç¡®é…ç½®çš„çˆ¶çª—å£ä¸­æ‰èƒ½å·¥ä½œã€‚');
                console.log('ç”Ÿæˆçš„æ¶ˆæ¯:', messageContent);
                alert('æ— æ³•è‡ªåŠ¨å‘é€ã€‚æ¶ˆæ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
            }
        }

        // æ–°çš„æŒ‰é’®åŠŸèƒ½
        function directSend(optionIndex) {
            // å¦‚æœæ²¡æœ‰é”å®šç»“æœï¼Œå…ˆæ‰§è¡Œæ·éª°
            if (!lockedResults[optionIndex]) {
                if (optionIndex === 'pure') {
                    performPureDiceRoll(window.lastFullData || {});
                } else {
                    performDiceRoll(optionIndex, window.lastFullData || {});
                }
            }

            const data = lockedResults[optionIndex];
            if (!data) return;

            let messageContent;
            if (data.isPureDice) {
                const resultEffect = getResultEffect(data.result.type);
                messageContent = `ç”¨æˆ·ä¸ºæ­¤æ¬¡æƒ…èŠ‚å‘å±•æ·äº†éª°å­<!--æ·éª°ç»“æœä¸º${data.diceRoll}ï¼Œç»“æœæ˜¯${data.result.text}ï¼Œå¯¹æ­¤æ¬¡å‰§æƒ…çš„å½±å“ä¸ºï¼š${resultEffect}-->ï¼Œè¯·æ ¹æ®æŠ•æ·ç»“æœï¼Œæ‰¿æ¥ä¸Šæ–‡ç»§ç»­ç”Ÿæˆåç»­å‰§æƒ…`;
            } else {
                const fullData = window.lastFullData || {};
                const optionData = getOptionData(optionIndex, fullData);
                const behavior = SafeGetValue(optionData, 'è¡Œä¸º', ['æš‚æ— è¡Œä¸ºæè¿°']);
                const behaviorText = Array.isArray(behavior) ? behavior[0] : behavior;
                const resultEffect = getResultEffect(data.result.type);
                
                messageContent = `${behaviorText}ï¼Œç”¨æˆ·ä¸ºæ­¤æ¬¡æƒ…èŠ‚å‘å±•æ·äº†éª°å­<!--ï¼Œç”¨æˆ·æ­¤æ¬¡æ·éª°ç»“æœä¸º${data.diceRoll}ï¼Œç»“æœæ˜¯${data.result.text}ï¼Œå¯¹æ­¤æ¬¡å‰§æƒ…çš„å½±å“ä¸ºï¼š${resultEffect}-->`;
            }

            try {
                window.parent.document.querySelector('#send_textarea').value = messageContent;
                window.parent.document.querySelector('#send_but').click();
            } catch (error) {
                console.error('å‘é€æ•°æ®åˆ°çˆ¶çª—å£æ—¶å‡ºé”™:', error);
                alert('æ— æ³•è‡ªåŠ¨å‘é€ã€‚æ¶ˆæ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
                console.log('ç”Ÿæˆçš„æ¶ˆæ¯:', messageContent);
            }
        }

        function inputAndSend(optionIndex) {
            // å¦‚æœæ²¡æœ‰é”å®šç»“æœï¼Œå…ˆæ‰§è¡Œæ·éª°
            if (!lockedResults[optionIndex]) {
                if (optionIndex === 'pure') {
                    performPureDiceRoll(window.lastFullData || {});
                } else {
                    performDiceRoll(optionIndex, window.lastFullData || {});
                }
            }

            const data = lockedResults[optionIndex];
            if (!data) return;

            let displayText;
            if (data.isPureDice) {
                displayText = 'ç”¨æˆ·ä¸ºæ­¤æ¬¡æƒ…èŠ‚å‘å±•æ·äº†éª°å­ï¼ˆæŠ•æ·ç»“æœå·²éšè—ï¼‰';
            } else {
                const fullData = window.lastFullData || {};
                const optionData = getOptionData(optionIndex, fullData);
                const behavior = SafeGetValue(optionData, 'è¡Œä¸º', ['æš‚æ— è¡Œä¸ºæè¿°']);
                const behaviorText = Array.isArray(behavior) ? behavior[0] : behavior;
                
                displayText = `${behaviorText}ç”¨æˆ·ä¸ºæ­¤æ¬¡æƒ…èŠ‚å‘å±•æ·äº†éª°å­ï¼ˆæŠ•æ·ç»“æœå·²éšè—ï¼‰`;
            }

            // ä¿å­˜å½“å‰é€‰é¡¹å’Œæ•°æ®ä»¥ä¾›å‘é€ä½¿ç”¨
            window.currentEditingOption = optionIndex;
            window.currentEditingData = data;

            // æ˜¾ç¤ºè¾“å…¥å¼¹çª—
            document.getElementById('message-input').value = displayText;
            document.getElementById('input-send-modal').style.display = 'flex';
        }

        function closeInputModal() {
            document.getElementById('input-send-modal').style.display = 'none';
        }

        function sendEditedMessage() {
            const editedText = document.getElementById('message-input').value;
            const data = window.currentEditingData;
            
            if (!data) return;

            const resultEffect = getResultEffect(data.result.type);
            const hiddenPart = `<!--æ·éª°ç»“æœä¸º${data.diceRoll}ï¼Œç»“æœæ˜¯${data.result.text}ï¼Œå¯¹æ­¤æ¬¡å‰§æƒ…çš„å½±å“ä¸ºï¼š${resultEffect}-->`;
            
            // ç§»é™¤"ï¼ˆæŠ•æ·ç»“æœå·²éšè—ï¼‰"æ–‡æœ¬
            const cleanedText = editedText.replace(/ï¼ˆæŠ•æ·ç»“æœå·²éšè—ï¼‰/g, '');
            const finalMessage = cleanedText + hiddenPart;

            try {
                window.parent.document.querySelector('#send_textarea').value = finalMessage;
                window.parent.document.querySelector('#send_but').click();
                closeInputModal();
            } catch (error) {
                console.error('å‘é€æ•°æ®åˆ°çˆ¶çª—å£æ—¶å‡ºé”™:', error);
                alert('æ— æ³•è‡ªåŠ¨å‘é€ã€‚æ¶ˆæ¯å·²è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
                console.log('ç”Ÿæˆçš„æ¶ˆæ¯:', finalMessage);
            }
        }

        function createCharacterPageHTML(characterName) {
            return `
                <div class="scrollable-page-content">
                <div class="details-grid">
                    <div class="profile-section">
                        <img id="${characterName}-avatar" class="avatar-image" src="" alt="${characterName}å¤´åƒ">
                        <div id="${characterName}-name-header">${characterName}</div>
                        <div class="star-rating">
                            <svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            <svg class="icon heart-outline" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            <svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                            <svg class="icon heart-outline" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            <svg class="icon" viewBox="0 0 24 24"><path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>
                        </div>
                    </div>
                    <div class="properties-section">
                        <div class="property">
                            <div class="property-icon-wrapper"><svg class="icon" viewBox="0 0 24 24"><path d="M16.5 3c-1.74 0-3.41.81-4.5 2.09C10.91 3.81 9.24 3 7.5 3 4.42 3 2 5.42 2 8.5c0 3.78 3.4 6.86 8.55 11.54L12 21.35l1.45-1.32C18.6 15.36 22 12.28 22 8.5c0-3.1-2.42-5.5-5.5-5.5zm-1.15 11.36L12 17.27l-3.35-3.07C6.14 11.83 4 9.95 4 8.5 4 6.5 5.5 5 7.5 5c1.54 0 3.04.99 3.57 2.36h1.87C13.46 5.99 14.96 5 16.5 5c2 0 3.5 1.5 3.5 3.5 0 1.45-2.14 3.33-4.65 5.86z"/></svg></div>
                            <div class="property-details">
                                <div class="property-label">å¥½æ„Ÿåº¦</div>
                                <div class="property-value" id="${characterName}-favorability-value">-</div>
                            </div>
                        </div>
                        <div class="property">
                            <div class="property-icon-wrapper"><svg class="icon" viewBox="0 0 24 24"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg></div>
                            <div class="property-details">
                                <div class="property-label">æ€§æ¬²å€¼</div>
                                <div class="property-value" id="${characterName}-lust-value">-</div>
                            </div>
                        </div>
                        <div class="property">
                            <div class="property-icon-wrapper"><svg class="icon" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div>
                            <div class="property-details">
                                <div class="property-label">ä½ç½®</div>
                                <div class="property-value" id="${characterName}-location-value">-</div>
                            </div>
                        </div>
                        <div class="property">
                            <div class="property-icon-wrapper"><svg class="icon" viewBox="0 0 24 24"><path d="M20.35 6.35L19 5l-7-3-7 3L3.65 6.35C2.6 7.39 2 8.77 2 10.25V20c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V10.25c0-1.48-.6-2.86-1.65-3.9zM8 11V9l4-1.5 4 1.5v2H8z"/></svg></div>
                            <div class="property-details">
                                <div class="property-label">è¡£ç€</div>
                                <div class="property-value" id="${characterName}-attire-value">-</div>
                            </div>
                        </div>
                        <div class="property">
                            <div class="property-icon-wrapper"><svg class="icon" viewBox="0 0 24 24"><path d="M3 13h2.2l1.2-4.4 2.1 8.4 2.6-6.4 1.6 3.4H17v-2h-3.5l-1.3-2.8L9.4 15 7.5 9l-2.3 5H3v2z"/></svg></div>
                            <div class="property-details">
                                <div class="property-label">è¡Œä¸º</div>
                                <div class="property-value" id="${characterName}-behavior-value">-</div>
                            </div>
                        </div>
                        <div class="property">
                            <div class="property-icon-wrapper"><svg class="icon" viewBox="0 0 24 24"><path d="M14.5 13.5c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5zm-5 0c-1.38 0-2.5 1.12-2.5 2.5s1.12 2.5 2.5 2.5 2.5-1.12 2.5-2.5-1.12-2.5-2.5-2.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg></div>
                            <div class="property-details">
                                <div class="property-label">å¿ƒç†æ´»åŠ¨</div>
                                <div class="property-value" id="${characterName}-psychology-value">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function applyCharacterData(characterName, data) {
            try {
                // è§’è‰²å¤´åƒå¤„ç†ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒè€Œä¸æ˜¯ç”¨æˆ·å¤´åƒ
                const avatarUrl = SafeGetValue(data, 'å¤´åƒé“¾æ¥', '');
                safeSetElement(`${characterName}-avatar`, avatarUrl, 'src');
                
                // ä¸ºè§’è‰²å¤´åƒæ·»åŠ é»˜è®¤å›¾ç‰‡é”™è¯¯å¤„ç†
                const avatarElement = document.getElementById(`${characterName}-avatar`);
                if (avatarElement) {
                    avatarElement.onerror = function() {
                        // è§’è‰²ä½¿ç”¨é»˜è®¤å¤´åƒï¼Œä¸ä½¿ç”¨ç”¨æˆ·å¤´åƒ
                        console.warn(`è§’è‰²${characterName}å¤´åƒåŠ è½½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å¤´åƒ`);
                    };
                }
                
                const favorabilityValue = safeProcessNumber(SafeGetValue(data, 'å¥½æ„Ÿåº¦', 0), `${characterName}-favorability-value`, `${characterName}å¥½æ„Ÿåº¦`);
                safeSetElement(`${characterName}-favorability-value`, favorabilityValue, 'text');
                
                const lustValue = safeProcessNumber(SafeGetValue(data, 'æ€§æ¬²å€¼', 0), `${characterName}-lust-value`, `${characterName}æ€§æ¬²å€¼`);
                safeSetElement(`${characterName}-lust-value`, lustValue, 'text');
                
                safeSetElement(`${characterName}-location-value`, SafeGetValue(data, 'ä½ç½®', '-'), 'text');
                safeSetElement(`${characterName}-attire-value`, SafeGetValue(data, 'è¡£ç€', '-'), 'text');
                safeSetElement(`${characterName}-behavior-value`, SafeGetValue(data, 'è¡Œä¸º', '-'), 'text');
                safeSetElement(`${characterName}-psychology-value`, SafeGetValue(data, 'å¿ƒç†æ´»åŠ¨', '-'), 'text');
            } catch (error) {
                console.error(`å¤„ç†è§’è‰²${characterName}æ•°æ®æ—¶å‡ºé”™:`, error);
                showUserFriendlyError('è§’è‰²æ•°æ®å¤„ç†é”™è¯¯', `å¤„ç†è§’è‰²${characterName}çš„æ•°æ®æ—¶å‡ºé”™: ${error.message}`, 'è¯·æ£€æŸ¥è§’è‰²æ•°æ®æ ¼å¼ï¼Œæˆ–å°è¯•é‡æ–°ç”ŸæˆçŠ¶æ€æ•°æ®ï¼ˆé‡rollï¼‰');
            }
        }

        function processCharacters(characters) {
            const tabsContainer = document.querySelector('.status-tabs');
            const contentContainer = document.querySelector('.collapsible-content');
            
            if (!tabsContainer) return;
            if (!contentContainer) return;

            const tabEditControls = tabsContainer.querySelector('.tab-edit-controls');
            // ä¿®å¤ï¼šæ‰¾åˆ°æ­£ç¡®çš„å‚è€ƒå…ƒç´ ï¼ˆcontentContainerçš„ç›´æ¥å­å…ƒç´ ï¼‰
            const activeContentPage = contentContainer.querySelector('.content-page.active');

            const existingTabs = new Set(Array.from(tabsContainer.querySelectorAll('.tab')).map(t => t.dataset.tab));
            
            for (const characterName in characters) {
                if (Object.prototype.hasOwnProperty.call(characters, characterName)) {
                    
                    // åŠ¨æ€åˆ›å»ºæ ‡ç­¾é¡µ (å¦‚æœä¸å­˜åœ¨)
                    if (!tabsContainer.querySelector(`[data-tab="${characterName}"]`)) {
                        const tab = document.createElement('div');
                        tab.className = 'tab';
                        tab.dataset.tab = characterName;
                        tab.innerText = characterName;
                        tabsContainer.insertBefore(tab, tabEditControls);
                    }

                    // åŠ¨æ€åˆ›å»ºå†…å®¹é¡µ (å¦‚æœä¸å­˜åœ¨)
                    if (!document.getElementById(`page-${characterName}`)) {
                        const page = document.createElement('div');
                        page.id = `page-${characterName}`;
                        page.className = 'content-page';
                        page.innerHTML = createCharacterPageHTML(characterName);
                        
                        // ä¿®å¤ï¼šåœ¨ activeContentPage åæ’å…¥æ–°é¡µé¢
                        if (activeContentPage && activeContentPage.nextElementSibling) {
                            // åœ¨ activeContentPage çš„ä¸‹ä¸€ä¸ªå…ƒç´ å‰æ’å…¥
                            contentContainer.insertBefore(page, activeContentPage.nextElementSibling);
                        } else if (activeContentPage) {
                            // å¦‚æœ activeContentPage æ˜¯æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåœ¨å®ƒåé¢æ’å…¥
                            contentContainer.insertBefore(page, activeContentPage.nextSibling);
                        } else {
                            // fallback: ç›´æ¥è¿½åŠ åˆ°æœ«å°¾
                            contentContainer.appendChild(page);
                        }
                    }

                    // æ›´æ–°æ•°æ®
                    applyCharacterData(characterName, characters[characterName]);
                }
            }
            

            
            // é‡æ–°åˆå§‹åŒ–Tabé€»è¾‘çš„è°ƒç”¨å°†ç§»è‡³ä¸»æµç¨‹ï¼Œç¡®ä¿åœ¨æ‰€æœ‰DOMæ“ä½œåæ‰§è¡Œ
        }

        // åˆ†æ‰¹å¤„ç†äººè„‰æ•°æ®ï¼Œé˜²æ­¢å¤§æ•°æ®å¡é¡¿
        function processRelationshipsInBatches(entries, container) {
            const batchSize = 5; // æ¯æ‰¹å¤„ç†5ä¸ª
            let currentBatch = 0;
            let itemCounter = 1;
            
            function processBatch() {
                const startIndex = currentBatch * batchSize;
                const endIndex = Math.min(startIndex + batchSize, entries.length);
                
                try {
                    for (let i = startIndex; i < endIndex; i++) {
                        const [name, data] = entries[i];
                        if (name === 'ç¤ºä¾‹NPC') continue;
                        
                        // ä½¿ç”¨å®½æ¾æ¨¡å¼å¤„ç†æ•°æ®
                        const relationshipHtml = createRelationshipItemHTML(name, data, itemCounter);
                        container.insertAdjacentHTML('beforeend', relationshipHtml);
                        itemCounter++;
                    }
                    
                    currentBatch++;
                    
                    // å¦‚æœè¿˜æœ‰æ•°æ®è¦å¤„ç†ï¼Œç»§ç»­ä¸‹ä¸€æ‰¹
                    if (currentBatch * batchSize < entries.length) {
                        setTimeout(processBatch, 50); // ç»™æµè§ˆå™¨å–˜æ¯æ—¶é—´
                    } else {
                        console.log(`äººè„‰æ•°æ®åˆ†æ‰¹å¤„ç†å®Œæˆï¼Œå…±å¤„ç†${itemCounter - 1}é¡¹`);
                    }
                } catch (error) {
                    console.error(`å¤„ç†ç¬¬${currentBatch}æ‰¹äººè„‰æ•°æ®æ—¶å‡ºé”™:`, error);
                    // è·³è¿‡è¿™æ‰¹ï¼Œç»§ç»­ä¸‹ä¸€æ‰¹
                    currentBatch++;
                    if (currentBatch * batchSize < entries.length) {
                        setTimeout(processBatch, 100);
                    }
                }
            }
            
            // æ˜¾ç¤ºåŠ è½½æç¤º
            container.innerHTML = '<p style="padding: 10px; text-align: center;">æ­£åœ¨åŠ è½½äººè„‰ä¿¡æ¯...</p>';
            
            // å¼€å§‹åˆ†æ‰¹å¤„ç†
            setTimeout(processBatch, 10);
        }

        // åˆ›å»ºäººé™…å…³ç³»æ¡ç›®HTML
        function createRelationshipItemHTML(name, data, itemCounter) {
            const description = SafeGetValueLoose(data, '', 'æš‚æ— æè¿°ä¿¡æ¯');
            return `
                <div class="relationship-item">
                    <div class="relationship-header">
                        <div class="name-part">
                            <span class="icon">
                                <svg viewBox="0 0 24 24">
                                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                </svg>
                            </span>
                            <span>${name}</span>
                        </div>
                        <div class="number-tag">${itemCounter}</div>
                    </div>
                    <div class="relationship-body">
                        <p>${description}</p>
                    </div>
                </div>
            `;
        }

        function applyRelationshipsData(relationshipsData) {
            const container = document.getElementById('relationships-list-container');
            if (!container) return;

            container.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹

            const entries = Object.entries(relationshipsData);
            if (entries.length === 0 || (entries.length === 1 && entries[0][0] === 'ç¤ºä¾‹NPC')) {
                container.innerHTML = '<p style="padding: 10px; text-align: center;">æš‚æ— äººè„‰ä¿¡æ¯ã€‚</p>';
                return;
            }

            // å¦‚æœäººè„‰æ•°æ®å¤ªå¤šï¼Œåˆ†æ‰¹å¤„ç†é¿å…å¡é¡¿
            if (entries.length > 20) {
                console.warn(`äººè„‰æ•°æ®è¾ƒå¤š(${entries.length}é¡¹)ï¼Œå¯ç”¨åˆ†æ‰¹å¤„ç†`);
                processRelationshipsInBatches(entries, container);
                return;
            }

            let itemCounter = 1;
            for (const [name, data] of entries) {
                if (name === 'ç¤ºä¾‹NPC') continue;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'relationship-item';

                // åˆ›å»ºå¤´éƒ¨
                const headerDiv = document.createElement('div');
                headerDiv.className = 'relationship-header';
                
                const namePart = document.createElement('div');
                namePart.className = 'name-part';
                const iconSpan = document.createElement('span');
                iconSpan.className = 'icon';
                iconSpan.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>';
                const nameSpan = document.createElement('span');
                nameSpan.innerText = name;
                namePart.appendChild(iconSpan);
                namePart.appendChild(nameSpan);

                const numberTag = document.createElement('span');
                numberTag.className = 'number-tag';
                numberTag.innerText = `#${itemCounter}`;
                
                headerDiv.appendChild(namePart);
                headerDiv.appendChild(numberTag);

                // åˆ›å»ºå†…å®¹ä½“
                const bodyDiv = document.createElement('div');
                bodyDiv.className = 'relationship-body';

                const dataString = Array.isArray(data) ? data[0] : String(data);
                const lines = dataString.split(/\\n|\n/);

                lines.forEach(line => {
                    if (line.trim() === '') return;
                    const match = line.match(/ã€(.+?)ã€‘(.*)/s); // 's' flag allows . to match newline characters
                    if (match && match.length === 3) {
                        const key = match[1];
                        const value = match[2].trim();

                        const p = document.createElement('p');
                        p.innerHTML = `<strong>${key}ï¼š</strong>${value}`;
                        bodyDiv.appendChild(p);
                    }
                });
                
                itemDiv.appendChild(headerDiv);
                itemDiv.appendChild(bodyDiv);
                container.appendChild(itemDiv);
                itemCounter++;
            }
        }

        function applyMapData(mapData) {
            const pinsContainer = document.getElementById('map-pins-container');
            if (!pinsContainer || !mapData) return;
            pinsContainer.innerHTML = ''; // æ¸…ç©ºæ—§å›¾é’‰

            const createPin = (name, type, top, left) => {
                const pin = document.createElement('div');
                pin.className = `map-pin ${type}`;
                pin.innerText = name;
                pin.style.top = top;
                pin.style.left = left;
                return pin;
            };

            // éå†æ‰€æœ‰é¡¶çº§é”®ï¼ˆåŸå¸‚åå’Œç‰¹æ®Šé”®ï¼‰
            for (const cityName in mapData) {
                if (cityName === 'å®¶') continue; // å•ç‹¬å¤„ç†"å®¶"
                const cityData = mapData[cityName];
                if (typeof cityData !== 'object' || cityData === null) continue;

                // åˆ›å»ºåŸå¸‚å›¾é’‰
                const cityCoordsValue = SafeGetValue(cityData, 'åæ ‡');
                if (cityCoordsValue && cityCoordsValue !== '-') {
                    const [top, left] = cityCoordsValue.split(',');
                    const cityPin = createPin(cityName.replace('å¸‚', ''), 'city', top, left);
                    cityPin.addEventListener('click', () => openCityModal(cityName, cityData));
                    pinsContainer.appendChild(cityPin);
                }

                // åˆ›å»ºè¯¥åŸå¸‚ä¸‹çš„åœ°ç‚¹å›¾é’‰
                for (const locationName in cityData) {
                    if (['æè¿°', 'åæ ‡', '$meta'].includes(locationName)) continue;
                    
                    const locationData = cityData[locationName];
                    if (typeof locationData !== 'object' || locationData === null) continue;

                    const locationCoordsValue = SafeGetValue(locationData, 'åæ ‡');
                    if (locationCoordsValue && locationCoordsValue !== '-') {
                        const [top, left] = locationCoordsValue.split(',');
                        const locationPin = createPin(locationName, 'location', top, left);
                        locationPin.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openLocationModal(locationName, locationData, cityName, cityData);
                        });
                        pinsContainer.appendChild(locationPin);
                    }
                }
            }

            // å•ç‹¬åˆ›å»º"å®¶"å›¾é’‰ï¼Œä½ç½®å›ºå®šåœ¨å³ä¸Šè§’
            const homeData = mapData['å®¶'];
            if (homeData) {
                const homePin = createPin('å›å®¶', 'home', '8%', '92%');
                homePin.addEventListener('click', () => {
                    const homeName = SafeGetValue(homeData, '0', 'å®¶');
                    const homeDescription = SafeGetValue(homeData, '1', 'ä½ çš„é¿é£æ¸¯ã€‚');
                    openLocationModal(homeName, { 'æè¿°': homeDescription }, 'å®¶');
                });
                pinsContainer.appendChild(homePin);
            }
        }

        function openCityModal(cityName, cityData) {
            const overlay = document.getElementById('city-modal-overlay');
            document.getElementById('city-modal-title').innerText = cityName;
            document.getElementById('city-modal-description').innerText = SafeGetValue(cityData, 'æè¿°', 'æš‚æ— æè¿°');
            
            const locationsContainer = document.getElementById('city-modal-locations');
            locationsContainer.innerHTML = '';

            for (const locationName in cityData) {
                if (['æè¿°', 'åæ ‡', '$meta'].includes(locationName)) continue;
                
                const locationData = cityData[locationName];
                const locationBtn = document.createElement('button');
                locationBtn.className = 'location-btn';
                locationBtn.innerText = locationName;
                locationBtn.addEventListener('click', () => {
                    openLocationModal(locationName, locationData, cityName, cityData);
                    overlay.style.display = 'none'; // å…³é—­å½“å‰åŸå¸‚å¼¹çª—
                });
                locationsContainer.appendChild(locationBtn);
            }
            
            overlay.style.display = 'flex';
        }

        function openLocationModal(locationName, locationData, cityName = null, cityData = null) {
            const overlay = document.getElementById('location-modal-overlay');
            document.getElementById('location-modal-title').innerText = locationName;

            // å¤„ç†è¿”å›æŒ‰é’®æ˜¾ç¤ºé€»è¾‘
            const backBtn = document.getElementById('location-modal-back-btn');
            if (cityName && cityName !== 'å®¶' && cityData) {
                backBtn.style.display = 'inline';
                // æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨å¹¶æ·»åŠ æ–°çš„
                const newBackBtn = backBtn.cloneNode(true);
                backBtn.parentNode.replaceChild(newBackBtn, backBtn);
                newBackBtn.addEventListener('click', () => {
                    overlay.style.display = 'none';
                    openCityModal(cityName, cityData);
                });
            } else {
                backBtn.style.display = 'none';
            }

            const detailsContainer = overlay.querySelector('.modal-details-grid');
            detailsContainer.innerHTML = '';

            const detailsToShow = ['æè¿°', 'çŠ¶æ€', 'å¯è§¦å‘äº‹ä»¶'];
            detailsToShow.forEach(key => {
                if (locationData[key] !== undefined) {
                    const item = document.createElement('div');
                    item.className = 'modal-detail-item';
                    
                    let value = SafeGetValue(locationData, key, '-');
                    
                    // ç‰¹æ®Šå¤„ç†å¯è§¦å‘äº‹ä»¶çš„æ¢è¡Œ
                    if (key === 'å¯è§¦å‘äº‹ä»¶' && Array.isArray(value)) {
                        value = value.filter(v => v && !v.includes('$__META_EXTENSIBLE__$')).join('\n') || '-';
                    }
                    
                    item.innerHTML = `<p><strong>ã€${key}ã€‘</strong></p><p>${value.replace(/\\n|\n/g, '<br>')}</p>`;
                    detailsContainer.appendChild(item);
                }
            });

            // ä¸ºç§»åŠ¨æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œä¼ é€’ä½ç½®ä¿¡æ¯
            const moveButton = overlay.querySelector('.modal-action-btn');
            if (moveButton) {
                // æ¸…é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨
                const newMoveButton = moveButton.cloneNode(true);
                moveButton.parentNode.replaceChild(newMoveButton, moveButton);
                
                newMoveButton.addEventListener('click', () => {
                    handleLocationMove(locationName, locationData, cityName);
                    overlay.style.display = 'none';
                });
            }

            overlay.style.display = 'flex';
        }

        function handleLocationMove(locationName, locationData, cityName) {
            try {
                // è·å–å½“å‰ç”¨æˆ·æ•°æ®
                if (typeof getChatMessages !== 'function' || typeof getCurrentMessageId !== 'function') {
                    // å¦‚æœåœ¨éSillyTavernç¯å¢ƒä¸­ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                    alert('ç§»åŠ¨åŠŸèƒ½ä»…åœ¨SillyTavernç¯å¢ƒä¸­å¯ç”¨');
                    return;
                }

                const messages = getChatMessages(getCurrentMessageId());
                if (!messages || messages.length === 0) {
                    console.error('æ— æ³•è·å–èŠå¤©æ¶ˆæ¯');
                    return;
                }

                const lastMessage = messages[messages.length - 1];
                const characterData = lastMessage?.data?.stat_data;
                
                if (!characterData || !characterData.ç”¨æˆ·) {
                    console.error('æ— æ³•è·å–ç”¨æˆ·æ•°æ®');
                    return;
                }

                // è·å–ç”¨æˆ·å
                const userName = SafeGetValue(characterData.ç”¨æˆ·, 'å§“å', 'ç”¨æˆ·');
                
                // ç¡®å®šç›®æ ‡åœ°ç‚¹åç§°
                let targetLocation = locationName;
                if (cityName && cityName !== 'å®¶' && locationName !== cityName) {
                    targetLocation = `${cityName}Â·${locationName}`;
                } else if (cityName === 'å®¶') {
                    targetLocation = 'å®¶';
                }

                // æ„å»ºæ¶ˆæ¯å†…å®¹
                let messageContent = `${userName}é€‰æ‹©ç§»åŠ¨è‡ªå·±çš„ä½ç½®åˆ°${targetLocation}`;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å¯è§¦å‘äº‹ä»¶
                const events = SafeGetValue(locationData, 'å¯è§¦å‘äº‹ä»¶');
                if (events && events !== '-' && Array.isArray(events)) {
                    const filteredEvents = events.filter(event => 
                        event && 
                        typeof event === 'string' && 
                        event.trim() !== '' && 
                        !event.includes('$__META_EXTENSIBLE__$') &&
                        !event.includes('æš‚æ— ')
                    );
                    
                    if (filteredEvents.length > 0) {
                        const eventsText = filteredEvents.join('ï¼›');
                        messageContent += `ï¼Œå½“å‰åœ°ç‚¹çš„å¯è§¦å‘äº‹ä»¶ä¸º${eventsText}`;
                    }
                } else if (events && events !== '-' && typeof events === 'string' && 
                          !events.includes('æš‚æ— ') && events.trim() !== '') {
                    messageContent += `ï¼Œå½“å‰åœ°ç‚¹çš„å¯è§¦å‘äº‹ä»¶ä¸º${events}`;
                }

                messageContent += 'ï¼Œè¯·ç”Ÿæˆå‰§æƒ…ï¼Œç§»åŠ¨ä½ç½®éœ€é‡‡å–åˆç†çš„äº¤é€šæ–¹å¼ï¼ŒèŠ±è´¹åˆç†çš„æ—¶é—´å’Œé‡‘é’±ï¼Œè®°å¾—æ›´æ–°ç›¸å…³å˜é‡ã€‚';

                // å‘é€æ¶ˆæ¯
                sendMessageToTavern(messageContent);

            } catch (error) {
                console.error('å¤„ç†ç§»åŠ¨è¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯:', error);
                alert('ç§»åŠ¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°é”™è¯¯ä¿¡æ¯');
            }
        }

        function sendMessageToTavern(messageContent) {
            try {
                // æ–¹æ³•1: å°è¯•ä½¿ç”¨çˆ¶çª—å£çš„è¾“å…¥æ¡†ï¼ˆæ¨èæ–¹å¼ï¼‰
                if (window.parent && window.parent.document) {
                    const textarea = window.parent.document.querySelector('#send_textarea');
                    const sendButton = window.parent.document.querySelector('#send_but');
                    
                    if (textarea && sendButton) {
                        textarea.value = messageContent;
                        sendButton.click();
                        console.log('æ¶ˆæ¯å·²å‘é€:', messageContent);
                        return;
                    }
                }

                // æ–¹æ³•2: å°è¯•ä½¿ç”¨TavernHelper API
                if (window.parent && window.parent.TavernHelper && window.parent.TavernHelper.createChatMessages) {
                    window.parent.TavernHelper.createChatMessages([{
                        role: 'user',
                        message: messageContent
                    }]).then(() => {
                        console.log('æ¶ˆæ¯å·²é€šè¿‡TavernHelperå‘é€:', messageContent);
                    }).catch(error => {
                        console.error('TavernHelperå‘é€å¤±è´¥:', error);
                        fallbackSendMessage(messageContent);
                    });
                    return;
                }

                // æ–¹æ³•3: å¤‡ç”¨æ–¹æ³•
                fallbackSendMessage(messageContent);

            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯:', error);
                fallbackSendMessage(messageContent);
            }
        }

        function fallbackSendMessage(messageContent) {
            // å¤‡ç”¨æ–¹æ³•ï¼šå°è¯•ç›´æ¥æ“ä½œDOM
            try {
                const textarea = document.querySelector('#send_textarea') || 
                               window.parent?.document?.querySelector('#send_textarea');
                const sendButton = document.querySelector('#send_but') || 
                                 window.parent?.document?.querySelector('#send_but');

                if (textarea && sendButton) {
                    textarea.value = messageContent;
                    sendButton.click();
                    console.log('æ¶ˆæ¯å·²é€šè¿‡å¤‡ç”¨æ–¹æ³•å‘é€:', messageContent);
                } else {
                    // æœ€ç»ˆå¤‡ç”¨æ–¹æ¡ˆï¼šå°†æ¶ˆæ¯å¤åˆ¶åˆ°å‰ªè´´æ¿
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(messageContent).then(() => {
                            alert('æ— æ³•è‡ªåŠ¨å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´å‘é€ï¼š\n\n' + messageContent);
                        }).catch(() => {
                            alert('æ— æ³•è‡ªåŠ¨å‘é€æ¶ˆæ¯ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š\n\n' + messageContent);
                        });
                    } else {
                        alert('æ— æ³•è‡ªåŠ¨å‘é€æ¶ˆæ¯ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š\n\n' + messageContent);
                    }
                }
            } catch (error) {
                console.error('å¤‡ç”¨å‘é€æ–¹æ³•ä¹Ÿå¤±è´¥:', error);
                alert('æ— æ³•è‡ªåŠ¨å‘é€æ¶ˆæ¯ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ä»¥ä¸‹å†…å®¹ï¼š\n\n' + messageContent);
            }
        }

        function setupMapModals() {
            const cityOverlay = document.getElementById('city-modal-overlay');
            const locationOverlay = document.getElementById('location-modal-overlay');

            [cityOverlay, locationOverlay].forEach(overlay => {
                if (!overlay) return;
                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.style.display = 'none';
                    }
                });
                // ç‚¹å‡»å…³é—­æŒ‰é’®
                const closeBtn = overlay.querySelector('.modal-close-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        overlay.style.display = 'none';
                    });
                }
            });
        }

        function setupCollapse() {
            const collapseBtn = document.getElementById('collapse-toggle-btn');
            const container = document.getElementById('status-main');

            if (collapseBtn && container) {
                collapseBtn.addEventListener('click', () => {
                    container.classList.toggle('collapsed');
                });
            }
        }

        function setupRelationshipSearch() {
            const searchIcon = document.getElementById('relationship-search-icon');
            const searchInput = document.getElementById('relationship-search-input');
            const listContainer = document.getElementById('relationships-list-container');

            if (!searchIcon || !searchInput || !listContainer) return;

            searchIcon.addEventListener('click', () => {
                searchInput.classList.toggle('visible');
                if (searchInput.classList.contains('visible')) {
                    searchInput.focus();
                }
            });

            searchInput.addEventListener('input', () => {
                const searchTerm = searchInput.value.toLowerCase();
                const items = listContainer.querySelectorAll('.relationship-item');
                
                items.forEach(item => {
                    const itemText = item.innerText.toLowerCase();
                    if (itemText.includes(searchTerm)) {
                        item.style.display = 'flex';
                } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        function setupTabs(initialActiveTabId = null) {
            const tabsContainer = document.querySelector('.status-tabs');
            const pagesContainer = document.querySelector('.collapsible-content');
            const navArrows = document.querySelectorAll('.bottom-nav .icon');
            let currentActiveTab = null;

            function getVisibleTabs() {
                return Array.from(tabsContainer.querySelectorAll('.tab'));
            }

            function showPage(targetTab) {
                if (!targetTab) return;

                const allTabs = getVisibleTabs();
                const allPages = pagesContainer.querySelectorAll('.content-page');
                
                // Deactivate all
                allTabs.forEach(t => t.classList.remove('active'));
                allPages.forEach(p => p.classList.remove('active'));

                // Activate target tab
                targetTab.classList.add('active');
                currentActiveTab = targetTab;

                // Activate corresponding page by ID
                const targetPageId = 'page-' + targetTab.dataset.tab;
                const targetPage = document.getElementById(targetPageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                }
            }

            const allTabs = getVisibleTabs();
            allTabs.forEach(tab => {
                // ç§»é™¤æ—§ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
                const newTab = tab.cloneNode(true);
                tab.parentNode.replaceChild(newTab, tab);
                newTab.addEventListener('click', function() {
                    showPage(this);
                });
            });
            
            navArrows[0].addEventListener('click', () => { // Previous
                const visibleTabs = getVisibleTabs();
                let currentIndex = visibleTabs.findIndex(t => t === currentActiveTab);
                if (currentIndex === -1) currentIndex = 0;
                const newIndex = (currentIndex - 1 + visibleTabs.length) % visibleTabs.length;
                showPage(visibleTabs[newIndex]);
            });

            navArrows[1].addEventListener('click', () => { // Next
                const visibleTabs = getVisibleTabs();
                let currentIndex = visibleTabs.findIndex(t => t === currentActiveTab);
                if (currentIndex === -1) currentIndex = 0;
                const newIndex = (currentIndex + 1) % visibleTabs.length;
                showPage(visibleTabs[newIndex]);
            });

            // Set initial page
            let activeTabId = initialActiveTabId || tabsContainer.querySelector('.tab.active')?.dataset.tab;
            let initialTab = activeTabId ? tabsContainer.querySelector(`.tab[data-tab="${activeTabId}"]`) : null;
            
            if (!initialTab) {
                initialTab = tabsContainer.querySelector('.tab');
            }
            showPage(initialTab);
        }

        function setupSortableTabs() {
            const editBtn = document.getElementById('edit-order-btn');
            const saveBtn = document.getElementById('save-order-btn');
            const tabsContainer = document.querySelector('.status-tabs');
            const contentContainer = document.querySelector('.collapsible-content');
            let draggedItem = null;
            let longPressTimer;
            let isDragging = false;
            let touchStartX = 0;
            let touchStartY = 0;
            let isLongPressing = false;
            let autoScrollInterval = null;

            function loadOrderAndApply() {
                try {
                    const savedOrderJSON = localStorage.getItem('tabOrder');
                    if (!savedOrderJSON) return;

                    const savedOrder = JSON.parse(savedOrderJSON);
                    const pageMap = new Map(Array.from(contentContainer.querySelectorAll('.content-page')).map(p => [p.id.replace('page-', ''), p]));
                    const tabMap = new Map(Array.from(tabsContainer.querySelectorAll('.tab')).map(t => [t.dataset.tab, t]));

                    savedOrder.forEach(tabKey => {
                        if (tabMap.has(tabKey)) tabsContainer.appendChild(tabMap.get(tabKey));
                        if (pageMap.has(tabKey)) contentContainer.appendChild(pageMap.get(tabKey));
                    });

                    // Ensure controls and nav are at the end
                    tabsContainer.appendChild(tabsContainer.querySelector('.tab-edit-controls'));
                    contentContainer.appendChild(contentContainer.querySelector('.bottom-nav'));
                } catch (e) {
                    console.error('Failed to apply saved tab order:', e);
                    localStorage.removeItem('tabOrder');
                }
            }

            function saveCurrentOrder() {
                const currentTabs = tabsContainer.querySelectorAll('.tab');
                const order = Array.from(currentTabs).map(tab => tab.dataset.tab);
                localStorage.setItem('tabOrder', JSON.stringify(order));
            }
            
            function enableEditMode() {
                tabsContainer.classList.add('edit-mode');
                editBtn.style.display = 'none';
                saveBtn.style.display = 'block';
                
                tabsContainer.querySelectorAll('.tab').forEach(tab => {
                    tab.draggable = true;
                    // Desktop
                    tab.addEventListener('dragstart', handleDragStart);
                    tab.addEventListener('dragend', handleDragEnd);
                    // Mobile
                    tab.addEventListener('touchstart', handleTouchStart, { passive: false });
                    tab.addEventListener('touchend', handleTouchEnd);
                    tab.addEventListener('touchmove', handleTouchMove, { passive: false });
                    tab.addEventListener('contextmenu', e => e.preventDefault());
                });
                
                tabsContainer.addEventListener('dragover', handleDragOver);
            }
            
            function disableEditMode() {
                tabsContainer.classList.remove('edit-mode');
                editBtn.style.display = 'block';
                saveBtn.style.display = 'none';
                
                // æ¸…ç†æ‰€æœ‰çŠ¶æ€
                isDragging = false;
                isLongPressing = false;
                draggedItem = null;
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
                if (autoScrollInterval) {
                    clearInterval(autoScrollInterval);
                    autoScrollInterval = null;
                }
                
                tabsContainer.querySelectorAll('.tab').forEach(tab => {
                    tab.draggable = false;
                    // æ¸…ç†æ‰€æœ‰æ ·å¼çŠ¶æ€
                    tab.classList.remove('dragging', 'long-pressing');
                    tab.style.transform = '';
                    tab.style.zIndex = '';
                    tab.style.boxShadow = '';
                    // Desktop
                    tab.removeEventListener('dragstart', handleDragStart);
                    tab.removeEventListener('dragend', handleDragEnd);
                    // Mobile
                    tab.removeEventListener('touchstart', handleTouchStart);
                    tab.removeEventListener('touchend', handleTouchEnd);
                    tab.removeEventListener('touchmove', handleTouchMove);
                    tab.removeEventListener('contextmenu', e => e.preventDefault());
                });
                
                tabsContainer.removeEventListener('dragover', handleDragOver);
            }

            function handleDragStart(e) {
                draggedItem = this;
                setTimeout(() => this.classList.add('dragging'), 0);
            }

            function handleDragEnd() {
                if (this) {
                this.classList.remove('dragging');
                    this.style.transform = '';
                    this.style.zIndex = '';
                    this.style.boxShadow = '';
                }
                draggedItem = null;
            }

            function handleDragOver(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(tabsContainer, e.clientX);
                if (!draggedItem) return;
                const draggedPage = document.getElementById('page-' + draggedItem.dataset.tab);
                
                if (afterElement == null) {
                    tabsContainer.insertBefore(draggedItem, tabsContainer.querySelector('.tab-edit-controls'));
                    if (draggedPage) contentContainer.insertBefore(draggedPage, contentContainer.querySelector('.bottom-nav'));
                } else {
                    tabsContainer.insertBefore(draggedItem, afterElement);
                    const afterPage = document.getElementById('page-' + afterElement.dataset.tab);
                    if (draggedPage && afterPage) contentContainer.insertBefore(draggedPage, afterPage);
                }
            }

            // --- Touch event handlers for mobile drag ---
            function handleTouchStart(e) {
                if (e.touches.length > 1) return;
                
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                draggedItem = this;
                isLongPressing = false;
                isDragging = false;
                
                // æ›´çŸ­çš„é•¿æŒ‰æ—¶é—´ï¼Œæ›´æ•æ„Ÿ
                longPressTimer = setTimeout(() => {
                    isLongPressing = true;
                    if (draggedItem) {
                        draggedItem.classList.add('long-pressing');
                        // è§¦è§‰åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }
                        // å†ç­‰ä¸€å°æ®µæ—¶é—´å¼€å§‹æ‹–æ‹½
                        setTimeout(() => {
                            if (isLongPressing && draggedItem) {
                                isDragging = true;
                                draggedItem.classList.remove('long-pressing');
                                draggedItem.classList.add('dragging');
                            }
                        }, 100);
                    }
                }, 300); // ç¼©çŸ­åˆ°300ms
            }

            function handleTouchMove(e) {
                if (!draggedItem) return;
                
                const touch = e.touches[0];
                const moveX = Math.abs(touch.clientX - touchStartX);
                const moveY = Math.abs(touch.clientY - touchStartY);
                
                // å¦‚æœç§»åŠ¨è·ç¦»å¤ªå¤§ï¼Œå–æ¶ˆé•¿æŒ‰
                if (!isDragging && (moveX > 10 || moveY > 10)) {
                    clearTimeout(longPressTimer);
                    if (draggedItem) {
                        draggedItem.classList.remove('long-pressing');
                    }
                    isLongPressing = false;
                    draggedItem = null;
                    return;
                }
                
                if (!isDragging) return;
                
                e.preventDefault(); // Prevent scrolling while dragging
                
                // å¤„ç†è‡ªåŠ¨æ»šåŠ¨
                handleAutoScroll(touch.clientX);
                
                const afterElement = getDragAfterElement(tabsContainer, touch.clientX);
                if (!draggedItem) return;
                const draggedPage = document.getElementById('page-' + draggedItem.dataset.tab);

                if (afterElement == null) {
                    tabsContainer.insertBefore(draggedItem, tabsContainer.querySelector('.tab-edit-controls'));
                    if (draggedPage) contentContainer.insertBefore(draggedPage, contentContainer.querySelector('.bottom-nav'));
                } else {
                    tabsContainer.insertBefore(draggedItem, afterElement);
                    const afterPage = document.getElementById('page-' + afterElement.dataset.tab);
                    if (draggedPage && afterPage) contentContainer.insertBefore(draggedPage, afterPage);
                }
            }

            function handleTouchEnd() {
                clearTimeout(longPressTimer);
                
                // æ¸…ç†è‡ªåŠ¨æ»šåŠ¨
                if (autoScrollInterval) {
                    clearInterval(autoScrollInterval);
                    autoScrollInterval = null;
                }
                
                if (isDragging && draggedItem) {
                    draggedItem.classList.remove('dragging');
                    draggedItem.style.transform = '';
                    draggedItem.style.zIndex = '';
                    draggedItem.style.boxShadow = '';
                }
                
                if (isLongPressing && draggedItem) {
                    draggedItem.classList.remove('long-pressing');
                }
                
                isDragging = false;
                isLongPressing = false;
                draggedItem = null;
            }

            function handleAutoScroll(clientX) {
                const rect = tabsContainer.getBoundingClientRect();
                const scrollLeft = tabsContainer.scrollLeft;
                const scrollWidth = tabsContainer.scrollWidth;
                const containerWidth = rect.width;
                
                // æ¸…é™¤ä¹‹å‰çš„æ»šåŠ¨
                if (autoScrollInterval) {
                    clearInterval(autoScrollInterval);
                    autoScrollInterval = null;
                }
                
                const edgeThreshold = 60; // è¾¹ç¼˜è§¦å‘åŒºåŸŸ
                const scrollSpeed = 3; // æ»šåŠ¨é€Ÿåº¦
                
                // æ£€æŸ¥æ˜¯å¦åœ¨å·¦è¾¹ç¼˜
                if (clientX - rect.left < edgeThreshold && scrollLeft > 0) {
                    autoScrollInterval = setInterval(() => {
                        const newScrollLeft = Math.max(0, tabsContainer.scrollLeft - scrollSpeed);
                        tabsContainer.scrollLeft = newScrollLeft;
                        if (newScrollLeft === 0) {
                            clearInterval(autoScrollInterval);
                            autoScrollInterval = null;
                        }
                    }, 16); // 60fps
                }
                // æ£€æŸ¥æ˜¯å¦åœ¨å³è¾¹ç¼˜
                else if (clientX - rect.left > containerWidth - edgeThreshold && 
                         scrollLeft + containerWidth < scrollWidth) {
                    autoScrollInterval = setInterval(() => {
                        const maxScrollLeft = scrollWidth - containerWidth;
                        const newScrollLeft = Math.min(maxScrollLeft, tabsContainer.scrollLeft + scrollSpeed);
                        tabsContainer.scrollLeft = newScrollLeft;
                        if (newScrollLeft === maxScrollLeft) {
                            clearInterval(autoScrollInterval);
                            autoScrollInterval = null;
                        }
                    }, 16); // 60fps
                }
            }

            function getDragAfterElement(container, x) {
                const draggableElements = [...container.querySelectorAll('.tab:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = x - box.left - box.width / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            editBtn.addEventListener('click', enableEditMode);
            saveBtn.addEventListener('click', () => {
                const activeTabBeforeSave = tabsContainer.querySelector('.tab.active')?.dataset.tab;
                disableEditMode();
                saveCurrentOrder();
                setupTabs(activeTabBeforeSave);
            });

            loadOrderAndApply();
        }

        function setupTabVisibility() {
            const visibilityBtn = document.getElementById('visibility-btn');
            const modalOverlay = document.getElementById('visibility-modal-overlay');
            const modalBody = document.getElementById('visibility-modal-body');
            const closeBtn = modalOverlay.querySelector('.modal-close-btn');
            const tabsContainer = document.querySelector('.status-tabs');
            const STORAGE_KEY = 'tabVisibility';

            function getTabConfig() {
                try {
                    const stored = localStorage.getItem(STORAGE_KEY);
                    return stored ? JSON.parse(stored) : {};
                } catch (e) {
                    console.error('Failed to parse tab visibility settings:', e);
                    return {};
                }
            }

            function saveTabConfig(config) {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
            }

            function applyVisibility() {
                const config = getTabConfig();
                const allTabs = Array.from(tabsContainer.querySelectorAll('.tab'));
                let firstVisibleTab = null;
                let activeTabIsVisible = false;

                allTabs.forEach(tab => {
                    const tabKey = tab.dataset.tab;
                    // Default to visible if not in config
                    const shouldBeVisible = config[tabKey] !== false; 
                    
                    tab.style.display = shouldBeVisible ? '' : 'none';

                    if (shouldBeVisible && !firstVisibleTab) {
                        firstVisibleTab = tab;
                    }
                    if (tab.classList.contains('active') && shouldBeVisible) {
                        activeTabIsVisible = true;
                    }
                });

                // If currently active tab is now hidden, switch to the first visible one
                if (!activeTabIsVisible && firstVisibleTab) {
                    // This will be handled by setupTabs, we just need to remove active class
                    const currentActive = tabsContainer.querySelector('.tab.active');
                    if(currentActive) currentActive.classList.remove('active');
                    firstVisibleTab.classList.add('active');
                    setupTabs(firstVisibleTab.dataset.tab);
                }
            }

            function populateModal() {
                modalBody.innerHTML = '';
                const config = getTabConfig();
                const allTabs = Array.from(tabsContainer.querySelectorAll('.tab'));

                allTabs.forEach(tab => {
                    const tabKey = tab.dataset.tab;
                    const tabName = tab.innerText;
                    const isVisible = config[tabKey] !== false;

                    const item = document.createElement('div');
                    item.className = 'visibility-toggle-item';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = isVisible;
                    checkbox.id = `vis-check-${tabKey}`;
                    checkbox.dataset.tab = tabKey;

                    const label = document.createElement('label');
                    label.htmlFor = `vis-check-${tabKey}`;
                    label.textContent = tabName;

                    item.appendChild(checkbox);
                    item.appendChild(label);
                    modalBody.appendChild(item);

                    checkbox.addEventListener('change', (e) => {
                        const currentConfig = getTabConfig();
                        currentConfig[e.target.dataset.tab] = e.target.checked;
                        saveTabConfig(currentConfig);
                        applyVisibility();
                    });
                });
            }

            visibilityBtn.addEventListener('click', () => {
                populateModal();
                modalOverlay.style.display = 'flex';
            });
            
            closeBtn.addEventListener('click', () => modalOverlay.style.display = 'none');
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.style.display = 'none';
                }
            });

            // Initial application
            applyVisibility();
        }

        // [äº‹ä»¶ç›‘å¬]
        // ç§»é™¤ DOMContentLoaded äº‹ä»¶ç›‘å¬å™¨ï¼Œç›´æ¥è°ƒç”¨å‡½æ•°
        // è¿™æ ·å¯ä»¥ç¡®ä¿åœ¨é€šè¿‡ jQuery.load() åŠ¨æ€åŠ è½½æ—¶è„šæœ¬ä¹Ÿèƒ½æ­£ç¡®æ‰§è¡Œ
        
        // ä½¿ç”¨å—ä¿æŠ¤çš„åˆå§‹åŒ–ï¼Œé˜²æ­¢å„ç§é—®é¢˜
        protectedInitDisplay();
        
        // å…¶ä»–åŠŸèƒ½çš„åˆå§‹åŒ–ï¼ˆè¿™äº›ç›¸å¯¹å®‰å…¨ï¼‰
        try {
        setupSortableTabs();
        setupCollapse();
        setupTabs();
        setupRelationshipSearch();
        setupMapModals();
        setupTabVisibility();
            console.log('æ‰€æœ‰åŠŸèƒ½åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
            console.error('åŠŸèƒ½åˆå§‹åŒ–éƒ¨åˆ†å¤±è´¥:', error);
            // å³ä½¿éƒ¨åˆ†åŠŸèƒ½å¤±è´¥ï¼Œä¹Ÿç¡®ä¿åŸºæœ¬çš„æŠ˜å åŠŸèƒ½å¯ç”¨
            try {
                setupCollapse();
            } catch (e) {
                console.error('è¿æŠ˜å åŠŸèƒ½éƒ½åˆå§‹åŒ–å¤±è´¥:', e);
            }
        }
        
        // å¦‚æœåœ¨SillyTavernç¯å¢ƒä¸­ï¼Œè¿˜å¯ä»¥ç›‘å¬æ¶ˆæ¯å˜åŒ–äº‹ä»¶æ¥æ›´æ–°çŠ¶æ€
        // document.addEventListener('message-rendered', initDisplay);

</script>
</body>
</html>
```